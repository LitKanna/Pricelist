<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Everfresh Price List Editor</title>
    
    <!-- Premium Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- JSZip for XPS file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
    /* Premium Fresh Design System */
    :root {
        --green-50: #f0fdf4;
        --green-100: #dcfce7;
        --green-500: #22c55e;
        --green-600: #16a34a;
        --green-700: #15803d;
        --slate-50: #f8fafc;
        --slate-100: #f1f5f9;
        --slate-200: #e2e8f0;
        --slate-700: #334155;
        --slate-800: #1e293b;
        --slate-900: #0f172a;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
        background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
        color: var(--slate-900);
        line-height: 1.5;
    }

    /* Prevent background scroll when modal is open */
    body.modal-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
    }
    
    /* Beautiful Header - Enhanced */
    .header {
        background: linear-gradient(135deg, #15803d 0%, #16a34a 50%, #22c55e 100%);
        padding: 0;
        text-align: center;
        box-shadow: 0 8px 32px rgba(34, 197, 94, 0.15);
        position: relative;
        overflow: hidden;
    }

    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="40" fill="rgba(255,255,255,0.03)"/></svg>');
        opacity: 0.4;
    }

    .header-content {
        position: relative;
        z-index: 1;
        padding: 40px 24px 32px;
    }

    .header-logo {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 64px;
        height: 64px;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        margin-bottom: 16px;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }

    .header-logo svg {
        width: 36px;
        height: 36px;
        color: white;
    }

    .header h1 {
        color: white;
        font-size: 32px;
        font-weight: 800;
        margin-bottom: 8px;
        letter-spacing: -1.5px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header p {
        color: rgba(255, 255, 255, 0.95);
        font-size: 16px;
        font-weight: 500;
        letter-spacing: 0.2px;
    }
    
    /* Modern Controls - Enhanced Tab Style */
    .controls-wrapper {
        background: white;
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .controls {
        position: relative;
        z-index: 100;
        padding: 16px 20px;
        background: white;
        display: flex;
        gap: 12px;
        border-bottom: 1px solid #f1f5f9;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        flex-wrap: wrap;
    }

    .share-controls {
        padding: 12px 20px;
        background: #f8fafc;
        display: flex;
        gap: 10px;
        border-bottom: 1px solid #e2e8f0;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .controls::-webkit-scrollbar,
    .share-controls::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for all browsers */
    .controls,
    .share-controls {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Butter smooth scroll for tier picker */
    #customerTiersList {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    #customerTiersList::-webkit-scrollbar {
        display: none;
    }

    /* Hide main page scrollbar on mobile */
    @media (max-width: 480px) {
        html, body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        html::-webkit-scrollbar,
        body::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }
    }

    .btn-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .btn-divider {
        width: 1px;
        height: 24px;
        background: #e2e8f0;
        margin: 0 4px;
    }

    /* Enhanced Buttons - Modern Design System */
    .btn {
        padding: 10px 18px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .btn-success {
        background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
        color: white;
        box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3);
    }

    .btn-success:hover {
        box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .btn-success:active {
        transform: scale(0.96);
    }

    .btn-primary {
        background: #0f172a;
        color: white;
    }

    .btn-primary:hover {
        background: #1e293b;
    }

    .new-order-btn {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        background: #0f172a;
        color: #f8fafc;
        border: none;
        border-radius: 50px;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.02em;
        cursor: pointer;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.08);
    }

    .new-order-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        background: #1e293b;
    }

    .new-order-btn:active {
        transform: translateY(0) scale(0.98);
    }

    .order-icon-wrap {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 26px;
        height: 26px;
    }

    .order-icon-wrap svg {
        width: 22px;
        height: 22px;
    }

    .btn-secondary {
        background: white;
        color: #475569;
        border: 1.5px solid #e2e8f0;
        box-shadow: none;
    }

    .btn-secondary:hover {
        background: #f8fafc;
        border-color: #cbd5e1;
    }

    .btn-danger {
        background: #fef2f2;
        color: #ef4444;
        border: 1.5px solid #fee2e2;
    }

    .btn-danger:hover {
        background: #fee2e2;
    }

    .btn-share {
        background: white;
        color: var(--green-600);
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 600;
        flex: 1;
        justify-content: center;
        border: 1.5px solid var(--green-200);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .btn-share:hover {
        background: var(--green-50);
        border-color: var(--green-300);
    }

    .btn-small {
        padding: 6px 12px;
        font-size: 12px;
    }

    /* Modern Dropdown Menu System */
    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .dropdown-toggle .chevron {
        width: 14px;
        height: 14px;
        transition: transform 0.2s ease;
    }

    .dropdown.active .chevron {
        transform: rotate(180deg);
    }

    .dropdown-menu {
        position: fixed;
        background: white;
        border-radius: 12px;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.05);
        min-width: 200px;
        padding: 6px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 9999;
    }

    .dropdown.active .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #334155;
        cursor: pointer;
        transition: all 0.15s ease;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
    }

    .dropdown-item:hover {
        background: #f1f5f9;
        color: #0f172a;
    }

    .dropdown-item svg {
        width: 18px;
        height: 18px;
        opacity: 0.7;
    }

    .dropdown-divider {
        height: 1px;
        background: #e2e8f0;
        margin: 6px 0;
    }
    
    /* Content Area */
    .content {
        padding: 24px 20px;
        background: var(--slate-50);
    }
    
    /* Category Cards - Clean & Modern */
    .category {
        background: white;
        border-radius: 16px;
        margin-bottom: 16px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }
    
    .category-header {
        background: white;
        padding: 16px 20px;
        color: #0f172a;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .category-title {
        font-size: 15px;
        font-weight: 600;
        letter-spacing: -0.2px;
        color: #64748b;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
        flex: 1;
    }
    
    .category-actions {
        display: flex;
        gap: 8px;
    }
    
    .icon-btn {
        background: transparent;
        border: none;
        color: #94a3b8;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        transition: all 0.15s;
    }
    
    .icon-btn:hover {
        background: #f8fafc;
        color: #ef4444;
    }

    .icon-btn.category-edit-btn:hover {
        color: #3b82f6;
    }

    .icon-btn:active {
        transform: scale(0.95);
    }
    
    /* Modern Product Cards - Notion/Linear Style */
    .product {
        padding: 0;
        border: none;
        margin: 0;
        background: white;
        position: relative;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .product:last-child {
        border-bottom: none;
    }
    
    .product:hover {
        background: #fafafa;
    }
    
    .product-grid {
        display: grid;
        grid-template-columns: 2fr 1.5fr 1fr 32px;
        gap: 16px;
        padding: 12px 16px;
        align-items: center;
    }
    
    .product-field {
        position: relative;
        min-height: 32px;
        display: flex;
        align-items: center;
    }
    
    .product-label {
        display: none;
    }
    
    .input-field {
        width: 100%;
        padding: 6px 8px;
        border: none;
        background: transparent;
        font-size: 14px;
        font-weight: 500;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        color: #0f172a;
        border-radius: 6px;
        transition: background 0.15s;
    }
    
    .input-field:hover {
        background: #f8fafc;
    }
    
    .input-field:focus {
        outline: none;
        background: #f1f5f9;
    }
    
    .input-field::placeholder {
        color: #cbd5e1;
        font-weight: 400;
    }
    
    /* Price field */
    .product-field:nth-child(3) .input-field {
        font-weight: 600;
        color: #059669;
    }
    
    /* Delete Button - Minimal */
    .product-delete {
        width: 32px;
        height: 32px;
        background: transparent;
        color: #cbd5e1;
        border: none;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.15s;
        opacity: 0;
    }
    
    .product:hover .product-delete {
        opacity: 1;
    }
    
    .product-delete:hover {
        background: #fef2f2;
        color: #ef4444;
    }
    
    .product-delete:active {
        transform: scale(0.9);
    }
    
    /* Drag and Drop Styles */
    .drag-handle {
        width: 24px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: grab;
        color: #cbd5e1;
        opacity: 0;
        transition: all 0.15s;
        flex-shrink: 0;
    }
    
    .drag-handle:active {
        cursor: grabbing;
    }
    
    .product:hover .drag-handle,
    .category-header:hover .drag-handle {
        opacity: 1;
    }
    
    .drag-handle:hover {
        color: #94a3b8;
    }
    
    .drag-handle svg {
        width: 16px;
        height: 16px;
    }
    
    /* Category drag handle */
    .category-drag-handle {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: grab;
        color: #94a3b8;
        opacity: 0;
        transition: all 0.15s;
        border-radius: 6px;
    }
    
    .category-drag-handle:active {
        cursor: grabbing;
    }
    
    .category-header:hover .category-drag-handle {
        opacity: 1;
    }
    
    .category-drag-handle:hover {
        background: #f1f5f9;
        color: #64748b;
    }
    
    /* Dragging states */
    .dragging {
        opacity: 0.5;
        transform: scale(0.98);
    }
    
    .drag-over {
        border-top: 3px solid #22c55e !important;
    }
    
    .category.drag-over {
        box-shadow: 0 -3px 0 0 #22c55e;
    }
    
    .product.drag-over {
        background: #f0fdf4;
    }
    
    /* Hide drag handles when auto-sort is enabled */
    .auto-sort-enabled .drag-handle,
    .auto-sort-enabled .category-drag-handle {
        display: none !important;
    }
    
    /* Adjust product grid for drag handle + cost column */
    .product-grid-with-drag {
        display: grid;
        grid-template-columns: 24px 2fr 1.2fr 0.8fr 0.8fr 32px;
        gap: 10px;
        padding: 12px 16px;
        align-items: center;
    }
    
    .table-header-with-drag {
        display: grid;
        grid-template-columns: 24px 2fr 1.2fr 0.8fr 0.8fr 32px;
        gap: 10px;
        padding: 8px 16px;
        background: #fafafa;
        border-bottom: 1px solid #f1f5f9;
    }
    
    /* When auto-sort is on, hide drag column */
    .auto-sort-enabled .product-grid-with-drag {
        grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 32px;
    }
    
    .auto-sort-enabled .table-header-with-drag {
        grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 32px;
    }
    
    /* Hide the drag handle column space when auto-sort is enabled */
    .auto-sort-enabled .table-header-with-drag > .table-header-cell:first-child,
    .auto-sort-enabled .product-grid-with-drag > .drag-handle {
        display: none;
    }
    
    /* Mobile responsive - iPhone and small screens */
    @media (max-width: 480px) {
        .product-grid-with-drag {
            grid-template-columns: 20px 1.5fr 1fr 0.7fr 0.7fr 28px;
            gap: 6px;
            padding: 10px 10px;
        }
        
        .table-header-with-drag {
            grid-template-columns: 20px 1.5fr 1fr 0.7fr 0.7fr 28px;
            gap: 6px;
            padding: 6px 10px;
        }
        
        .auto-sort-enabled .product-grid-with-drag {
            grid-template-columns: 1.5fr 1fr 0.7fr 0.7fr 28px;
        }
        
        .auto-sort-enabled .table-header-with-drag {
            grid-template-columns: 1.5fr 1fr 0.7fr 0.7fr 28px;
        }
        
        .input-field {
            padding: 4px 6px;
            font-size: 13px;
        }
        
        .table-header-cell {
            font-size: 9px;
        }
        
        .cost-header {
            font-size: 8px;
        }
        
        .product-delete {
            width: 28px;
            height: 28px;
            font-size: 14px;
        }
        
        .drag-handle {
            width: 20px;
        }
        
        .category-header {
            padding: 12px 10px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .category-margin {
            font-size: 11px;
        }
        
        .category-margin select {
            padding: 3px 6px;
            font-size: 11px;
        }
        
        .category-margin span {
            display: none;
        }

        /* Mobile controls - modern compact design */
        .controls {
            padding: 10px 12px;
            gap: 6px;
            flex-wrap: nowrap;
            justify-content: space-between;
            overflow: visible;
        }

        .controls .btn-group {
            gap: 6px;
            overflow: visible;
        }

        .controls .btn {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .controls .btn svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        /* Hide text on secondary buttons, show only icons */
        .controls .btn-secondary {
            padding: 10px;
        }

        .controls .btn-secondary .btn-text {
            display: none;
        }

        .controls .btn-secondary svg {
            width: 18px;
            height: 18px;
        }

        /* Keep dropdown chevron visible */
        .controls .dropdown-toggle .chevron {
            width: 10px;
            height: 10px;
            display: block;
            flex-shrink: 0;
        }

        /* Fix button overflow */
        .controls .btn {
            overflow: visible;
        }

        .controls .dropdown-toggle {
            padding-right: 8px;
        }

        /* Ensure btn-divider doesn't cause issues */
        .btn-divider {
            height: 20px;
            margin: 0 2px;
        }

        /* Fix dropdown menu overflow on mobile */
        .dropdown-menu {
            min-width: 140px;
            max-width: calc(100vw - 24px);
            padding: 6px;
        }

        /* More dropdown aligns to right edge */
        #moreMenu .dropdown-menu {
            right: 12px !important;
            left: auto !important;
        }

        /* Add dropdown aligns under the button */
        #addMenu .dropdown-menu {
            left: 12px !important;
            right: auto !important;
        }

        /* Compact dropdown items on mobile */
        .dropdown-item {
            padding: 8px 12px;
            font-size: 13px;
            gap: 8px;
        }

        .dropdown-item svg {
            width: 16px;
            height: 16px;
        }

        .dropdown-divider {
            margin: 4px 0;
        }

        /* Share buttons - compact icon buttons */
        .share-controls {
            padding: 10px 12px;
            gap: 8px;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-bottom: 1px solid #bbf7d0;
            justify-content: center;
        }

        .btn-share {
            padding: 10px 16px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 24px;
            gap: 6px;
            flex: 1;
            max-width: 170px;
            border: none;
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .btn-share:hover {
            background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);
        }

        .btn-share svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
    }

    /* Extra small screens */
    @media (max-width: 380px) {
        .product-grid-with-drag {
            grid-template-columns: 18px 1.4fr 0.9fr 0.65fr 0.65fr 26px;
            gap: 4px;
            padding: 8px 8px;
        }
        
        .table-header-with-drag {
            grid-template-columns: 18px 1.4fr 0.9fr 0.65fr 0.65fr 26px;
            gap: 4px;
            padding: 6px 8px;
        }
        
        .auto-sort-enabled .product-grid-with-drag {
            grid-template-columns: 1.4fr 0.9fr 0.65fr 0.65fr 26px;
        }
        
        .auto-sort-enabled .table-header-with-drag {
            grid-template-columns: 1.4fr 0.9fr 0.65fr 0.65fr 26px;
        }
        
        .input-field {
            padding: 3px 4px;
            font-size: 12px;
        }
        
        .table-header-cell {
            font-size: 8px;
        }
    }
    
    /* Cost field styling - distinct internal look */
    .cost-field .input-field {
        background: #fef3c7;
        border: 1px dashed #f59e0b;
        color: #92400e;
        font-weight: 500;
    }
    
    .cost-field .input-field:hover {
        background: #fef3c7;
    }
    
    .cost-field .input-field:focus {
        background: #fef9c3;
        border-color: #f59e0b;
    }
    
    /* Cost header styling */
    .cost-header {
        color: #92400e;
        font-size: 10px;
    }
    
    /* Category margin selector */
    .category-margin {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #64748b;
    }
    
    .category-margin select {
        padding: 4px 8px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 12px;
        background: white;
        color: #334155;
        cursor: pointer;
    }
    
    .category-margin select:hover {
        border-color: #cbd5e1;
    }
    
    .category-margin select:focus {
        outline: none;
        border-color: #22c55e;
    }
    
    /* Add Product Button - Minimal */
    .add-product-btn {
        margin: 0;
        width: 100%;
        padding: 10px 16px;
        background: transparent;
        color: #64748b;
        border: none;
        border-top: 1px solid #f1f5f9;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        transition: all 0.15s;
    }
    
    .add-product-btn:hover {
        background: #fafafa;
        color: #0f172a;
    }
    
    .add-product-btn:active {
        background: #f5f5f5;
    }
    
    /* Table Header - Subtle */
    .table-header {
        display: grid;
        grid-template-columns: 2fr 1.5fr 1fr 32px;
        gap: 16px;
        padding: 8px 16px;
        background: #fafafa;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .table-header-cell {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #94a3b8;
    }
    
    /* Settings Panel */
    .settings-panel {
        position: fixed;
        inset: 0;
        background: white;
        z-index: 1000;
        transform: translateY(100%);
        transition: transform 0.3s;
        overflow-y: auto;
        padding: 32px 24px;
    }
    
    .settings-panel.show {
        transform: translateY(0);
    }
    
    
    /* Desktop layout for Pricing Tiers panel only */
    @media (min-width: 900px) {
        #customerPricingPanel {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        #pricingCardsGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            align-items: start;
        }

        #pricingCardsGrid > div {
            margin-bottom: 0 !important;
        }

        #pricingCardsGrid + div {
            margin-top: 24px;
        }
    }

    @media (min-width: 1400px) {
        #customerPricingPanel {
            padding: 48px 80px;
            max-width: 1600px;
        }

        #pricingCardsGrid {
            gap: 32px;
        }
    }

    .settings-panel h3 {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 24px;
    }

    /* ========================================
       ORDER TAKING STYLES - MODERN
       ======================================== */

    /* Panel Header */
    .order-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        margin: -24px -24px 24px -24px;
        border-radius: 20px 20px 0 0;
    }

    .order-panel-title {
        display: flex;
        align-items: center;
        gap: 12px;
        color: white;
    }

    .order-panel-title h2 {
        font-size: 20px;
        font-weight: 700;
        margin: 0;
        color: white;
    }

    .order-panel-icon {
        width: 40px;
        height: 40px;
        background: rgba(16, 185, 129, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .order-panel-icon svg {
        width: 22px;
        height: 22px;
        color: #10b981;
    }

    .order-close-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .order-close-btn:hover {
        background: rgba(255,255,255,0.2);
        transform: rotate(90deg);
    }

    .order-close-btn svg {
        width: 18px;
        height: 18px;
        color: white;
    }

    /* Customer Selector */
    .order-customer-section {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 20px;
        border: 1px solid #bbf7d0;
    }

    .order-customer-label {
        font-size: 11px;
        font-weight: 700;
        color: #15803d;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .order-customer-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #86efac;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        color: #166534;
        background: white;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2315803d' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 18px;
        transition: all 0.2s;
    }

    .order-customer-select:focus {
        outline: none;
        border-color: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15);
    }

    /* Search Box */
    .order-search-container {
        position: relative;
        margin-bottom: 20px;
    }

    .order-search-input {
        width: 100%;
        padding: 16px 20px 16px 52px;
        border: none;
        border-radius: 16px;
        font-size: 16px;
        font-weight: 500;
        background: #f1f5f9;
        box-sizing: border-box;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .order-search-input:focus {
        outline: none;
        background: white;
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08), 0 10px 40px rgba(0,0,0,0.08);
    }

    .order-search-input::placeholder {
        color: #94a3b8;
        font-weight: 400;
    }

    .order-search-icon {
        position: absolute;
        left: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        pointer-events: none;
    }

    .order-search-results {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        max-height: 280px;
        overflow-y: auto;
        z-index: 100;
        opacity: 0;
        transform: translateY(-10px) scale(0.98);
        pointer-events: none;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
    }

    .order-search-results.show {
        opacity: 1;
        transform: translateY(0) scale(1);
        pointer-events: auto;
    }

    .search-result-item {
        padding: 14px 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.15s;
        border-bottom: 1px solid #f1f5f9;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item:hover {
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }

    .search-result-item:active {
        transform: scale(0.99);
    }

    .search-result-info {
        flex: 1;
    }

    .search-result-name {
        font-weight: 600;
        color: #0f172a;
        font-size: 15px;
    }

    .search-result-detail {
        font-size: 13px;
        color: #64748b;
        margin-top: 2px;
    }

    .search-result-price {
        font-weight: 700;
        color: #10b981;
        font-size: 16px;
        background: #f0fdf4;
        padding: 6px 12px;
        border-radius: 20px;
    }

    /* Section Labels */
    .order-section-label {
        font-size: 11px;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .order-section-label::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #e2e8f0;
    }

    /* Items Container */
    .order-items-container {
        background: #f8fafc;
        border-radius: 16px;
        padding: 8px;
        margin-bottom: 20px;
        max-height: 260px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
    }

    .order-item-row {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        transition: all 0.2s;
    }

    .order-item-row:last-child {
        margin-bottom: 0;
    }

    .order-item-row:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .order-item-info {
        flex: 1;
        min-width: 0;
    }

    .order-item-name {
        font-weight: 600;
        color: #0f172a;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .order-item-detail {
        font-size: 12px;
        color: #64748b;
    }

    .order-item-qty-controls {
        display: flex;
        align-items: center;
        gap: 4px;
        background: #f1f5f9;
        border-radius: 10px;
        padding: 4px;
        margin: 0 12px;
    }

    .order-qty-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 8px;
        background: white;
        color: #0f172a;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .order-qty-btn:hover {
        background: #0f172a;
        color: white;
    }

    .order-qty-btn:active {
        transform: scale(0.92);
    }

    .order-qty-value {
        min-width: 36px;
        text-align: center;
        font-weight: 700;
        font-size: 15px;
        color: #0f172a;
    }

    .order-item-total {
        font-weight: 700;
        color: #10b981;
        font-size: 15px;
        min-width: 70px;
        text-align: right;
    }

    .order-item-remove {
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 8px;
        background: #fef2f2;
        color: #ef4444;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 8px;
        transition: all 0.15s;
    }

    .order-item-remove:hover {
        background: #ef4444;
        color: white;
    }

    .order-empty {
        text-align: center;
        padding: 40px 20px;
        color: #94a3b8;
    }

    .order-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.5;
    }

    .order-empty-text {
        font-size: 14px;
    }

    /* Notes Input */
    .order-notes-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 14px;
        resize: none;
        min-height: 70px;
        box-sizing: border-box;
        transition: all 0.2s;
        font-family: inherit;
    }

    .order-notes-input:focus {
        outline: none;
        border-color: #0f172a;
        box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.08);
    }

    .order-notes-input::placeholder {
        color: #94a3b8;
    }

    /* Total Section */
    .order-total-section {
        background: #0f172a;
        border-radius: 16px;
        padding: 20px 24px;
        margin: 20px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .order-total-label {
        font-size: 14px;
        color: #94a3b8;
        font-weight: 500;
    }

    .order-total-amount {
        font-size: 32px;
        font-weight: 800;
        color: #10b981;
    }

    /* Action Buttons */
    .order-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }

    .order-btn {
        padding: 16px 20px;
        border: none;
        border-radius: 14px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .order-btn-save {
        background: #f1f5f9;
        color: #475569;
        border: 2px solid #e2e8f0;
    }

    .order-btn-save:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
    }

    .order-btn-share {
        background: #10b981;
        color: white;
    }

    .order-btn-share:hover {
        background: #059669;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.35);
    }

    .order-btn:active {
        transform: scale(0.97);
    }

    /* History Button */
    .order-history-btn {
        width: 100%;
        padding: 14px;
        background: transparent;
        border: 2px dashed #e2e8f0;
        border-radius: 12px;
        color: #64748b;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .order-history-btn:hover {
        border-color: #cbd5e1;
        background: #f8fafc;
        color: #475569;
    }

    .search-result-manual {
        padding: 14px 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border-top: 2px dashed #e2e8f0;
        color: #64748b;
        font-size: 14px;
        transition: all 0.15s;
    }

    .search-result-manual:hover {
        background: #f1f5f9;
        color: #0f172a;
    }

    .manual-add-icon {
        width: 28px;
        height: 28px;
        background: #10b981;
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 600;
    }

    .search-result-manual strong {
        color: #0f172a;
    }

    .order-customer-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        border-radius: 10px;
        margin-bottom: 16px;
    }

    .order-customer-badge-icon {
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .order-customer-badge-name {
        font-weight: 600;
        color: #166534;
        font-size: 14px;
    }

    .order-customer-badge-tier {
        font-size: 12px;
        color: #16a34a;
    }

    .order-history-item {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s;
    }

    .order-history-item:hover {
        border-color: #10b981;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .order-history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .order-history-customer {
        font-weight: 600;
        color: #1e293b;
    }

    .order-history-total {
        font-weight: 700;
        color: #16a34a;
    }

    .order-history-meta {
        font-size: 12px;
        color: #64748b;
    }


    
    .input-group {
        margin-bottom: 20px;
    }
    
    .input-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--slate-700);
    }
    
    .input-group input {
        width: 100%;
        padding: 14px;
        border: 1.5px solid var(--slate-200);
        border-radius: 10px;
        font-size: 15px;
    }
    
    /* Toggle */
    .toggle-setting {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: var(--green-50);
        border-radius: 12px;
        margin-bottom: 12px;
        gap: 16px;
    }

    .toggle-info {
        flex: 1;
        min-width: 0;
    }

    .toggle-label {
        font-weight: 600;
        font-size: 15px;
        color: var(--slate-800);
        margin-bottom: 2px;
    }

    .toggle-description {
        color: var(--slate-600);
        font-size: 12px;
        margin: 0;
        line-height: 1.4;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        min-width: 52px;
        height: 28px;
        flex-shrink: 0;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background: var(--slate-300);
        border-radius: 28px;
        transition: 0.3s ease;
    }

    .toggle-slider:before {
        content: "";
        position: absolute;
        height: 22px;
        width: 22px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .toggle-switch input:checked + .toggle-slider {
        background: var(--green-500);
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
    
    /* Customer Items */
    .customer-item {
        background: white;
        padding: 16px;
        border-radius: 10px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--slate-100);
    }
    
    .customer-name {
        font-weight: 600;
        font-size: 16px;
    }
    
    .customer-phone {
        color: var(--slate-700);
        font-size: 14px;
        margin-top: 2px;
    }

    .customer-days {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 6px;
    }

    .customer-day-tag {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        color: #15803d;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
    }

    .customer-day-tag.all-days {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        color: #16a34a;
    }

    .day-checkbox {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .day-checkbox:has(input:checked) {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border-color: #22c55e;
        color: #15803d;
    }

    .day-checkbox input {
        accent-color: #22c55e;
    }

    .day-pill {
        padding: 8px 14px;
        border: 2px solid #e2e8f0;
        background: #f8fafc;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s;
    }

    .day-pill:hover {
        border-color: #22c55e;
        color: #16a34a;
    }

    .day-pill.active {
        background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
        border-color: #16a34a;
        color: white;
    }

    /* Modal - Modern Glass Design */
    .customer-share-menu {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        background: linear-gradient(145deg, rgba(255,255,255,0.98) 0%, rgba(248,250,252,0.98) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 0;
        border-radius: 24px;
        box-shadow:
            0 25px 80px rgba(0,0,0,0.15),
            0 10px 30px rgba(0,0,0,0.1),
            inset 0 1px 0 rgba(255,255,255,0.9);
        z-index: 1001;
        max-width: 90%;
        min-width: 340px;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.8);
    }

    .customer-share-menu.show {
        display: flex;
        flex-direction: column;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .share-menu-header {
        background: linear-gradient(135deg, #15803d 0%, #16a34a 50%, #22c55e 100%);
        padding: 24px 28px;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .share-menu-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    }

    .share-menu-header h3 {
        font-size: 20px;
        font-weight: 700;
        color: white;
        margin: 0 0 6px 0;
        position: relative;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .share-menu-header p {
        font-size: 13px;
        color: rgba(255,255,255,0.9);
        margin: 0;
        position: relative;
    }

    .share-menu-body {
        padding: 20px;
    }

    .customer-share-menu h3 {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #1e293b;
    }

    /* Share Options */
    .share-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .share-option {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px 16px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .share-option:hover {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-color: #cbd5e1;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    }

    .share-option:active {
        transform: scale(0.98) translateY(0);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .share-option-icon {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .share-option-info {
        flex: 1;
    }

    .share-option-title {
        font-size: 15px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 2px;
    }

    .share-option-desc {
        font-size: 12px;
        color: #64748b;
    }

    .share-option-arrow {
        color: #94a3b8;
        flex-shrink: 0;
        transition: transform 0.2s ease;
    }

    .share-option:hover .share-option-arrow {
        transform: translateX(3px);
        color: #64748b;
    }

    /* Cancel button in modals */
    .share-menu-cancel {
        width: 100%;
        padding: 14px;
        margin-top: 16px;
        background: transparent;
        border: 2px solid #e2e8f0;
        border-radius: 14px;
        font-size: 15px;
        font-weight: 600;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .share-menu-cancel:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
        color: #475569;
    }

    /* Loading */
    .loading {
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        flex-direction: column;
        gap: 16px;
    }
    
    .loading.show {
        display: flex;
    }
    
    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--green-100);
        border-top-color: var(--green-500);
        border-radius: 50%;
        animation: spin 0.7s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-text {
        font-size: 16px;
        font-weight: 600;
        color: var(--slate-700);
    }
    
    /* Toast */
    .toast {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--slate-900);
        color: white;
        padding: 16px 28px;
        border-radius: 12px;
        font-weight: 600;
        transition: bottom 0.3s;
        z-index: 1500;
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    
    .toast.show {
        bottom: 40px;
    }
    
    #downloadCanvas {
        display: none;
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7 20h10"/>
                        <path d="M10 20c5.5-2.5.8-6.4 3-10"/>
                        <path d="M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z"/>
                        <path d="M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z"/>
                    </svg>
                </div>
                <h1>Everfresh Produce</h1>
                <p>Wholesale Price List System</p>
            </div>
        </div>

        <div class="controls">
            <div class="btn-group">
                <!-- Primary Action: Export -->
                <button class="btn btn-success" onclick="downloadImage()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export
                </button>

                <!-- Add Menu -->
                <div class="dropdown" id="addMenu">
                    <button class="btn btn-primary dropdown-toggle" onclick="toggleDropdown('addMenu')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                        Add
                        <svg class="chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        <button class="dropdown-item" onclick="showSmartAddProduct(); closeAllDropdowns()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="8" x2="12" y2="16"/>
                                <line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                            New Product
                        </button>
                        <button class="dropdown-item" onclick="document.getElementById('xpsFileInput').click(); closeAllDropdowns()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            Import File
                        </button>
                        <input type="file" id="xpsFileInput" accept=".xps" style="display: none;" onchange="handleXPSUpload(event)">
                    </div>
                </div>
            </div>

            <div class="btn-divider"></div>

            <div class="btn-group">
                <!-- Save Button -->
                <button class="btn btn-secondary" onclick="saveToLocal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                        <polyline points="17 21 17 13 7 13 7 21"/>
                        <polyline points="7 3 7 8 15 8"/>
                    </svg>
                    <span class="btn-text">Save</span>
                </button>

                <!-- More Menu -->
                <div class="dropdown" id="moreMenu">
                    <button class="btn btn-secondary dropdown-toggle" onclick="toggleDropdown('moreMenu')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="1"/>
                            <circle cx="19" cy="12" r="1"/>
                            <circle cx="5" cy="12" r="1"/>
                        </svg>
                        <span class="btn-text">More</span>
                        <svg class="chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </button>
                    <div class="dropdown-menu">
                        <button class="dropdown-item" onclick="toggleSettings(); closeAllDropdowns()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.08 5.08 4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08-5.08 4.24-4.24"/>
                            </svg>
                            Settings
                        </button>
                        <button class="dropdown-item" onclick="toggleCustomerPricing(); closeAllDropdowns()" id="customerPricingBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Pricing
                        </button>
                        <button class="dropdown-item" onclick="autoOrganizeProducts(); closeAllDropdowns()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="21" y1="10" x2="3" y2="10"/>
                                <line x1="21" y1="6" x2="3" y2="6"/>
                                <line x1="21" y1="14" x2="3" y2="14"/>
                                <line x1="21" y1="18" x2="3" y2="18"/>
                            </svg>
                            Auto-Organize
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="share-controls">
            <button onclick="openOrderPanel()" class="new-order-btn">
                <span class="order-icon-wrap">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="3"/>
                        <line x1="8" y1="10" x2="16" y2="10"/>
                        <line x1="8" y1="14" x2="13" y2="14"/>
                        <circle cx="16.5" cy="17.5" r="4.5" fill="#10b981" stroke="#10b981"/>
                        <path d="M15 17.5l1 1 2-2" stroke="white" stroke-width="1.5"/>
                    </svg>
                </span>
                <span>Order</span>
            </button>
            <button class="btn btn-share" onclick="showShareMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                Share Price List
            </button>
        </div>

        <!-- Share Menu Modal -->
        <div class="customer-share-menu" id="shareMenu" style="max-height: 85vh;">
            <div class="share-menu-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="margin-bottom: 8px; opacity: 0.9;">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                <h3>Share Price List</h3>
                <p>Choose how you'd like to share</p>
            </div>

            <div class="share-menu-body">
                <div class="share-options">
                    <!-- iMessage Option (iOS) -->
                    <div class="share-option" onclick="shareViaIMessage()">
                        <div class="share-option-icon" style="background: linear-gradient(135deg, #34C759 0%, #30D158 100%);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="white">
                                <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
                            </svg>
                        </div>
                        <div class="share-option-info">
                            <div class="share-option-title">iMessage</div>
                            <div class="share-option-desc">Auto-send via iOS Shortcut</div>
                        </div>
                        <svg class="share-option-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>

                    <!-- WhatsApp Option -->
                    <div class="share-option" onclick="shareViaWhatsAppEnhanced()">
                        <div class="share-option-icon" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="white">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                        </div>
                        <div class="share-option-info">
                            <div class="share-option-title">WhatsApp</div>
                            <div class="share-option-desc">Share image directly</div>
                        </div>
                        <svg class="share-option-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>

                    <!-- Send to Customer Option -->
                    <div class="share-option" onclick="closeShareMenu(); showCustomerShareMenu();">
                        <div class="share-option-icon" style="background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                        </div>
                        <div class="share-option-info">
                            <div class="share-option-title">Send to Customer</div>
                            <div class="share-option-desc">Share to saved contacts</div>
                        </div>
                        <svg class="share-option-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>

                    <!-- Download Option -->
                    <div class="share-option" onclick="closeShareMenu(); downloadImage();">
                        <div class="share-option-icon" style="background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                        </div>
                        <div class="share-option-info">
                            <div class="share-option-title">Download Image</div>
                            <div class="share-option-desc">Save PNG to device</div>
                        </div>
                        <svg class="share-option-arrow" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </div>
                </div>

                <!-- iOS Shortcut Setup Info -->
                <div id="shortcutSetupInfo" style="display: none; margin-top: 16px; padding: 14px; background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-radius: 14px; border: 1px solid #FCD34D;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2.5">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <strong style="color: #92400E; font-size: 14px;">iOS Shortcut Required</strong>
                    </div>
                    <p style="color: #78350F; font-size: 12px; margin-bottom: 10px;">Install the "Everfresh Pricelist" shortcut to enable auto-send.</p>
                    <button onclick="window.open('https://www.icloud.com/shortcuts/', '_blank')" style="background: linear-gradient(135deg, #D97706, #B45309); color: white; border: none; padding: 10px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; width: 100%;">
                        Install Shortcut
                    </button>
                </div>

                <button class="share-menu-cancel" onclick="closeShareMenu()">Cancel</button>
            </div>
        </div>
        
        <div class="customer-share-menu" id="customerShareMenu" style="max-height: 85vh;">
            <div class="share-menu-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="margin-bottom: 8px; opacity: 0.9;">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <h3>Send to Customer</h3>
                <p id="customerShareSubtitle">Select a customer to share with</p>
            </div>

            <div class="share-menu-body" style="flex: 1; overflow-y: auto;">
                <!-- Day Filter Section -->
                <div id="dayFilterSection" style="margin-bottom: 16px;">
                    <!-- Smart Tomorrow Button -->
                    <button id="sendTomorrowBtn" onclick="filterByTomorrow()" style="width: 100%; margin-bottom: 10px; background: linear-gradient(135deg, #15803d 0%, #16a34a 50%, #22c55e 100%); color: white; padding: 14px 18px; font-size: 14px; font-weight: 600; border: none; border-radius: 14px; display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(22, 163, 74, 0.3); transition: all 0.2s ease;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span id="tomorrowBtnText">Send to Tomorrow's Customers</span>
                    </button>

                    <!-- Day Selection Pills -->
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
                        <button class="day-pill active" data-day="all" onclick="filterCustomersByDay('all')">All</button>
                        <button class="day-pill" data-day="mon" onclick="filterCustomersByDay('mon')">Mon</button>
                        <button class="day-pill" data-day="tue" onclick="filterCustomersByDay('tue')">Tue</button>
                        <button class="day-pill" data-day="wed" onclick="filterCustomersByDay('wed')">Wed</button>
                        <button class="day-pill" data-day="thu" onclick="filterCustomersByDay('thu')">Thu</button>
                        <button class="day-pill" data-day="fri" onclick="filterCustomersByDay('fri')">Fri</button>
                        <button class="day-pill" data-day="sat" onclick="filterCustomersByDay('sat')">Sat</button>
                    </div>

                    <!-- Send to Filtered Button -->
                    <button id="sendFilteredBtn" onclick="sendToFilteredCustomers()" style="width: 100%; background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); color: white; padding: 12px 16px; font-size: 13px; font-weight: 600; border: none; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.2s ease;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <span id="sendFilteredText">Send to All (0)</span>
                    </button>
                </div>

                <!-- Progress indicator for Send All -->
                <div id="sendAllProgress" style="display: none; margin-bottom: 16px; padding: 14px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 14px; border: 1px solid #bbf7d0;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div class="spinner" style="width: 18px; height: 18px; border: 2.5px solid #22c55e; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span id="sendAllStatus" style="color: #16a34a; font-weight: 600; font-size: 14px;">Preparing...</span>
                    </div>
                    <div style="background: #bbf7d0; border-radius: 6px; height: 8px; overflow: hidden;">
                        <div id="sendAllProgressBar" style="background: linear-gradient(90deg, #16a34a, #22c55e); height: 100%; width: 0%; transition: width 0.3s; border-radius: 6px;"></div>
                    </div>
                </div>

                <!-- Customer List Label -->
                <div id="customerListLabel" style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Or send individually:</div>

                <div id="customerShareList" style="display: flex; flex-direction: column; gap: 10px;"></div>

                <button class="share-menu-cancel" onclick="closeCustomerShareMenu()" style="margin-top: 16px;">Cancel</button>
            </div>
        </div>

        <!-- XPS Import Modal -->
        <div class="customer-share-menu" id="xpsImportModal" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <h3>Import Products from XPS</h3>
            <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">Review the products extracted from your sales report. Select which ones to import.</p>
            
            <div id="xpsPreviewList" style="margin-bottom: 20px;"></div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeXPSImport()">Cancel</button>
                <button class="btn btn-success" onclick="confirmXPSImport()">Import Selected</button>
            </div>
        </div>

        <!-- Smart Add Product Modal -->
        <div class="customer-share-menu" id="smartAddModal" style="max-width: 500px;">
            <div class="share-menu-header" style="padding: 18px 24px;">
                <h3 style="margin: 0;">Add Product</h3>
            </div>

            <div class="share-menu-body">
                <div style="margin-bottom: 14px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 13px;">Product Name</label>
                    <input type="text" id="smartProductName" placeholder="Red Onion, Cherry Tomato..."
                           style="width: 100%; padding: 12px 14px; border: 1.5px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: border-color 0.2s; box-sizing: border-box;"
                           onfocus="this.style.borderColor='#22c55e'" onblur="this.style.borderColor='#d1d5db'"
                           onkeyup="analyzeProduct()">
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 14px;">
                    <div style="flex: 1;">
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 13px;">Grade/Size</label>
                        <input type="text" id="smartProductGrade" placeholder="10kg, BOX..."
                               style="width: 100%; padding: 12px 14px; border: 1.5px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: border-color 0.2s; box-sizing: border-box;"
                               onfocus="this.style.borderColor='#22c55e'" onblur="this.style.borderColor='#d1d5db'">
                    </div>
                    <div style="flex: 1;">
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 13px;">Price</label>
                        <input type="text" id="smartProductPrice" placeholder="$25"
                               style="width: 100%; padding: 12px 14px; border: 1.5px solid #d1d5db; border-radius: 10px; font-size: 15px; transition: border-color 0.2s; box-sizing: border-box;"
                               onfocus="this.style.borderColor='#22c55e'" onblur="this.style.borderColor='#d1d5db'">
                    </div>
                </div>

                <div id="smartAnalysis" style="margin-bottom: 14px;"></div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="closeSmartAdd()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-success" onclick="confirmSmartAdd()" style="flex: 1;">Add</button>
                </div>
            </div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <!-- Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;">
                <h2 style="font-size: 24px; font-weight: 700; color: #0f172a; margin: 0;">Settings</h2>
                <button onclick="closeSettings()" style="background: none; border: none; padding: 8px; cursor: pointer; color: #64748b;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>

            <!-- Profile Card -->
            <div style="background: linear-gradient(135deg, #15803d 0%, #22c55e 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; color: white;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <div>
                            <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8;">Salesman</div>
                            <div style="font-size: 18px; font-weight: 600;" id="profileNameDisplay">Not Set</div>
                        </div>
                    </div>
                    <span id="syncStatus" style="font-size: 11px; padding: 4px 10px; border-radius: 20px; font-weight: 600; background: rgba(255,255,255,0.2); color: white;">
                        <span id="syncStatusIcon"></span> <span id="syncStatusText">Offline</span>
                    </span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 6px;">Name</label>
                        <input type="text" id="salesmanName" placeholder="Your name"
                               style="width: 100%; padding: 10px 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95); color: #1e293b; box-sizing: border-box;"
                               onchange="updateProfileDisplay()">
                    </div>
                    <div>
                        <label style="display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 6px;">Phone</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="salesmanPhone" placeholder="0433 975 055"
                                   style="flex: 1; padding: 10px 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95); color: #1e293b; box-sizing: border-box;">
                            <button onclick="startPhoneVerification()" id="verifyPhoneBtn"
                                    style="padding: 10px 14px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; background: rgba(255,255,255,0.95); color: #15803d; cursor: pointer; white-space: nowrap;">
                                Verify
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="recaptcha-container"></div>

            <!-- OTP Modal (hidden by default) -->
            <div id="otpModal" class="customer-share-menu" style="max-width: 360px;">
                <div class="share-menu-header" style="padding: 20px;">
                    <h3 style="margin: 0;">Enter Verification Code</h3>
                    <p style="margin: 6px 0 0 0;" id="verifyingPhone">+61...</p>
                </div>
                <div class="share-menu-body">
                    <input type="text" id="otpCode" placeholder="000000" maxlength="6"
                           style="width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 28px; text-align: center; letter-spacing: 10px; margin-bottom: 16px; box-sizing: border-box;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn btn-secondary" onclick="cancelVerification()">Cancel</button>
                        <button class="btn btn-success" onclick="verifyOTP()">Verify</button>
                    </div>
                </div>
            </div>

            <!-- Preferences Card -->
            <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m-9-9h6m6 0h6"/></svg>
                    </div>
                    <div style="font-weight: 600; color: #1e293b; font-size: 15px;">Preferences</div>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid #f1f5f9;">
                    <div>
                        <div style="font-weight: 500; color: #1e293b; font-size: 14px;">Send for Next Day</div>
                        <div style="font-size: 12px; color: #64748b;">Shows tomorrow's date on price list</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="nextDayToggle" checked onchange="saveSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 0;">
                    <div>
                        <div style="font-weight: 500; color: #1e293b; font-size: 14px;">Auto-Sort A-Z</div>
                        <div style="font-size: 12px; color: #64748b;">Sort categories & products alphabetically</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoSortToggle" onchange="toggleAutoSort()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <!-- Customers Card -->
            <div style="background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    </div>
                    <div style="font-weight: 600; color: #1e293b; font-size: 15px;">Customers</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #64748b; margin-bottom: 6px;">Contact Name</label>
                        <input type="text" id="customerName" placeholder="Tony"
                               style="width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 12px; font-weight: 500; color: #64748b; margin-bottom: 6px;">Phone</label>
                        <input type="text" id="customerPhone" placeholder="0400123456"
                               style="width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                    </div>
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #64748b; margin-bottom: 6px;">Business Name <span style="color: #94a3b8; font-weight: 400;">(optional, internal only)</span></label>
                    <input type="text" id="customerBusinessName" placeholder="Tony's Restaurant"
                           style="width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                </div>

                <div style="margin-bottom: 12px;">
                    <label style="display: block; font-size: 12px; font-weight: 500; color: #64748b; margin-bottom: 8px;">Delivery Days</label>
                    <div id="customerDaysSelector" style="display: flex; flex-wrap: wrap; gap: 6px;">
                        <label class="day-checkbox"><input type="checkbox" value="mon"> Mon</label>
                        <label class="day-checkbox"><input type="checkbox" value="tue"> Tue</label>
                        <label class="day-checkbox"><input type="checkbox" value="wed"> Wed</label>
                        <label class="day-checkbox"><input type="checkbox" value="thu"> Thu</label>
                        <label class="day-checkbox"><input type="checkbox" value="fri"> Fri</label>
                        <label class="day-checkbox"><input type="checkbox" value="sat"> Sat</label>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="addCustomerContact()" style="width: 100%; padding: 12px; border-radius: 10px;">+ Add Customer</button>

                <div id="customersList" style="margin-top: 16px;"></div>
            </div>

            <!-- Save Button -->
            <button class="btn btn-success" onclick="saveSettings()" style="width: 100%; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600;">
                Save All Settings
            </button>
        </div>

        <!-- Customer Pricing Panel -->
        <div class="settings-panel" id="customerPricingPanel">
            <!-- Header -->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;">
                <h2 style="font-size: 24px; font-weight: 700; color: #0f172a; margin: 0;">Pricing Tiers</h2>
                <button onclick="toggleCustomerPricing()" style="background: none; border: none; padding: 8px; cursor: pointer; color: #64748b;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>

            <!-- Desktop Grid Wrapper -->
            <div id="pricingCardsGrid">
            <!-- Add New Tier Card -->
            <div style="background: linear-gradient(135deg, #15803d 0%, #22c55e 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; color: white;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div>
                        <div style="font-weight: 600; font-size: 15px;">Add New Tier</div>
                        <div style="font-size: 12px; opacity: 0.8;">Create custom pricing for customers</div>
                    </div>
                </div>

                <div style="display: grid; gap: 12px;">
                    <div>
                        <label style="display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 6px;">Customer/Tier Name</label>
                        <input type="text" id="tierName" list="customerSuggestions" placeholder="e.g., VIP Customers, Tony's Restaurant"
                               style="width: 100%; padding: 10px 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95); color: #1e293b; box-sizing: border-box;">
                        <datalist id="customerSuggestions"></datalist>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 6px;">Type</label>
                            <select id="adjustmentType" style="width: 100%; padding: 10px 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95); color: #1e293b; box-sizing: border-box;">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed">Fixed Amount ($)</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.8; margin-bottom: 6px;">Adjustment</label>
                            <input type="number" id="adjustmentValue" placeholder="-10 or +5" step="0.1"
                                   style="width: 100%; padding: 10px 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95); color: #1e293b; box-sizing: border-box;">
                        </div>
                    </div>
                    <button onclick="addCustomerTier()" style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.95); color: #15803d; cursor: pointer;">
                        + Add Pricing Tier
                    </button>
                </div>
            </div>

            <!-- Tier Selector - iOS Glass Style -->
            <div style="background: rgba(255,255,255,0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 4px 30px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1e293b; font-size: 15px;">Select Customer</div>
                        <div id="activeTierDisplay" style="font-size: 13px; color: #64748b; font-weight: 500;">Tap to choose</div>
                    </div>
                </div>
                <div id="customerTiersList" style="max-height: 280px; overflow-y: auto; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; overscroll-behavior-y: contain; border-radius: 12px; background: rgba(248,250,252,0.8);"></div>
                <div id="noTiersMessage" style="text-align: center; padding: 24px; color: #94a3b8; font-size: 13px;">No pricing tiers yet</div>
            </div>
            </div><!-- End pricingCardsGrid -->

            <!-- Pricing Logic Info Card -->
            <div style="background: white; border-radius: 16px; padding: 20px; border: 1px solid #e2e8f0;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    </div>
                    <div style="font-weight: 600; color: #1e293b; font-size: 15px;">Pricing Logic</div>
                </div>

                <div style="display: grid; gap: 12px;">
                    <div style="background: #f0fdf4; padding: 12px 16px; border-radius: 10px; border-left: 4px solid #22c55e;">
                        <div style="font-weight: 600; color: #15803d; font-size: 13px; margin-bottom: 4px;">Bulk Items</div>
                        <div style="font-size: 12px; color: #166534;">BAG, BOX, CARTON, KG  Round to whole dollars</div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Example: $10.80  <strong>$11</strong></div>
                    </div>
                    <div style="background: #eff6ff; padding: 12px 16px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: 600; color: #1d4ed8; font-size: 13px; margin-bottom: 4px;">Individual Items</div>
                        <div style="font-size: 12px; color: #1e40af;">PIECE, EACH  Keep cents</div>
                        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Example: $2.25  <strong>$2.25</strong></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Taking Panel -->
        <div class="settings-panel" id="orderPanel">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;">
                <h2 style="font-size: 22px; font-weight: 700; color: #0f172a; margin: 0;">New Order</h2>
                <button onclick="closeOrderPanel()" style="background: none; border: none; padding: 8px; cursor: pointer; color: #64748b;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <!-- Customer Selection -->
            <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Customer</label>
                <select id="orderCustomerSelect" onchange="selectOrderCustomer(this.value)" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 15px; font-weight: 500; color: #1e293b; background: white; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22 viewBox=%220 0 24 24%22 fill=%22none%22 stroke=%22%2364748b%22 stroke-width=%222%22%3E%3Cpolyline points=%226 9 12 15 18 9%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 18px;">
                    <option value="">Walk-in Customer</option>
                </select>
            </div>
            <div class="order-search-container">
                <svg class="order-search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" id="orderSearchInput" class="order-search-input" placeholder="Search products..." oninput="searchOrderProducts(this.value)" onfocus="showSearchResults()">
                <div id="orderSearchResults" class="order-search-results"></div>
            </div>
            <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Order Items</div>
            <div id="orderItemsContainer" class="order-items-container">
                <div class="order-empty" id="orderEmpty"><div class="order-empty-icon"></div><div>Search and add products above</div></div>
            </div>
            <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Notes</div>
            <textarea id="orderNotes" class="order-notes-input" placeholder="Delivery instructions, special requests..."></textarea>
            <div class="order-total-section">
                <div class="order-total-label">Grand Total</div>
                <div class="order-total-amount" id="orderGrandTotal">$0</div>
            </div>
            <div class="order-actions">
                <button class="order-btn order-btn-save" onclick="saveCurrentOrder()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    Save Order
                </button>
                <button class="order-btn order-btn-share" onclick="shareCurrentOrder()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
                    Share Order
                </button>
            </div>
            <button onclick="openOrderHistory()" style="width: 100%; margin-top: 16px; padding: 12px; background: none; border: 1px solid #e2e8f0; border-radius: 10px; color: #64748b; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                View Order History
            </button>
        </div>
        <div class="settings-panel" id="orderHistoryPanel">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e2e8f0;">
                <h2 style="font-size: 22px; font-weight: 700; color: #0f172a; margin: 0;">Order History</h2>
                <button onclick="closeOrderHistory()" style="background: none; border: none; padding: 8px; cursor: pointer; color: #64748b;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>
            <div id="orderHistoryList"></div>
        </div>

        <div class="content" id="categoriesContainer">
            <!-- Categories will be loaded here -->
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Generating your price list...</div>
    </div>

    <div class="toast" id="toast">Saved successfully!</div>

    <canvas id="downloadCanvas"></canvas>

    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA75uCHV4s526kc4JhnVfhvWGL8Wmd_FHc",
            authDomain: "pricelist-everfresh.firebaseapp.com",
            databaseURL: "https://pricelist-everfresh-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pricelist-everfresh",
            storageBucket: "pricelist-everfresh.firebasestorage.app",
            messagingSenderId: "705652613132",
            appId: "1:705652613132:web:0b74173f8a78146f494e29"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Cloud sync state
        let cloudSyncEnabled = false;
        let currentUserPhone = null;
        let syncInProgress = false;
        let lastUploadTimestamp = 0;  // Track our uploads to ignore in listener
        let realtimeListener = null;  // Firebase real-time listener reference
        let autoSaveTimer = null;     // Debounce timer for auto-save

        // ========================================
        // PHONE NUMBER UTILITIES
        // ========================================
        function normalizePhoneForStorage(phone) {
            // Remove all spaces, dashes, parentheses
            let cleaned = phone.replace(/[\s\-\(\)]/g, '');

            // Handle Australian formats
            if (cleaned.startsWith('+61')) {
                cleaned = '61' + cleaned.slice(3);
            } else if (cleaned.startsWith('0')) {
                cleaned = '61' + cleaned.slice(1);
            } else if (cleaned.startsWith('61')) {
                // Already in correct format
            }

            return cleaned;
        }

        function formatPhoneForFirebase(phone) {
            // Firebase Auth needs +61 format
            let cleaned = phone.replace(/[\s\-\(\)]/g, '');

            if (cleaned.startsWith('0')) {
                return '+61' + cleaned.slice(1);
            } else if (cleaned.startsWith('61')) {
                return '+' + cleaned;
            } else if (cleaned.startsWith('+61')) {
                return cleaned;
            }

            // Default: assume Australian
            return '+61' + cleaned;
        }

        // Salesman information
        let salesmanInfo = {
            name: '',
            phone: '',
            sendForNextDay: true // Default: send for tomorrow
        };

        // Customer contacts
        let customerContacts = [];
        
        // Auto-sort setting (default OFF for manual control)
        let autoSortEnabled = false;
        
        // Category margins (percentage markup on cost)
        // Default 15% for all categories
        let categoryMargins = {};
        const DEFAULT_MARGIN = 15;

        // Temporary storage for generated image
        let lastGeneratedImageUrl = null;

        // Session flag: image already saved to Photos (skip re-saving)
        let imageSavedThisSession = false;

        // Get effective date based on settings - uses Sydney timezone
        function getEffectiveDate() {
            // Get current date in Sydney timezone
            const sydneyNow = new Date(new Date().toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));

            if (salesmanInfo.sendForNextDay) {
                sydneyNow.setDate(sydneyNow.getDate() + 1); // Tomorrow in Sydney
            }
            return sydneyNow;
        }

        // Dropdown menu functions
        function toggleDropdown(menuId) {
            const dropdown = document.getElementById(menuId);
            const isActive = dropdown.classList.contains('active');

            // Close all dropdowns first
            closeAllDropdowns();

            // Toggle the clicked dropdown (if it wasn't active)
            if (!isActive) {
                dropdown.classList.add('active');

                // Position the dropdown menu using fixed positioning
                const dropdownMenu = dropdown.querySelector('.dropdown-menu');
                const button = dropdown.querySelector('.dropdown-toggle');
                const rect = button.getBoundingClientRect();

                // On mobile, use consistent positioning from controls row
                const isMobile = window.innerWidth <= 480;
                if (isMobile) {
                    // Find the controls row for consistent vertical positioning
                    const controls = document.querySelector('.controls');
                    const controlsRect = controls.getBoundingClientRect();
                    dropdownMenu.style.top = `${controlsRect.bottom + 4}px`;
                } else {
                    // Position dropdown below the button
                    dropdownMenu.style.top = `${rect.bottom + 8}px`;
                }
                dropdownMenu.style.left = `${rect.left}px`;
            }
        }

        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.classList.remove('active');
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.dropdown')) {
                closeAllDropdowns();
            }
        });

        // Initial data
        let priceData = {
            "TOMATOES": [
                ["Tomato", "Premium Extra Large", "$24"],
                ["Tomato", "Premium Large", "$20"],
                ["Tomato", "Premium Small-Mediums", "$18"],
                ["Roma Tomato", "Premium", "$26"],
                ["Roma Tomato", "No.2", "$15"],
                ["Truss Tomatoes", "-", "$20"],
                ["Cherry Tomatoes", "-", "$24"],
                ["Cherry Truss", "-", "$24"],
            ],
            "CAPSICUM (PEPPERS)": [
                ["Red Caps", "5kg", "$52"],
                ["Yellow Caps", "5kg", "$50"],
                ["Green Caps", "5kg", "$25"],
                ["Green Caps", "10kg", "$50"],
                ["Green Bullhorn", "5kg", "$36"],
            ],
            "CHILLIES": [
                ["Long Red Chilli", "6kg", "$45"],
                ["Long Green Chilli", "6kg", "$45"],
                ["Thai Green Chilli", "6kg", "$90"],
            ],
            "EGGPLANTS": [
                ["Eggplants 7kg", "Premium", "$18"],
                ["Eggplants 7kg", "Standard", "$14"],
                ["Eggplants 7kg", "No.2", "$10"],
                ["Purple Stripe Eggplant", "Medium", "$27"],
                ["Purple Stripe Eggplant", "Large", "$24"],
                ["Lebanese Eggplants", "-", "$16"],
            ],
            "CUCUMBERS": [
                ["Lebanese Cucumbers", "Premium", "$30"],
                ["Lebanese Cucumbers", "No.2", "$15"],
                ["Tele Cucumbers", "Bags", "$11"],
            ],
            "BEANS & PEAS": [
                ["Flat Beans", "5kg", "$32"],
                ["Sugar Snaps", "4kg", "$40"],
                ["Snow Peas", "4kg", "$40"],
            ],
            "SPECIALITY VEGETABLES": [
                ["Indian Bittermelon", "-", "$30"],
                ["Okra", "Small 6kg", "$48"],
                ["Curry Leaf", "per kg", "$22"],
            ],
            "ONIONS": [
                ["Brown Onion", "20kg", "$26"],
                ["Spanish/Red Onion", "10kg", "$13"],
            ],
            "GARLIC": [
                ["Organic Garlic", "5kg", "$72"],
                ["Organic Garlic", "10kg", "$140"],
                ["Peeled Garlic", "250g", "$27"],
                ["Peeled Garlic", "1kg", "$28"],
                ["Prepack Garlic", "-", "$26"],
            ],
            "PUMPKINS": [
                ["Grey/White Pumpkin", "per kg", "$0.60"],
                ["Butternut Pumpkin", "per kg", "$0.80"],
            ],
            "ROOT VEGETABLES": [
                ["Beetroot", "Small", "$11"],
                ["Beetroot", "Large", "$18"],
            ],
            "CITRUS & EGGS": [
                ["Lime", "10kg", "$26"],
                ["Eggs", "600g", "$30"],
                ["Eggs", "700g", "$34"],
            ],
        };

        // Customer Pricing System
        let customers = [];
        let selectedCustomer = null;
        let orders = [];
        let currentOrderItems = []; // For applying custom pricing

        // Smart rounding logic
        function shouldRoundToWholeDollar(gradeSize) {
            if (!gradeSize || gradeSize === '-') return true;
            
            const grade = gradeSize.toLowerCase();
            
            // Keywords that should KEEP CENTS (not round)
            const keepCentsKeywords = [
                'per kg', 'per kilo', '/kg', 'per kilogram',
                'per gram', 'per g', '/g',
                'piece', 'pieces', 'each', 'ea', 'unit', 'units', 'pc', 'pcs', 'per '
            ];
            
            // Check if it should keep cents
            const shouldKeepCents = keepCentsKeywords.some(keyword => grade.includes(keyword));
            
            // If should keep cents, return false (don't round)
            if (shouldKeepCents) return false;
            
            // Everything else rounds to whole dollars (bags, boxes, cartons, etc)
            return true;
        }

        // Smart price rounding
        function smartRoundPrice(price, gradeSize) {
            if (shouldRoundToWholeDollar(gradeSize)) {
                // Round to whole dollar
                return Math.round(price);
            } else {
                // Round to nearest 5 cents (0.05)
                // Examples: $2.37  $2.35, $0.83  $0.85, $1.22  $1.20
                return Math.round(price * 20) / 20;
            }
        }

        // Calculate customer-specific price with smart rounding
        function calculateCustomerPrice(basePrice, gradeSize, customer) {
            if (!customer || !customer.adjustmentValue) {
                return basePrice;
            }

            // Parse base price
            let priceStr = basePrice.toString().replace('$', '').replace(',', '');
            let price = parseFloat(priceStr);
            if (isNaN(price)) return basePrice;

            // Apply adjustment
            if (customer.adjustmentType === 'percentage') {
                price = price * (1 + customer.adjustmentValue / 100);
            } else if (customer.adjustmentType === 'fixed') {
                price = price + customer.adjustmentValue;
            }

            // Apply smart rounding (whole dollars OR nearest 5 cents)
            price = smartRoundPrice(price, gradeSize);
            
            // Format price
            if (shouldRoundToWholeDollar(gradeSize)) {
                return '$' + price;
            } else {
                return '$' + price.toFixed(2);
            }
        }

        // Get adjusted price data for selected customer
        function getAdjustedPriceData() {
            if (!selectedCustomer) return priceData;

            const adjustedData = {};
            for (const categoryName in priceData) {
                adjustedData[categoryName] = priceData[categoryName].map(item => {
                    return [
                        item[0], // Product name
                        item[1], // Grade/Size
                        calculateCustomerPrice(item[2], item[1], selectedCustomer) // Adjusted price
                    ];
                });
            }
            return adjustedData;
        }

        // Save customers to localStorage
        function saveCustomers() {
            localStorage.setItem('everfresh_customers', JSON.stringify(customers));
        }

        // Load from localStorage if available
        function loadFromLocal() {
            const saved = localStorage.getItem('everfresh_price_data');
            if (saved) {
                priceData = JSON.parse(saved);
            }
            
            const savedInfo = localStorage.getItem('everfresh_salesman_info');
            if (savedInfo) {
                salesmanInfo = JSON.parse(savedInfo);
                document.getElementById('salesmanName').value = salesmanInfo.name || '';
                document.getElementById('salesmanPhone').value = salesmanInfo.phone || '';
                document.getElementById('nextDayToggle').checked = salesmanInfo.sendForNextDay !== false; // Default true
                // Update profile display
                const profileDisplay = document.getElementById('profileNameDisplay');
                if (profileDisplay) {
                    profileDisplay.textContent = salesmanInfo.name || 'Not Set';
                }
            }
            
            // Load auto-sort setting
            const savedAutoSort = localStorage.getItem('everfresh_auto_sort');
            if (savedAutoSort !== null) {
                autoSortEnabled = savedAutoSort === 'true';
            }
            document.getElementById('autoSortToggle').checked = autoSortEnabled;
            updateAutoSortUI();
            
            // Load category margins
            const savedMargins = localStorage.getItem('everfresh_category_margins');
            if (savedMargins) {
                categoryMargins = JSON.parse(savedMargins);
            }
            
            const savedContacts = localStorage.getItem('everfresh_customer_contacts');
            if (savedContacts) {
                customerContacts = JSON.parse(savedContacts);
                renderCustomersList();
            }
            
            const savedCustomers = localStorage.getItem('everfresh_customers');
            if (savedCustomers) {
                customers = JSON.parse(savedCustomers);
            }
            
            // Load selected customer (active pricing tier)
            const savedSelectedId = localStorage.getItem('everfresh_selected_customer_id');
            if (savedSelectedId && customers.length > 0) {
                const id = parseInt(savedSelectedId);
                selectedCustomer = customers.find(c => c.id === id) || null;
            }
        }

        // Save to localStorage
        function saveToLocal(showNotification = true, skipCollect = false) {
            if (!skipCollect) {
                collectData();
            }
            localStorage.setItem('everfresh_price_data', JSON.stringify(priceData));
            localStorage.setItem('everfresh_category_margins', JSON.stringify(categoryMargins));

            // Trigger silent cloud sync if enabled
            if (cloudSyncEnabled && currentUserPhone) {
                syncToCloud(true);
            }

            // Show toast notification only if requested
            if (showNotification) {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }
        
        // Toggle auto-sort setting
        function toggleAutoSort() {
            autoSortEnabled = document.getElementById('autoSortToggle').checked;
            localStorage.setItem('everfresh_auto_sort', autoSortEnabled);
            updateAutoSortUI();
            
            if (autoSortEnabled) {
                // First collect any unsaved changes from DOM
                collectData();
                // Then sort the data
                sortPriceDataAlphabetically();
                // Save directly (don't call saveToLocal as it would collectData again)
                localStorage.setItem('everfresh_price_data', JSON.stringify(priceData));
            }
            
            renderCategories();
        }
        
        // Update UI based on auto-sort setting
        function updateAutoSortUI() {
            const container = document.getElementById('categoriesContainer');
            if (autoSortEnabled) {
                container.classList.add('auto-sort-enabled');
            } else {
                container.classList.remove('auto-sort-enabled');
            }
        }
        
        // Sort priceData alphabetically (categories and products)
        function sortPriceDataAlphabetically() {
            // Sort categories
            const sortedCategories = Object.keys(priceData).sort((a, b) => 
                a.localeCompare(b, undefined, { sensitivity: 'base' })
            );
            
            const sortedData = {};
            for (const category of sortedCategories) {
                // Sort products within each category by product name
                sortedData[category] = [...priceData[category]].sort((a, b) => 
                    a[0].localeCompare(b[0], undefined, { sensitivity: 'base' })
                );
            }
            
            priceData = sortedData;
        }

        // Toggle settings panel
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('show');
            // Close customer pricing if open
            document.getElementById('customerPricingPanel').classList.remove('show');
        }

        function closeSettings() {
            document.getElementById('settingsPanel').classList.remove('show');
        }

        // Toggle customer pricing panel
        function toggleCustomerPricing() {
            const panel = document.getElementById('customerPricingPanel');
            panel.classList.toggle('show');
            // Close settings if open
            document.getElementById('settingsPanel').classList.remove('show');
            
            if (panel.classList.contains('show')) {
                renderCustomerTiersList();
            }
        }

        // Update tier name suggestions from customer contacts
        function updateTierNameSuggestions() {
            const datalist = document.getElementById('customerSuggestions');
            if (!datalist) return;

            // Clear existing options
            while (datalist.firstChild) {
                datalist.removeChild(datalist.firstChild);
            }

            // Get unique names from contacts (business name preferred, fallback to contact name)
            const suggestions = [];
            customerContacts.forEach(contact => {
                const name = contact.businessName || contact.name;
                if (!suggestions.includes(name)) {
                    suggestions.push(name);
                }
            });

            // Create options safely
            suggestions.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                datalist.appendChild(option);
            });
        }

        // Add customer pricing tier
        function addCustomerTier() {
            const name = document.getElementById('tierName').value.trim();
            const type = document.getElementById('adjustmentType').value;
            const value = parseFloat(document.getElementById('adjustmentValue').value);

            if (!name) {
                alert('Please enter a customer/tier name');
                return;
            }

            if (isNaN(value)) {
                alert('Please enter a valid adjustment value');
                return;
            }

            customers.push({
                id: Date.now(),
                name: name,
                adjustmentType: type,
                adjustmentValue: value
            });

            saveCustomers();
            renderCustomerTiersList();

            // Clear inputs
            document.getElementById('tierName').value = '';
            document.getElementById('adjustmentValue').value = '';

            showToast('Customer tier added!');
        }

        // Render customer tiers list - iOS glass style picker
        function renderCustomerTiersList() {
            const container = document.getElementById('customerTiersList');
            const activeDisplay = document.getElementById('activeTierDisplay');
            const noTiersMsg = document.getElementById('noTiersMessage');

            // Update active display
            if (activeDisplay) {
                if (selectedCustomer) {
                    const adjustmentText = selectedCustomer.adjustmentType === 'percentage'
                        ? (selectedCustomer.adjustmentValue > 0 ? '+' : '') + selectedCustomer.adjustmentValue + '%'
                        : (selectedCustomer.adjustmentValue > 0 ? '+' : '') + '$' + Math.abs(selectedCustomer.adjustmentValue);
                    activeDisplay.textContent = selectedCustomer.name + ' (' + adjustmentText + ')';
                    activeDisplay.style.color = '#16a34a';
                } else {
                    activeDisplay.textContent = 'Tap to choose';
                    activeDisplay.style.color = '#64748b';
                }
            }

            // Show/hide no tiers message
            if (customers.length === 0) {
                container.style.display = 'none';
                if (noTiersMsg) noTiersMsg.style.display = 'block';
                return;
            }

            container.style.display = 'block';
            if (noTiersMsg) noTiersMsg.style.display = 'none';

            // Build list using DOM methods for safety
            container.innerHTML = '';
            customers.forEach((customer, index) => {
                const adjustmentText = customer.adjustmentType === 'percentage'
                    ? (customer.adjustmentValue > 0 ? '+' : '') + customer.adjustmentValue + '%'
                    : (customer.adjustmentValue > 0 ? '-' : '+') + '$' + Math.abs(customer.adjustmentValue);
                const isActive = selectedCustomer && selectedCustomer.id === customer.id;
                const badgeColor = customer.adjustmentValue < 0 ? '#ef4444' : '#22c55e';
                const isFirst = index === 0;
                const isLast = index === customers.length - 1;
                const borderRadius = customers.length === 1 ? '12px' : (isFirst ? '12px 12px 0 0' : (isLast ? '0 0 12px 12px' : '0'));

                const row = document.createElement('div');
                row.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; cursor: pointer; background: ' + (isActive ? 'rgba(16,185,129,0.1)' : 'transparent') + '; border-radius: ' + borderRadius + '; ' + (isLast ? '' : 'border-bottom: 1px solid rgba(0,0,0,0.06);') + ' transition: background 0.15s ease;';
                row.onclick = () => selectTierAndClose(customer.id);

                const leftSection = document.createElement('div');
                leftSection.style.cssText = 'display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0;';

                const avatar = document.createElement('div');
                avatar.style.cssText = 'width: 36px; height: 36px; border-radius: 50%; background: ' + (isActive ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%)') + '; display: flex; align-items: center; justify-content: center; flex-shrink: 0;';
                if (isActive) {
                    avatar.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
                } else {
                    const initial = document.createElement('span');
                    initial.style.cssText = 'font-size: 14px; font-weight: 600; color: #64748b;';
                    initial.textContent = customer.name.charAt(0).toUpperCase();
                    avatar.appendChild(initial);
                }

                const textDiv = document.createElement('div');
                textDiv.style.cssText = 'flex: 1; min-width: 0;';

                const nameDiv = document.createElement('div');
                nameDiv.style.cssText = 'font-size: 15px; font-weight: ' + (isActive ? '600' : '500') + '; color: #1e293b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
                nameDiv.textContent = customer.name;

                const priceDiv = document.createElement('div');
                priceDiv.style.cssText = 'font-size: 12px; color: ' + badgeColor + '; font-weight: 600;';
                priceDiv.textContent = adjustmentText;

                textDiv.appendChild(nameDiv);
                textDiv.appendChild(priceDiv);

                leftSection.appendChild(avatar);
                leftSection.appendChild(textDiv);

                const deleteBtn = document.createElement('button');
                deleteBtn.style.cssText = 'background: rgba(239,68,68,0.1); border: none; color: #ef4444; width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0;';
                deleteBtn.textContent = '';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteCustomerTier(customer.id); };

                row.appendChild(leftSection);
                row.appendChild(deleteBtn);
                container.appendChild(row);
            });
        }

        // Select tier and close popup, go to main screen
        function selectTierAndClose(customerId) {
            selectedCustomer = customers.find(c => c.id === customerId);
            if (selectedCustomer) {
                localStorage.setItem('everfresh_selected_customer_id', customerId.toString());
                showToast(selectedCustomer.name + ' pricing applied');
            }

            imageSavedThisSession = false;
            renderCustomerTiersList();
            renderCategories();

            // Close settings popup and show main screen
            document.getElementById('settingsPopup').classList.remove('active');
            document.body.style.overflow = '';

            if (cloudSyncEnabled && currentUserPhone) {
                syncToCloud(true);
            }
        }

        // ========================================
        // ORDER TAKING FUNCTIONS
        // ========================================
        let orderCustomerName = 'Walk-in Customer';

        function openOrderPanel() {
            currentOrderItems = [];
            document.getElementById('orderNotes').value = '';
            document.getElementById('orderSearchInput').value = '';
            document.getElementById('orderSearchResults').classList.remove('show');
            populateOrderCustomerDropdown();
            renderOrderItems();
            document.getElementById('orderPanel').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function populateOrderCustomerDropdown() {
            const select = document.getElementById('orderCustomerSelect');
            // Build options using DOM methods for safety
            select.textContent = '';

            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = 'Walk-in Customer';
            select.appendChild(defaultOpt);

            // Add pricing tiers
            customers.forEach(c => {
                const adj = c.adjustmentType === 'percentage'
                    ? (c.adjustmentValue > 0 ? '+' : '') + c.adjustmentValue + '%'
                    : (c.adjustmentValue > 0 ? '+$' : '-$') + Math.abs(c.adjustmentValue);
                const opt = document.createElement('option');
                opt.value = 'tier_' + c.id;
                opt.textContent = c.name + ' (' + adj + ')';
                if (selectedCustomer && selectedCustomer.id === c.id) opt.selected = true;
                select.appendChild(opt);
            });

            // Add contacts without tiers
            customerContacts.forEach(contact => {
                const hasTier = customers.some(c => c.name.toLowerCase() === contact.name.toLowerCase());
                if (!hasTier) {
                    const opt = document.createElement('option');
                    opt.value = 'contact_' + contact.phone;
                    opt.textContent = contact.name;
                    select.appendChild(opt);
                }
            });

            // Set orderCustomerName based on selection
            if (selectedCustomer) {
                orderCustomerName = selectedCustomer.name;
            } else {
                orderCustomerName = 'Walk-in Customer';
            }
        }

        function selectOrderCustomer(value) {
            if (!value) {
                selectedCustomer = null;
                orderCustomerName = 'Walk-in Customer';
            } else if (value.startsWith('tier_')) {
                const id = parseInt(value.replace('tier_', ''));
                selectedCustomer = customers.find(c => c.id === id) || null;
                orderCustomerName = selectedCustomer ? selectedCustomer.name : 'Walk-in Customer';
            } else if (value.startsWith('contact_')) {
                const phone = value.replace('contact_', '');
                const contact = customerContacts.find(c => c.phone === phone);
                selectedCustomer = null;
                orderCustomerName = contact ? contact.name : 'Walk-in Customer';
            }
            if (currentOrderItems.length > 0) recalculateOrderPrices();
        }

        function recalculateOrderPrices() {
            currentOrderItems.forEach(item => {
                const categoryData = priceData[item.category];
                if (categoryData) {
                    const product = categoryData.find(p => p[0] === item.name && p[1] === item.grade);
                    if (product) {
                        let unitPrice = parseFloat(product[2].replace(/[^0-9.-]/g, '')) || 0;
                        if (selectedCustomer) {
                            if (selectedCustomer.adjustmentType === 'percentage') unitPrice = unitPrice * (1 + selectedCustomer.adjustmentValue / 100);
                            else unitPrice = unitPrice + selectedCustomer.adjustmentValue;
                            if (shouldRoundToWholeDollar(item.grade)) unitPrice = Math.round(unitPrice);
                            else unitPrice = Math.round(unitPrice * 100) / 100;
                        }
                        item.unitPrice = unitPrice;
                        item.lineTotal = item.qty * unitPrice;
                    }
                }
            });
            renderOrderItems();
        }

        function closeOrderPanel() {
            document.getElementById('orderPanel').classList.remove('show');
            document.body.style.overflow = '';
        }

        function isProductAvailable(price) {
            if (!price || price === '') return false;
            const cleaned = price.toString().replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            return cleaned !== 'na' && cleaned !== 'notavailable';
        }

        function searchOrderProducts(query) {
            const resultsEl = document.getElementById('orderSearchResults');
            if (!query || query.length < 2) { resultsEl.classList.remove('show'); return; }
            const results = [];
            const lowerQuery = query.toLowerCase();
            for (const category in priceData) {
                priceData[category].forEach((item, idx) => {
                    const name = item[0] || '';
                    const grade = item[1] || '';
                    const price = item[2] || '';
                    // Skip unavailable products
                    if (!isProductAvailable(price)) return;
                    if (name.toLowerCase().includes(lowerQuery) || grade.toLowerCase().includes(lowerQuery) || category.toLowerCase().includes(lowerQuery)) {
                        let displayPrice = price;
                        if (selectedCustomer && price) {
                            const numPrice = parseFloat(price.replace(/[^0-9.-]/g, ''));
                            if (!isNaN(numPrice)) {
                                let adjusted = numPrice;
                                if (selectedCustomer.adjustmentType === 'percentage') adjusted = numPrice * (1 + selectedCustomer.adjustmentValue / 100);
                                else adjusted = numPrice + selectedCustomer.adjustmentValue;
                                if (shouldRoundToWholeDollar(grade)) adjusted = Math.round(adjusted);
                                else adjusted = Math.round(adjusted * 100) / 100;
                                displayPrice = '$' + adjusted.toFixed(adjusted % 1 === 0 ? 0 : 2);
                            }
                        }
                        results.push({ category, index: idx, name, grade, price: displayPrice });
                    }
                });
            }
            resultsEl.textContent = '';

            // Show matching products
            if (results.length > 0) {
                results.slice(0, 8).forEach(r => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.onclick = () => addProductToOrder(r.category, r.index);
                    const priceSpan = document.createElement('span');
                    priceSpan.className = 'search-result-price';
                    priceSpan.textContent = r.price;
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'search-result-name';
                    nameDiv.textContent = r.name;
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = 'search-result-details';
                    detailsDiv.textContent = r.grade + ' - ' + r.category;
                    div.appendChild(priceSpan);
                    div.appendChild(nameDiv);
                    div.appendChild(detailsDiv);
                    resultsEl.appendChild(div);
                });
            }

            // Always show "Add custom item" option at the bottom
            const manualDiv = document.createElement('div');
            manualDiv.className = 'search-result-manual';
            manualDiv.onclick = () => openManualProductModal(query);
            const iconSpan = document.createElement('span');
            iconSpan.className = 'manual-add-icon';
            iconSpan.textContent = '+';
            const textSpan = document.createElement('span');
            textSpan.textContent = 'Add "';
            const strongEl = document.createElement('strong');
            strongEl.textContent = query;
            textSpan.appendChild(strongEl);
            textSpan.appendChild(document.createTextNode('" manually'));
            manualDiv.appendChild(iconSpan);
            manualDiv.appendChild(textSpan);
            resultsEl.appendChild(manualDiv);

            resultsEl.classList.add('show');
        }

        function openManualProductModal(prefillName) {
            const modal = document.createElement('div');
            modal.className = 'share-menu-overlay';
            modal.id = 'manualProductModal';

            const menuDiv = document.createElement('div');
            menuDiv.className = 'share-menu';
            menuDiv.style.maxWidth = '360px';

            // Header
            const header = document.createElement('div');
            header.className = 'share-menu-header';
            const h3 = document.createElement('h3');
            h3.textContent = 'Add Custom Item';
            const closeBtn = document.createElement('button');
            closeBtn.className = 'share-menu-close';
            closeBtn.onclick = closeManualProductModal;
            closeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
            header.appendChild(h3);
            header.appendChild(closeBtn);

            // Body
            const body = document.createElement('div');
            body.className = 'share-menu-body';

            // Name field
            const nameGroup = document.createElement('div');
            nameGroup.style.marginBottom = '16px';
            const nameLabel = document.createElement('label');
            nameLabel.style.cssText = 'display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;';
            nameLabel.textContent = 'Product Name';
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.id = 'manualProductName';
            nameInput.value = prefillName || '';
            nameInput.style.cssText = 'width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; box-sizing: border-box;';
            nameInput.placeholder = 'e.g. Special Order Item';
            nameGroup.appendChild(nameLabel);
            nameGroup.appendChild(nameInput);

            // Desc field
            const descGroup = document.createElement('div');
            descGroup.style.marginBottom = '16px';
            const descLabel = document.createElement('label');
            descLabel.style.cssText = 'display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;';
            descLabel.textContent = 'Description (optional)';
            const descInput = document.createElement('input');
            descInput.type = 'text';
            descInput.id = 'manualProductDesc';
            descInput.style.cssText = 'width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; box-sizing: border-box;';
            descInput.placeholder = 'e.g. 10kg box';
            descGroup.appendChild(descLabel);
            descGroup.appendChild(descInput);

            // Price field
            const priceGroup = document.createElement('div');
            priceGroup.style.marginBottom = '20px';
            const priceLabel = document.createElement('label');
            priceLabel.style.cssText = 'display: block; font-size: 12px; font-weight: 600; color: #64748b; margin-bottom: 6px;';
            priceLabel.textContent = 'Price ($)';
            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.id = 'manualProductPrice';
            priceInput.style.cssText = 'width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; box-sizing: border-box;';
            priceInput.placeholder = '0.00';
            priceInput.step = '0.01';
            priceInput.min = '0';
            priceGroup.appendChild(priceLabel);
            priceGroup.appendChild(priceInput);

            // Add button
            const addBtn = document.createElement('button');
            addBtn.onclick = addManualProduct;
            addBtn.style.cssText = 'width: 100%; padding: 14px; background: #10b981; color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer;';
            addBtn.textContent = 'Add to Order';

            body.appendChild(nameGroup);
            body.appendChild(descGroup);
            body.appendChild(priceGroup);
            body.appendChild(addBtn);

            menuDiv.appendChild(header);
            menuDiv.appendChild(body);
            modal.appendChild(menuDiv);
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
            nameInput.focus();
        }

        function closeManualProductModal() {
            const modal = document.getElementById('manualProductModal');
            if (modal) modal.remove();
            document.body.classList.remove('modal-open');
        }

        function addManualProduct() {
            const name = document.getElementById('manualProductName').value.trim();
            const desc = document.getElementById('manualProductDesc').value.trim();
            const price = parseFloat(document.getElementById('manualProductPrice').value) || 0;

            if (!name) {
                alert('Please enter a product name');
                return;
            }
            if (price <= 0) {
                alert('Please enter a valid price');
                return;
            }

            currentOrderItems.push({
                category: 'CUSTOM',
                product: name,
                grade: desc || 'Custom Item',
                qty: 1,
                unitPrice: price,
                lineTotal: price,
                isManual: true
            });

            renderOrderItems();
            closeManualProductModal();
            document.getElementById('orderSearchInput').value = '';
            document.getElementById('orderSearchResults').classList.remove('show');
        }

        function showSearchResults() {
            const query = document.getElementById('orderSearchInput').value;
            if (query.length >= 2) document.getElementById('orderSearchResults').classList.add('show');
        }

        function addProductToOrder(category, index) {
            const item = priceData[category][index];
            const name = item[0], grade = item[1], basePrice = item[2];
            let unitPrice = parseFloat(basePrice.replace(/[^0-9.-]/g, '')) || 0;
            if (selectedCustomer) {
                if (selectedCustomer.adjustmentType === 'percentage') unitPrice = unitPrice * (1 + selectedCustomer.adjustmentValue / 100);
                else unitPrice = unitPrice + selectedCustomer.adjustmentValue;
                if (shouldRoundToWholeDollar(grade)) unitPrice = Math.round(unitPrice);
                else unitPrice = Math.round(unitPrice * 100) / 100;
            }
            const existing = currentOrderItems.find(i => i.category === category && i.name === name && i.grade === grade);
            if (existing) { existing.qty += 1; existing.lineTotal = existing.qty * existing.unitPrice; }
            else { currentOrderItems.push({ category, name, grade, qty: 1, unitPrice, lineTotal: unitPrice }); }
            document.getElementById('orderSearchInput').value = '';
            document.getElementById('orderSearchResults').classList.remove('show');
            renderOrderItems();
            showToast(name + ' added');
        }

        function updateOrderQty(index, delta) {
            const item = currentOrderItems[index];
            item.qty = Math.max(1, item.qty + delta);
            item.lineTotal = item.qty * item.unitPrice;
            renderOrderItems();
        }

        function removeOrderItem(index) {
            currentOrderItems.splice(index, 1);
            renderOrderItems();
        }

        function renderOrderItems() {
            const container = document.getElementById('orderItemsContainer');
            const totalEl = document.getElementById('orderGrandTotal');
            container.textContent = '';
            if (currentOrderItems.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'order-empty';
                empty.innerHTML = '<div class="order-empty-icon"></div><div class="order-empty-text">Search and add products above</div>';
                container.appendChild(empty);
                totalEl.textContent = '$0';
                return;
            }
            let grandTotal = 0;
            currentOrderItems.forEach((item, idx) => {
                grandTotal += item.lineTotal;
                const row = document.createElement('div');
                row.className = 'order-item';
                const info = document.createElement('div');
                info.className = 'order-item-info';
                const nameDiv = document.createElement('div');
                nameDiv.className = 'order-item-name';
                nameDiv.textContent = item.name;
                const gradeDiv = document.createElement('div');
                gradeDiv.className = 'order-item-grade';
                gradeDiv.textContent = item.grade;
                info.appendChild(nameDiv);
                info.appendChild(gradeDiv);
                const qtyDiv = document.createElement('div');
                qtyDiv.className = 'order-item-qty';
                const minusBtn = document.createElement('button');
                minusBtn.className = 'qty-btn qty-btn-minus';
                minusBtn.textContent = '';
                minusBtn.onclick = () => updateOrderQty(idx, -1);
                const qtySpan = document.createElement('span');
                qtySpan.className = 'qty-value';
                qtySpan.textContent = item.qty;
                const plusBtn = document.createElement('button');
                plusBtn.className = 'qty-btn qty-btn-plus';
                plusBtn.textContent = '+';
                plusBtn.onclick = () => updateOrderQty(idx, 1);
                qtyDiv.appendChild(minusBtn);
                qtyDiv.appendChild(qtySpan);
                qtyDiv.appendChild(plusBtn);
                const priceDiv = document.createElement('div');
                priceDiv.className = 'order-item-price';
                const unitDiv = document.createElement('div');
                unitDiv.className = 'order-item-unit';
                unitDiv.textContent = '$' + item.unitPrice.toFixed(item.unitPrice % 1 === 0 ? 0 : 2) + ' ea';
                const totalDiv = document.createElement('div');
                totalDiv.className = 'order-item-total';
                totalDiv.textContent = '$' + item.lineTotal.toFixed(item.lineTotal % 1 === 0 ? 0 : 2);
                priceDiv.appendChild(unitDiv);
                priceDiv.appendChild(totalDiv);
                const delBtn = document.createElement('button');
                delBtn.className = 'order-item-delete';
                delBtn.textContent = '';
                delBtn.onclick = () => removeOrderItem(idx);
                row.appendChild(info);
                row.appendChild(qtyDiv);
                row.appendChild(priceDiv);
                row.appendChild(delBtn);
                container.appendChild(row);
            });
            totalEl.textContent = '$' + grandTotal.toFixed(grandTotal % 1 === 0 ? 0 : 2);
        }

        function saveCurrentOrder() {
            if (currentOrderItems.length === 0) { showToast('Add items to save'); return; }
            const grandTotal = currentOrderItems.reduce((sum, i) => sum + i.lineTotal, 0);
            const order = {
                id: Date.now(),
                customerId: selectedCustomer ? selectedCustomer.id : null,
                customerName: orderCustomerName || 'Walk-in',
                items: [...currentOrderItems],
                notes: document.getElementById('orderNotes').value,
                grandTotal,
                createdAt: new Date().toISOString(),
                status: 'saved'
            };
            orders.unshift(order);
            saveOrdersToLocal();
            showToast('Order saved!');
            closeOrderPanel();
        }

        function saveOrdersToLocal() {
            localStorage.setItem('everfresh_orders', JSON.stringify(orders));
            if (cloudSyncEnabled && currentUserPhone) syncToCloud(true);
        }

        function loadOrdersFromLocal() {
            const saved = localStorage.getItem('everfresh_orders');
            if (saved) { try { orders = JSON.parse(saved); } catch (e) { orders = []; } }
        }

        function openOrderHistory() {
            renderOrderHistory();
            document.getElementById('orderHistoryPanel').classList.add('show');
        }

        function closeOrderHistory() {
            document.getElementById('orderHistoryPanel').classList.remove('show');
        }

        function renderOrderHistory() {
            const container = document.getElementById('orderHistoryList');
            container.textContent = '';
            if (orders.length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'text-align: center; padding: 40px; color: #94a3b8;';
                empty.innerHTML = '<div style="font-size: 48px; margin-bottom: 8px;"></div><div>No orders yet</div>';
                container.appendChild(empty);
                return;
            }
            orders.forEach(order => {
                const date = new Date(order.createdAt);
                const dateStr = date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' });
                const itemCount = order.items.reduce((sum, i) => sum + i.qty, 0);
                const div = document.createElement('div');
                div.className = 'order-history-item';
                div.onclick = () => viewOrder(order.id);
                div.innerHTML = '<div class="order-history-header"><span class="order-history-customer">' + order.customerName + '</span><span class="order-history-total">$' + order.grandTotal.toFixed(0) + '</span></div><div class="order-history-meta">' + dateStr + ' at ' + timeStr + ' - ' + itemCount + ' items</div>';
                container.appendChild(div);
            });
        }

        function viewOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            currentOrderItems = order.items.map(i => ({...i}));
            document.getElementById('orderNotes').value = order.notes || '';
            document.getElementById('orderCustomerName').textContent = order.customerName;
            document.getElementById('orderCustomerTier').textContent = 'Previous Order';
            renderOrderItems();
            closeOrderHistory();
            document.getElementById('orderPanel').classList.add('show');
        }

        async function shareCurrentOrder() {
            if (currentOrderItems.length === 0) { showToast('Add items to share'); return; }
            saveCurrentOrder();
            try {
                const blob = await generateOrderImageBlob();
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], 'order.png', { type: 'image/png' })] })) {
                    await navigator.share({ files: [new File([blob], 'order.png', { type: 'image/png' })], title: 'Order Summary' });
                } else {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'order-' + Date.now() + '.png';
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('Order image downloaded');
                }
            } catch (err) { console.error(err); showToast('Could not share'); }
        }

        function generateOrderImageBlob() {
            return new Promise((resolve) => {
                const canvas = document.getElementById('downloadCanvas');
                const ctx = canvas.getContext('2d');

                // STRICT 9:16 aspect ratio
                const width = 1080;
                const height = 1920;
                canvas.width = width;
                canvas.height = height;

                // Professional color palette
                const colors = {
                    forestGreen: '#2d6a4f',
                    mediumGreen: '#40916c',
                    freshGreen: '#52b788',
                    paleGreen: '#b7e4c7',
                    veryLightGreen: '#d8f3dc',
                    darkestGreen: '#1b4332',
                    white: '#ffffff',
                    lightGray: '#f8f9fa',
                    gray: '#6c757d'
                };

                const margin = 60;
                const contentWidth = width - (margin * 2);

                // Helper: Draw rounded rectangle
                function roundRect(x, y, w, h, r) {
                    ctx.beginPath();
                    ctx.moveTo(x + r, y);
                    ctx.lineTo(x + w - r, y);
                    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                    ctx.lineTo(x + w, y + h - r);
                    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                    ctx.lineTo(x + r, y + h);
                    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                    ctx.lineTo(x, y + r);
                    ctx.quadraticCurveTo(x, y, x + r, y);
                    ctx.closePath();
                }

                // ===== WHITE BACKGROUND =====
                ctx.fillStyle = colors.white;
                ctx.fillRect(0, 0, width, height);

                let y = 0;

                // ===== HEADER =====
                ctx.fillStyle = colors.forestGreen;
                ctx.fillRect(0, 0, width, 280);

                // Company name
                ctx.fillStyle = colors.white;
                ctx.font = 'bold 38px Arial, Helvetica, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('EVERFRESH PRODUCE GROUP PTY LTD', width / 2, 45);

                // ABN
                ctx.font = '20px Arial, Helvetica, sans-serif';
                ctx.fillStyle = colors.paleGreen;
                ctx.fillText('ABN: 54683292551', width / 2, 75);

                // Address line 1
                ctx.fillStyle = colors.white;
                ctx.font = '20px Arial, Helvetica, sans-serif';
                ctx.fillText('PO BOX 448, STAND 275, SHED C', width / 2, 110);

                // Address line 2
                ctx.fillText('SYDNEY MARKETS, NSW 2129', width / 2, 135);

                // Contact details
                ctx.font = '18px Arial, Helvetica, sans-serif';
                ctx.fillStyle = colors.paleGreen;
                ctx.fillText('PHONE: 0297466416  |  FAX: 0297631551', width / 2, 170);
                ctx.fillText('EMAIL: accounts@everfresh.net.au', width / 2, 195);

                // Invoice label
                ctx.font = 'bold 36px Arial, Helvetica, sans-serif';
                ctx.fillStyle = colors.white;
                ctx.fillText('INVOICE', width / 2, 250);

                y = 310;

                // ===== INVOICE INFO ROW =====
                // Get customer name
                let billToName = 'Walk-in Customer';
                if (orderCustomerName && orderCustomerName !== 'Walk-in Customer') {
                    const contact = customerContacts.find(c =>
                        c.name === orderCustomerName ||
                        c.businessName === orderCustomerName
                    );
                    if (contact && contact.businessName) {
                        billToName = contact.businessName;
                    } else if (contact) {
                        billToName = contact.businessName || contact.name;
                    } else {
                        const tier = customers.find(c => c.name === orderCustomerName);
                        if (tier && tier.linkedContactIndex !== undefined) {
                            const linkedContact = customerContacts[tier.linkedContactIndex];
                            billToName = linkedContact?.businessName || orderCustomerName;
                        } else {
                            billToName = orderCustomerName;
                        }
                    }
                }

                // Customer name - larger and prominent
                ctx.fillStyle = colors.darkestGreen;
                ctx.font = 'bold 38px Arial, Helvetica, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(billToName, margin, y);

                y += 50;

                // Date and Invoice number row
                const dateStr = new Date().toLocaleDateString('en-AU', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric'
                });
                ctx.font = '22px Arial, Helvetica, sans-serif';
                ctx.fillStyle = colors.gray;
                ctx.textAlign = 'left';
                ctx.fillText('Date: ' + dateStr, margin, y);

                ctx.textAlign = 'right';
                ctx.fillText('Invoice #: ' + Date.now().toString().slice(-6), width - margin, y);

                y += 40;

                // Divider line
                ctx.strokeStyle = colors.paleGreen;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(width - margin, y);
                ctx.stroke();

                y += 30;

                // ===== TABLE HEADER =====
                ctx.fillStyle = colors.forestGreen;
                roundRect(margin, y, contentWidth, 55, 8);
                ctx.fill();

                ctx.fillStyle = colors.white;
                ctx.font = 'bold 22px Arial, Helvetica, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('ITEM', margin + 25, y + 36);
                ctx.textAlign = 'center';
                ctx.fillText('QTY', width - margin - 160, y + 36);
                ctx.textAlign = 'right';
                ctx.fillText('AMOUNT', width - margin - 25, y + 36);

                y += 55;

                // ===== TABLE ROWS =====
                const rowHeight = 60;
                let grandTotal = 0;

                currentOrderItems.forEach((item, idx) => {
                    // Alternating row backgrounds
                    ctx.fillStyle = idx % 2 === 0 ? colors.white : colors.lightGray;
                    ctx.fillRect(margin, y, contentWidth, rowHeight);

                    // Left accent strip
                    ctx.fillStyle = colors.freshGreen;
                    ctx.fillRect(margin, y, 4, rowHeight);

                    // Bottom border
                    ctx.strokeStyle = colors.paleGreen;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(margin, y + rowHeight);
                    ctx.lineTo(width - margin, y + rowHeight);
                    ctx.stroke();

                    // Item name
                    const displayName = item.product || item.name || 'Item';
                    const maxItemLen = 32;
                    const truncatedName = displayName.length > maxItemLen ? displayName.substring(0, maxItemLen) + '...' : displayName;
                    ctx.fillStyle = colors.darkestGreen;
                    ctx.font = '24px Arial, Helvetica, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(truncatedName, margin + 25, y + 38);

                    // Quantity
                    ctx.fillStyle = colors.mediumGreen;
                    ctx.font = '24px Arial, Helvetica, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.qty.toString(), width - margin - 160, y + 38);

                    // Amount
                    ctx.fillStyle = colors.darkestGreen;
                    ctx.font = 'bold 26px Arial, Helvetica, sans-serif';
                    ctx.textAlign = 'right';
                    ctx.fillText('$' + item.lineTotal.toFixed(item.lineTotal % 1 === 0 ? 0 : 2), width - margin - 25, y + 40);

                    grandTotal += item.lineTotal;
                    y += rowHeight;
                });

                y += 25;

                // ===== NOTES SECTION =====
                const notes = document.getElementById('orderNotes').value.trim();
                if (notes) {
                    ctx.fillStyle = colors.veryLightGreen;
                    roundRect(margin, y, contentWidth, 70, 8);
                    ctx.fill();

                    ctx.fillStyle = colors.darkestGreen;
                    ctx.font = '22px Arial, Helvetica, sans-serif';
                    ctx.textAlign = 'left';
                    const maxLen = 50;
                    const noteText = notes.length > maxLen ? notes.substring(0, maxLen) + '...' : notes;
                    ctx.fillText('Note: ' + noteText, margin + 20, y + 44);

                    y += 90;
                }

                y += 15;

                // ===== GRAND TOTAL =====
                const totalGradient = ctx.createLinearGradient(margin, y, width - margin, y);
                totalGradient.addColorStop(0, colors.forestGreen);
                totalGradient.addColorStop(1, colors.darkestGreen);

                ctx.fillStyle = totalGradient;
                roundRect(margin, y, contentWidth, 90, 12);
                ctx.fill();

                // Total text
                ctx.fillStyle = colors.white;
                ctx.font = 'bold 28px Arial, Helvetica, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('TOTAL', margin + 35, y + 55);

                ctx.font = 'bold 48px Arial, Helvetica, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText('$' + grandTotal.toFixed(grandTotal % 1 === 0 ? 0 : 2), width - margin - 35, y + 58);

                y += 130;

                // ===== DIRECT DEPOSIT DETAILS =====
                ctx.fillStyle = colors.gray;
                ctx.font = '20px Arial, Helvetica, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('Direct Deposit Details', width / 2, y);

                y += 30;

                ctx.fillStyle = colors.darkestGreen;
                ctx.font = '18px Arial, Helvetica, sans-serif';
                ctx.fillText('Bank: ANZ  |  Account: EVERFRESH PRODUCE GROUP P/L', width / 2, y);

                y += 28;

                ctx.fillText('BSB: 012-432  |  Account No: 669189407', width / 2, y);

                canvas.toBlob(blob => resolve(blob), 'image/png');
            });
        }

        // Apply customer pricing
        function applyCustomerPricing(customerId) {
            if (customerId === null) {
                // Switch to Standard pricing
                selectedCustomer = null;
                localStorage.removeItem('everfresh_selected_customer_id');
                showToast('Standard pricing');
            } else if (selectedCustomer && selectedCustomer.id === customerId) {
                // Already active - switch to standard
                selectedCustomer = null;
                localStorage.removeItem('everfresh_selected_customer_id');
                showToast('Standard pricing');
            } else {
                // Activate selected tier
                selectedCustomer = customers.find(c => c.id === customerId);
                localStorage.setItem('everfresh_selected_customer_id', customerId.toString());
                showToast(`${selectedCustomer.name} pricing`);
            }

            // Reset image cache so new image is generated with new prices
            imageSavedThisSession = false;

            renderCustomerTiersList();
            renderCategories();

            // Sync to cloud immediately
            if (cloudSyncEnabled && currentUserPhone) {
                syncToCloud(true);
            }
        }

        // Delete customer tier
        function deleteCustomerTier(customerId) {
            if (!confirm('Delete this pricing tier?')) return;
            
            customers = customers.filter(c => c.id !== customerId);
            
            if (selectedCustomer && selectedCustomer.id === customerId) {
                selectedCustomer = null;
                renderCategories();
            }
            
            saveCustomers();
            renderCustomerTiersList();
            showToast('Pricing tier deleted');
        }

        // Helper to show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerHTML = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // XPS Import functionality
        let xpsExtractedProducts = [];

        // Normalize product names for matching
        function normalizeProductName(name) {
            let normalized = name.toUpperCase().trim();
            
            // Remove common filler words
            const fillers = ['PREMIUM', 'FRESH', 'NO.1', 'NO.2', 'NO1', 'NO2', 'GRADE', 'QUALITY', 'SELECT'];
            fillers.forEach(filler => {
                normalized = normalized.replace(new RegExp('\\b' + filler + '\\b', 'g'), '');
            });
            
            // Handle plurals - remove trailing S
            normalized = normalized.replace(/S\b/g, '');
            
            // Remove extra spaces
            normalized = normalized.replace(/\s+/g, ' ').trim();
            
            return normalized;
        }

        // Calculate similarity score between two product names
        function calculateSimilarity(name1, name2) {
            const norm1 = normalizeProductName(name1);
            const norm2 = normalizeProductName(name2);
            
            // Exact match
            if (norm1 === norm2) return 100;
            
            // One contains the other
            if (norm1.includes(norm2) || norm2.includes(norm1)) return 90;
            
            // Split into words and check overlap
            const words1 = norm1.split(' ');
            const words2 = norm2.split(' ');
            
            const commonWords = words1.filter(w => words2.includes(w) && w.length > 2);
            const totalWords = Math.max(words1.length, words2.length);
            
            if (commonWords.length === 0) return 0;
            
            const wordScore = (commonWords.length / totalWords) * 100;
            
            // Boost score if key words match
            const keyWords = ['TOMATO', 'CHILLI', 'CAPSICUM', 'CUCUMBER', 'LETTUCE', 'EGGPLANT'];
            const hasKeyMatch = keyWords.some(kw => norm1.includes(kw) && norm2.includes(kw));
            
            return hasKeyMatch ? wordScore : wordScore * 0.7;
        }

        // Smart extraction of unit price from concatenated format
        function extractUnitPrice(line) {
            // Format: [docket][size][qty][price][total]
            // Example: "376081LGE1014.00140.00"  qty=10, price=14.00, total=140.00
            
            const allNumbers = line.match(/(\d+\.\d{2})/g);
            if (!allNumbers || allNumbers.length < 2) return null;
            
            const total = parseFloat(allNumbers[allNumbers.length - 1]);
            const concatenated = allNumbers[allNumbers.length - 2];
            
            if (allNumbers.length === 2) {
                // Try to split concatenated qty+price
                const clean = concatenated.replace('.', '');
                
                // Try different split positions to find qty * price = total
                for (let splitPos = 1; splitPos < clean.length - 2; splitPos++) {
                    const qtyStr = clean.substring(0, splitPos);
                    const priceStr = clean.substring(splitPos);
                    
                    if (!qtyStr || !priceStr) continue;
                    
                    try {
                        const qty = parseInt(qtyStr);
                        // Re-add decimal (last 2 digits are cents)
                        const price = parseFloat(
                            priceStr.substring(0, priceStr.length - 2) + '.' + 
                            priceStr.substring(priceStr.length - 2)
                        );
                        
                        // Check if qty * price  total
                        const calculatedTotal = qty * price;
                        if (Math.abs(calculatedTotal - total) < 0.01) {
                            return price;
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            
            // Fallback: return as-is
            return parseFloat(concatenated);
        }

        async function handleXPSUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showToast('Parsing XPS file...');

            try {
                console.log('Starting XPS parse...');
                console.log('File:', file.name, 'Size:', file.size);
                
                const products = await parseXPSFile(file);
                
                console.log('Parse complete. Products:', products.length);
                
                if (products.length === 0) {
                    alert('No products found in XPS file. The file may be empty or in an unexpected format.');
                    return;
                }
                
                xpsExtractedProducts = products;
                showXPSPreview(products);
            } catch (error) {
                console.error('XPS parsing error:', error);
                console.error('Error stack:', error.stack);
                alert('Error parsing XPS file: ' + error.message + '\n\nCheck browser console (F12) for details.');
            }

            // Reset file input
            event.target.value = '';
        }

        async function parseXPSFile(file) {
            console.log('Loading ZIP...');
            const zip = await JSZip.loadAsync(file);
            console.log('ZIP loaded successfully');
            
            const products = {};

            // Find all .fpage files
            const fpageFiles = [];
            zip.forEach((relativePath, zipEntry) => {
                if (relativePath.endsWith('.fpage') && !zipEntry.dir) {
                    fpageFiles.push({path: relativePath, file: zipEntry});
                }
            });

            console.log(`Found ${fpageFiles.length} pages in XPS`);
            
            if (fpageFiles.length === 0) {
                throw new Error('No .fpage files found in XPS. File may be corrupted.');
            }

            // Parse each page
            for (const fpageInfo of fpageFiles) {
                try {
                    console.log(`Parsing ${fpageInfo.path}...`);
                    const content = await fpageInfo.file.async('text');
                    
                    // Parse XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(content, 'text/xml');
                    
                    // Check for parse errors
                    const parseError = xmlDoc.getElementsByTagName('parsererror');
                    if (parseError.length > 0) {
                        console.error('XML parse error:', parseError[0].textContent);
                        continue;
                    }
                    
                    // Extract all UnicodeString attributes
                    const glyphs = xmlDoc.getElementsByTagName('Glyphs');
                    const texts = [];
                    
                    for (let glyph of glyphs) {
                        const unicodeStr = glyph.getAttribute('UnicodeString');
                        if (unicodeStr) {
                            texts.push(unicodeStr.replace(/&amp;/g, '&'));
                        }
                    }
                    
                    console.log(`  Found ${texts.length} text elements`);

                    // Find product patterns
                    const productKeywords = ['LETTUCE', 'EGGPLANT', 'BEETROOT', 'MELON', 'TOMATO', 
                                            'CAPSICUM', 'CHILLI', 'CUCUMBER', 'BEANS', 'OKRA', 
                                            'ONION', 'GARLIC', 'PUMPKIN', 'CARROT', 'LUFFA',
                                            'MANGO', 'LIME', 'POMEGRANATE', 'GUAVA', 'COCONUT',
                                            'BASIL', 'MINT', 'CORIANDER', 'GINGER', 'POTATO',
                                            'ZUCCHINI', 'BROCCOLI', 'CAULIFLOWER', 'SPINACH',
                                            'MUSHROOM', 'CELERY', 'PARSLEY', 'KALE', 'PEA', 'SNAP'];

                    for (let i = 0; i < texts.length; i++) {
                        const text = texts[i].trim();
                        
                        // STRICT product detection criteria:
                        const hasKeyword = productKeywords.some(kw => text.toUpperCase().includes(kw));
                        const hasHyphen = text.includes(' - ');
                        const isNotTotal = !text.includes('Total');
                        const isNotCustomer = !text.includes('EPG') && !text.includes('FARMS') && 
                                            !text.includes('PTY') && !text.includes('P/L') &&
                                            !text.includes('CASH') && !text.includes('MARKET');
                        
                        if (hasKeyword && hasHyphen && isNotTotal && isNotCustomer) {
                            const productLine = text;
                            
                            // Look for prices in next few lines
                            for (let j = i + 1; j < Math.min(i + 8, texts.length); j++) {
                                const line = texts[j];
                                
                                // Skip lines that are clearly not price data
                                if (line.includes('Total') || line.includes('EPG') || 
                                    line.includes('MARKET') || line.includes('FRESH')) {
                                    continue;
                                }
                                
                                // Use smart extraction to handle concatenated qty+price+total
                                const unitPrice = extractUnitPrice(line);
                                
                                if (unitPrice && unitPrice > 0 && unitPrice < 1000) {
                                    if (!products[productLine]) {
                                        products[productLine] = [];
                                    }
                                    products[productLine].push(unitPrice);
                                    console.log(`    Found: ${productLine}  $${unitPrice}`);
                                    break;
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.error(`Error parsing page ${fpageInfo.path}:`, err);
                    console.error('Stack:', err.stack);
                }
            }

            console.log(`Extracted ${Object.keys(products).length} unique products`);

            // Format products
            const finalProducts = [];
            for (const [fullName, prices] of Object.entries(products)) {
                if (prices.length === 0) continue;

                const parts = fullName.split(' - ');
                const name = parts[0].trim();
                const grade = parts.length > 1 ? parts[1].trim() : '-';

                const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;

                // Use smart rounding (whole dollars OR nearest 5 cents)
                const suggestedPrice = smartRoundPrice(avgPrice, grade);

                finalProducts.push({
                    product: name,
                    grade: grade,
                    pricesSold: prices,
                    avgPrice: Math.round(avgPrice * 100) / 100,
                    suggestedPrice: suggestedPrice,
                    salesCount: prices.length,
                    selected: true
                });
            }

            return finalProducts.sort((a, b) => a.product.localeCompare(b.product));
        }

        function showXPSPreview(products) {
            const modal = document.getElementById('xpsImportModal');
            const list = document.getElementById('xpsPreviewList');

            if (products.length === 0) {
                list.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 40px;">No products found in XPS file.</p>';
                modal.classList.add('show');
                document.body.classList.add('modal-open');
                return;
            }

            // Match XPS products to existing products with better fuzzy matching
            const matches = [];
            const unmatched = [];

            products.forEach(xpsProduct => {
                let bestMatch = null;
                let bestScore = 0;

                // Search through all categories
                for (const categoryName in priceData) {
                    const items = priceData[categoryName];
                    
                    for (let i = 0; i < items.length; i++) {
                        const existingProduct = items[i][0]; // Product name
                        const existingGrade = items[i][1];   // Grade/Size
                        const existingPrice = items[i][2];   // Current price

                        // Calculate similarity score
                        const score = calculateSimilarity(xpsProduct.product, existingProduct);

                        if (score > bestScore) {
                            bestScore = score;
                            bestMatch = {
                                categoryName: categoryName,
                                itemIndex: i,
                                existingProduct: existingProduct,
                                existingGrade: existingGrade,
                                currentPrice: existingPrice,
                                xpsProduct: xpsProduct,
                                matchScore: score,
                                selected: score >= 70  // Auto-select if score >= 70%
                            };
                        }
                    }
                }

                // Only consider it a match if score is decent
                if (bestMatch && bestScore >= 60) {
                    matches.push(bestMatch);
                } else {
                    unmatched.push(xpsProduct);
                }
            });

            // Sort matches by score (best first)
            matches.sort((a, b) => b.matchScore - a.matchScore);

            list.innerHTML = `
                <div style="background: #f0fdf4; border: 1px solid #22c55e; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <strong style="color: #15803d;">Found ${matches.length} matching products in your price list</strong>
                    <p style="color: #16a34a; font-size: 13px; margin-top: 4px;">Prices will be updated based on your sales data. Review matches below.</p>
                </div>
                ${unmatched.length > 0 ? `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <strong style="color: #92400e;">${unmatched.length} products from XPS not found in your list</strong>
                        <p style="color: #78350f; font-size: 13px; margin-top: 4px;">Add these manually if needed</p>
                    </div>
                ` : ''}
                <div style="display: flex; gap: 10px; margin-bottom: 16px;">
                    <button class="btn btn-small btn-secondary" onclick="selectAllXPSMatches(true)">Select All</button>
                    <button class="btn btn-small btn-secondary" onclick="selectAllXPSMatches(false)">Deselect All</button>
                </div>
                <div style="max-height: 450px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px;">
                    ${matches.map((m, idx) => {
                        const matchQuality = m.matchScore >= 90 ? 'Excellent' : 
                                            m.matchScore >= 80 ? 'Good' :
                                            m.matchScore >= 70 ? 'Fair' : 'Weak';
                        
                        return `
                            <div style="padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 12px; background: ${m.matchScore < 70 ? '#fef3c7' : 'white'};">
                                <input type="checkbox" id="xps_match_${idx}" ${m.selected ? 'checked' : ''} 
                                       onchange="xpsMatches[${idx}].selected = this.checked"
                                       style="width: 18px; height: 18px; cursor: pointer;">
                                <label for="xps_match_${idx}" style="flex: 1; cursor: pointer;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <span style="font-size: 11px; padding: 2px 6px; background: #f1f5f9; border-radius: 4px;">${matchQuality}</span>
                                                <span style="font-size: 11px; color: #94a3b8;">${m.matchScore.toFixed(0)}% match</span>
                                            </div>
                                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 2px;">${m.existingProduct}</div>
                                            <div style="font-size: 13px; color: #64748b; margin-bottom: 4px;">${m.existingGrade}</div>
                                            <div style="font-size: 12px; color: #94a3b8;">
                                                XPS: "${m.xpsProduct.product}"  ${m.xpsProduct.pricesSold.map(p => '$' + p.toFixed(2)).join(', ')}
                                            </div>
                                        </div>
                                        <div style="text-align: right; min-width: 120px;">
                                            <div style="font-size: 13px; color: #94a3b8; text-decoration: line-through;">Was: ${m.currentPrice}</div>
                                            <div style="font-weight: 700; color: #15803d; font-size: 20px; margin: 4px 0;">
                                                $${m.xpsProduct.suggestedPrice.toFixed(shouldRoundToWholeDollar(m.existingGrade) ? 0 : 2)}
                                            </div>
                                            <div style="font-size: 11px; color: #64748b;">${m.xpsProduct.salesCount} sale${m.xpsProduct.salesCount > 1 ? 's' : ''}</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        `;
                    }).join('')}
                    ${unmatched.length > 0 ? `
                        <div style="padding: 16px; background: #fafafa;">
                            <div style="font-weight: 600; color: #64748b; margin-bottom: 8px;">Not Found in Your List (${unmatched.length}):</div>
                            ${unmatched.map(u => `
                                <div style="font-size: 13px; color: #94a3b8; padding: 6px 0; border-bottom: 1px solid #f1f5f9;">
                                    ${u.product} - ${u.grade}  $${u.suggestedPrice.toFixed(2)} (${u.salesCount} sales)
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            // Store matches globally
            window.xpsMatches = matches;
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        }

        // Levenshtein distance for fuzzy matching

        function selectAllXPSMatches(selected) {
            if (window.xpsMatches) {
                window.xpsMatches.forEach((m, idx) => {
                    m.selected = selected;
                    const checkbox = document.getElementById(`xps_match_${idx}`);
                    if (checkbox) checkbox.checked = selected;
                });
            }
        }

        function closeXPSImport() {
            document.getElementById('xpsImportModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            xpsExtractedProducts = [];
            window.xpsMatches = null;
        }

        function confirmXPSImport() {
            const matches = window.xpsMatches;
            if (!matches) return;

            const selected = matches.filter(m => m.selected);
            
            if (selected.length === 0) {
                alert('Please select at least one product to update');
                return;
            }

            // Update prices in priceData
            selected.forEach(match => {
                const price = '$' + match.xpsProduct.suggestedPrice.toFixed(
                    shouldRoundToWholeDollar(match.existingGrade) ? 0 : 2
                );
                
                // Update the price directly
                priceData[match.categoryName][match.itemIndex][2] = price;
            });

            saveToLocal();
            renderCategories();
            closeXPSImport();

            showToast(`Updated ${selected.length} product prices!`);
        }

        // Update profile display name
        function updateProfileDisplay() {
            const name = document.getElementById('salesmanName').value.trim();
            const display = document.getElementById('profileNameDisplay');
            if (display) {
                display.textContent = name || 'Not Set';
            }
        }

        // Save settings
        function saveSettings() {
            salesmanInfo.name = document.getElementById('salesmanName').value;
            salesmanInfo.phone = document.getElementById('salesmanPhone').value;
            salesmanInfo.sendForNextDay = document.getElementById('nextDayToggle').checked;

            localStorage.setItem('everfresh_salesman_info', JSON.stringify(salesmanInfo));
            updateProfileDisplay();

            // Trigger silent cloud sync if enabled
            if (cloudSyncEnabled && currentUserPhone) {
                syncToCloud(true);
            }

            showToast('Settings saved!');
            toggleSettings();
        }

        // Add customer contact
        function addCustomerContact() {
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const businessName = document.getElementById('customerBusinessName').value.trim();

            if (!name || !phone) {
                alert('Please enter both contact name and phone number');
                return;
            }

            // Get selected days
            const dayCheckboxes = document.querySelectorAll('#customerDaysSelector input[type="checkbox"]');
            const days = [];
            dayCheckboxes.forEach(cb => {
                if (cb.checked) days.push(cb.value);
            });

            // Create customer contact object
            const newContact = { name, phone, days };
            if (businessName) newContact.businessName = businessName;
            
            customerContacts.push(newContact);
            localStorage.setItem('everfresh_customer_contacts', JSON.stringify(customerContacts));

            // Auto-create pricing tier if it doesn't exist
            const tierName = businessName || name;
            const existingTier = customers.find(c => c.name.toLowerCase() === tierName.toLowerCase());
            if (!existingTier) {
                customers.push({
                    id: Date.now(),
                    name: tierName,
                    adjustmentType: 'percentage',
                    adjustmentValue: 0,
                    linkedContactIndex: customerContacts.length - 1
                });
                saveCustomers();
                renderCustomerTiersList();
            }

            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerBusinessName').value = '';
            // Reset day checkboxes
            dayCheckboxes.forEach(cb => cb.checked = false);

            renderCustomersList();
            updateTierNameSuggestions();

            const toast = document.getElementById('toast');
            toast.innerHTML = 'Customer added!';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                toast.innerHTML = 'Saved successfully!';
            }, 2000);
        }

        // Delete customer contact
        function deleteCustomerContact(index) {
            if (confirm('Delete this customer contact?')) {
                customerContacts.splice(index, 1);
                localStorage.setItem('everfresh_customer_contacts', JSON.stringify(customerContacts));
                renderCustomersList();
            }
        }

        // Render customers list
        function renderCustomersList() {
            const container = document.getElementById('customersList');
            if (customerContacts.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-size: 14px; margin-top: 10px;">No customers added yet</p>';
                return;
            }

            const dayNames = { mon: 'Mon', tue: 'Tue', wed: 'Wed', thu: 'Thu', fri: 'Fri', sat: 'Sat' };

            let html = '<div style="margin-top: 15px;">';
            customerContacts.forEach((customer, index) => {
                const days = customer.days || [];
                let daysHtml = '';
                if (days.length === 0) {
                    daysHtml = '<span class="customer-day-tag all-days">Every Day</span>';
                } else {
                    daysHtml = days.map(d => `<span class="customer-day-tag">${dayNames[d] || d}</span>`).join('');
                }

                const businessDisplay = customer.businessName ? `<div style="font-size: 12px; color: #8b5cf6; font-weight: 500;">${customer.businessName}</div>` : '';
                html += `
                    <div class="customer-item" style="flex-wrap: wrap;">
                        <div class="customer-info" style="flex: 1; min-width: 150px;">
                            <div class="customer-name">${customer.name}</div>
                            ${businessDisplay}
                            <div class="customer-phone">${customer.phone}</div>
                            <div class="customer-days">${daysHtml}</div>
                        </div>
                        <div class="customer-actions" style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-small" onclick="editCustomerDays(${index})">Edit Days</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCustomerContact(${index})">Delete</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Edit customer days
        function editCustomerDays(index) {
            const customer = customerContacts[index];
            const days = customer.days || [];
            const dayNames = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayLabels = { mon: 'Mon', tue: 'Tue', wed: 'Wed', thu: 'Thu', fri: 'Fri', sat: 'Sat' };

            let checkboxesHtml = dayNames.map(day => {
                const checked = days.includes(day) ? 'checked' : '';
                return `<label class="day-checkbox"><input type="checkbox" value="${day}" ${checked}> ${dayLabels[day]}</label>`;
            }).join('');

            const modal = document.createElement('div');
            modal.className = 'customer-share-menu show';
            modal.id = 'editDaysModal';
            modal.style.cssText = 'max-width: 400px;';
            modal.innerHTML = `
                <div class="share-menu-header">
                    <h3 style="margin: 0;">Edit Days for ${customer.name}</h3>
                    <p style="margin: 6px 0 0 0;">Select which days this customer comes in</p>
                </div>
                <div class="share-menu-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                        ${checkboxesHtml}
                    </div>
                    <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">Leave all unchecked = customer appears every day</p>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveCustomerDays(${index})" style="flex: 1;">Save</button>
                        <button class="btn btn-secondary" onclick="closeEditDaysModal()" style="flex: 1;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.body.classList.add('modal-open');
        }

        // Save customer days
        function saveCustomerDays(index) {
            const modal = document.getElementById('editDaysModal');
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]');
            const days = [];
            checkboxes.forEach(cb => {
                if (cb.checked) days.push(cb.value);
            });

            customerContacts[index].days = days;
            localStorage.setItem('everfresh_customer_contacts', JSON.stringify(customerContacts));

            closeEditDaysModal();
            renderCustomersList();

            const toast = document.getElementById('toast');
            toast.innerHTML = 'Days updated!';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                toast.innerHTML = 'Saved successfully!';
            }, 2000);
        }

        // Close edit days modal
        function closeEditDaysModal() {
            const modal = document.getElementById('editDaysModal');
            if (modal) modal.remove();
            document.body.classList.remove('modal-open');
        }

        // Render categories
        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            
            // Update auto-sort UI class
            updateAutoSortUI();

            // Show active pricing info
            if (selectedCustomer) {
                const adjustmentText = selectedCustomer.adjustmentType === 'percentage' 
                    ? `${selectedCustomer.adjustmentValue > 0 ? '+' : ''}${selectedCustomer.adjustmentValue}%`
                    : `${selectedCustomer.adjustmentValue > 0 ? '+' : ''}$${Math.abs(selectedCustomer.adjustmentValue)}`;
                
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                        <div style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #15803d 0%, #22c55e 100%); padding: 8px 14px; border-radius: 20px; box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3);">
                            <span style="color: white; font-size: 13px; font-weight: 600;">${selectedCustomer.name}</span>
                            <span style="background: rgba(255,255,255,0.25); color: white; font-size: 12px; font-weight: 700; padding: 2px 8px; border-radius: 10px;">${adjustmentText}</span>
                            <button onclick="applyCustomerPricing(${selectedCustomer.id})" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1;">&times;</button>
                        </div>
                    </div>
                `;
            }
            
            // Drag handle SVG icon
            const dragHandleSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>`;
            
            // Generate margin options HTML (15% to 100% in steps of 5)
            function getMarginOptions(selectedMargin) {
                let options = '';
                for (let i = 15; i <= 100; i += 5) {
                    options += `<option value="${i}" ${selectedMargin === i ? 'selected' : ''}>${i}%</option>`;
                }
                return options;
            }

            Object.keys(priceData).forEach((categoryName, catIndex) => {
                const category = document.createElement('div');
                category.className = 'category';
                category.draggable = !autoSortEnabled;
                category.dataset.categoryName = categoryName;
                category.dataset.categoryIndex = catIndex;
                
                // Get margin for this category (default 15%)
                const margin = categoryMargins[categoryName] || DEFAULT_MARGIN;
                
                // Encode category name for safe use in data attributes
                const encodedCategoryName = encodeURIComponent(categoryName);
                
                let html = `
                    <div class="category-header">
                        <div class="category-drag-handle" title="Drag to reorder category">${dragHandleSVG}</div>
                        <div class="category-title" style="flex: 1;">${categoryName}</div>
                        <div class="category-margin">
                            <span>Margin:</span>
                            <select class="margin-select" data-category-encoded="${encodedCategoryName}">
                                ${getMarginOptions(margin)}
                            </select>
                        </div>
                        <div class="category-actions">
                            <button class="icon-btn category-edit-btn" data-category-encoded="${encodedCategoryName}" title="Rename"></button>
                            <button class="icon-btn category-delete-btn" data-category-encoded="${encodedCategoryName}" title="Delete"></button>
                        </div>
                    </div>
                    <div class="table-header-with-drag">
                        <div class="table-header-cell"></div>
                        <div class="table-header-cell">Product</div>
                        <div class="table-header-cell">Grade/Size</div>
                        <div class="table-header-cell cost-header">Cost</div>
                        <div class="table-header-cell">Price${selectedCustomer ? ' (Adj.)' : ''}</div>
                        <div class="table-header-cell"></div>
                    </div>
                `;

                priceData[categoryName].forEach((item, idx) => {
                    const cost = item[3] || '';
                    const rawPrice = selectedCustomer
                        ? calculateCustomerPrice(item[2], item[1], selectedCustomer)
                        : item[2];
                    const displayPrice = formatPriceWithSymbol(rawPrice);
                    
                    html += `
                        <div class="product" data-category-encoded="${encodedCategoryName}" data-product-index="${idx}">
                            <div class="product-grid-with-drag">
                                <div class="drag-handle" title="Drag to reorder">${dragHandleSVG}</div>
                                <div class="product-field">
                                    <input type="text" class="input-field" value="${item[0]}" placeholder="Product name" data-category-encoded="${encodedCategoryName}" data-row="${idx}" data-col="0">
                                </div>
                                <div class="product-field">
                                    <input type="text" class="input-field" value="${item[1]}" placeholder="Grade/size" data-category-encoded="${encodedCategoryName}" data-row="${idx}" data-col="1">
                                </div>
                                <div class="product-field cost-field">
                                    <input type="text" class="input-field cost-input" value="${cost}" placeholder="$0" data-category-encoded="${encodedCategoryName}" data-row="${idx}" data-col="3">
                                </div>
                                <div class="product-field">
                                    <input type="text" class="input-field" value="${displayPrice}" placeholder="$0.00" data-category-encoded="${encodedCategoryName}" data-row="${idx}" data-col="2" ${selectedCustomer ? 'readonly style="background: #f0fdf4; color: #15803d;"' : ''}>
                                </div>
                                <button class="product-delete" data-category-encoded="${encodedCategoryName}" data-idx="${idx}"></button>
                            </div>
                        </div>
                    `;
                });

                html += `<button class="add-product-btn" data-category-encoded="${encodedCategoryName}">+ Add</button>`;

                category.innerHTML = html;
                container.appendChild(category);
                
                // Add drag event listeners for category
                if (!autoSortEnabled) {
                    setupCategoryDragEvents(category, categoryName);
                    
                    // Add drag event listeners for products within this category
                    const products = category.querySelectorAll('.product');
                    products.forEach(product => {
                        setupProductDragEvents(product, categoryName);
                    });
                }
            });
        }
        
        // Setup global event delegation (called once on page load)
        function setupGlobalEventDelegation() {
            const container = document.getElementById('categoriesContainer');
            
            container.addEventListener('click', function(e) {
                // Handle delete product button
                if (e.target.classList.contains('product-delete')) {
                    const encodedCat = e.target.dataset.categoryEncoded;
                    const idx = parseInt(e.target.dataset.idx);
                    if (encodedCat !== undefined && !isNaN(idx)) {
                        const categoryName = decodeURIComponent(encodedCat);
                        deleteRow(categoryName, idx);
                    }
                    return;
                }
                
                // Handle add product button
                if (e.target.classList.contains('add-product-btn')) {
                    const encodedCat = e.target.dataset.categoryEncoded;
                    if (encodedCat !== undefined) {
                        const categoryName = decodeURIComponent(encodedCat);
                        addRow(categoryName);
                    }
                    return;
                }
                
                // Handle category edit button
                if (e.target.classList.contains('category-edit-btn')) {
                    const encodedCat = e.target.dataset.categoryEncoded;
                    if (encodedCat !== undefined) {
                        const categoryName = decodeURIComponent(encodedCat);
                        const newName = prompt('Enter new category name:', categoryName);
                        if (newName !== null) {
                            renameCategory(categoryName, newName);
                        }
                    }
                    return;
                }

                // Handle category delete button
                if (e.target.classList.contains('category-delete-btn')) {
                    const encodedCat = e.target.dataset.categoryEncoded;
                    if (encodedCat !== undefined) {
                        const categoryName = decodeURIComponent(encodedCat);
                        deleteCategory(categoryName);
                    }
                    return;
                }
            });
            
            // Handle margin select change
            container.addEventListener('change', function(e) {
                // Reset image saved flag when any data changes
                imageSavedThisSession = false;

                if (e.target.classList.contains('margin-select')) {
                    const encodedCat = e.target.dataset.categoryEncoded;
                    if (encodedCat !== undefined) {
                        const categoryName = decodeURIComponent(encodedCat);
                        updateCategoryMargin(categoryName, e.target.value);
                    }
                    return;
                }

                // Handle cost input change
                if (e.target.classList.contains('cost-input')) {
                    const encodedCat = e.target.dataset.categoryEncoded;
                    const idx = parseInt(e.target.dataset.row);
                    if (encodedCat !== undefined && !isNaN(idx)) {
                        const categoryName = decodeURIComponent(encodedCat);
                        calculatePriceFromCost(categoryName, idx, e.target.value);
                    }
                    return;
                }
            });

            // Also reset on input event for immediate typing feedback + auto-save
            container.addEventListener('input', function(e) {
                if (e.target.tagName === 'INPUT') {
                    imageSavedThisSession = false;

                    // Auto-save with debounce (1.5 seconds after user stops typing)
                    if (autoSaveTimer) clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(() => {
                        console.log('[AutoSave] Saving changes...');
                        saveToLocal(false); // Silent save (no toast)
                    }, 1500);
                }
            });
        }
        
        // Update category margin
        function updateCategoryMargin(categoryName, margin) {
            categoryMargins[categoryName] = parseInt(margin);
            localStorage.setItem('everfresh_category_margins', JSON.stringify(categoryMargins));
            
            // Recalculate all prices in this category that have costs
            priceData[categoryName].forEach((item, idx) => {
                if (item[3]) {
                    calculatePriceFromCost(categoryName, idx, item[3]);
                }
            });
        }
        
        // Calculate selling price from cost + margin
        function calculatePriceFromCost(categoryName, idx, costValue) {
            // Parse cost value
            let cost = parseFloat(costValue.toString().replace('$', '').replace(',', ''));
            
            if (isNaN(cost) || cost <= 0) {
                return; // Don't update price if cost is invalid
            }
            
            // Get category margin
            const margin = categoryMargins[categoryName] || DEFAULT_MARGIN;
            
            // Calculate selling price: cost * (1 + margin/100)
            let sellingPrice = cost * (1 + margin / 100);
            
            // Get grade to determine rounding
            const grade = priceData[categoryName][idx][1];
            
            // Apply smart rounding
            sellingPrice = smartRoundPrice(sellingPrice, grade);
            
            // Format price
            const formattedPrice = sellingPrice % 1 === 0 ? `$${sellingPrice}` : `$${sellingPrice.toFixed(2)}`;
            
            // Update priceData
            priceData[categoryName][idx][2] = formattedPrice;
            priceData[categoryName][idx][3] = costValue.toString().startsWith('$') ? costValue : `$${cost}`;
            
            // Update the price input field directly (without re-rendering)
            const encodedCategoryName = encodeURIComponent(categoryName);
            const priceInput = document.querySelector(`input[data-category-encoded="${encodedCategoryName}"][data-row="${idx}"][data-col="2"]`);
            if (priceInput) {
                priceInput.value = formattedPrice;
            }
            
            // Save
            localStorage.setItem('everfresh_price_data', JSON.stringify(priceData));
        }
        
        // ========================================
        // DRAG AND DROP FUNCTIONALITY
        // ========================================
        
        let draggedElement = null;
        let dragType = null; // 'category' or 'product'
        let dragSourceCategory = null;
        let dragSourceIndex = null;
        
        function setupCategoryDragEvents(categoryEl, categoryName) {
            const handle = categoryEl.querySelector('.category-drag-handle');

            // Mouse-based drag and drop
            let mouseStartY = 0;
            let mouseIsDragging = false;
            let clone = null;
            let initialLeft = 0;
            let initialTop = 0;

            handle.addEventListener('mousedown', (e) => {
                if (autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                mouseStartY = e.clientY;
                mouseIsDragging = true;

                draggedElement = categoryEl;
                dragType = 'category';
                dragSourceCategory = categoryName;
                dragSourceIndex = parseInt(categoryEl.dataset.categoryIndex);

                categoryEl.classList.add('dragging');

                // Store initial position
                const rect = categoryEl.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;

                // Create a clone for visual feedback
                clone = categoryEl.cloneNode(true);
                clone.style.cssText = `
                    position: fixed;
                    pointer-events: none;
                    opacity: 0.8;
                    z-index: 10000;
                    width: ${categoryEl.offsetWidth}px;
                    background: #fff;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                    border-radius: 12px;
                    left: ${initialLeft}px;
                    top: ${initialTop}px;
                    transform: scale(1.02);
                `;
                document.body.appendChild(clone);

                document.addEventListener('mousemove', handleCategoryMouseMove);
                document.addEventListener('mouseup', handleCategoryMouseUp);
            });

            function handleCategoryMouseMove(e) {
                if (!mouseIsDragging || autoSortEnabled) return;

                e.preventDefault();

                // Move clone to follow mouse
                if (clone) {
                    clone.style.top = (initialTop + e.clientY - mouseStartY) + 'px';
                }

                // Find element under mouse
                if (clone) clone.style.display = 'none';
                const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                if (clone) clone.style.display = '';

                // Clear all category drag-over classes
                document.querySelectorAll('.category.drag-over').forEach(el => el.classList.remove('drag-over'));

                // Find the category element under the mouse
                if (elementBelow) {
                    const targetCategory = elementBelow.closest('.category');
                    if (targetCategory && targetCategory !== categoryEl) {
                        targetCategory.classList.add('drag-over');
                    }
                }
            }

            function handleCategoryMouseUp(e) {
                if (!mouseIsDragging || autoSortEnabled) {
                    cleanupCategory();
                    return;
                }

                // Find the target category
                if (clone) clone.style.display = 'none';
                const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                if (clone) clone.style.display = '';

                document.querySelectorAll('.category.drag-over').forEach(el => el.classList.remove('drag-over'));

                if (elementBelow) {
                    const targetCategory = elementBelow.closest('.category');
                    if (targetCategory && targetCategory !== categoryEl) {
                        const targetCategoryName = targetCategory.dataset.categoryName;

                        if (dragSourceCategory !== targetCategoryName) {
                            reorderCategories(dragSourceCategory, targetCategoryName);
                        }
                    }
                }

                cleanupCategory();
            }

            function cleanupCategory() {
                mouseIsDragging = false;
                categoryEl.classList.remove('dragging');
                if (clone && clone.parentNode) {
                    clone.parentNode.removeChild(clone);
                }
                clone = null;
                initialLeft = 0;
                initialTop = 0;
                draggedElement = null;
                dragType = null;
                dragSourceCategory = null;
                dragSourceIndex = null;
                document.removeEventListener('mousemove', handleCategoryMouseMove);
                document.removeEventListener('mouseup', handleCategoryMouseUp);
            }

            // Touch events for mobile category drag and drop
            let touchStartY = 0;
            let touchIsDragging = false;

            handle.addEventListener('touchstart', (e) => {
                if (autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                const touch = e.touches[0];
                touchStartY = touch.clientY;
                touchIsDragging = true;

                draggedElement = categoryEl;
                dragType = 'category';
                dragSourceCategory = categoryName;
                dragSourceIndex = parseInt(categoryEl.dataset.categoryIndex);

                categoryEl.classList.add('dragging');
                categoryEl.style.position = 'relative';
                categoryEl.style.zIndex = '1000';
                categoryEl.style.opacity = '0.8';
            }, { passive: false });

            handle.addEventListener('touchmove', (e) => {
                if (!touchIsDragging || autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                const touch = e.touches[0];
                const deltaY = touch.clientY - touchStartY;

                categoryEl.style.transform = `translateY(${deltaY}px)`;

                // Find element under touch point
                categoryEl.style.pointerEvents = 'none';
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                categoryEl.style.pointerEvents = '';

                // Clear all drag-over classes
                document.querySelectorAll('.category.drag-over').forEach(el => el.classList.remove('drag-over'));

                // Find the category element under the touch
                if (elementBelow) {
                    const targetCategory = elementBelow.closest('.category');
                    if (targetCategory && targetCategory !== categoryEl) {
                        targetCategory.classList.add('drag-over');
                    }
                }
            }, { passive: false });

            handle.addEventListener('touchend', (e) => {
                if (!touchIsDragging || autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                // Reset styles
                categoryEl.style.transform = '';
                categoryEl.style.position = '';
                categoryEl.style.zIndex = '';
                categoryEl.style.opacity = '';
                categoryEl.classList.remove('dragging');

                // Find the target category
                const touch = e.changedTouches[0];
                categoryEl.style.pointerEvents = 'none';
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                categoryEl.style.pointerEvents = '';

                document.querySelectorAll('.category.drag-over').forEach(el => el.classList.remove('drag-over'));

                if (elementBelow) {
                    const targetCategory = elementBelow.closest('.category');
                    if (targetCategory && targetCategory !== categoryEl) {
                        const targetCategoryName = targetCategory.dataset.categoryName;

                        if (dragSourceCategory !== targetCategoryName) {
                            reorderCategories(dragSourceCategory, targetCategoryName);
                        }
                    }
                }

                // Reset drag state
                touchIsDragging = false;
                draggedElement = null;
                dragType = null;
                dragSourceCategory = null;
                dragSourceIndex = null;
            }, { passive: false });
        }
        
        function setupProductDragEvents(productEl, categoryName) {
            const handle = productEl.querySelector('.drag-handle');

            // Mouse-based drag and drop (same approach as categories)
            let mouseStartY = 0;
            let mouseIsDragging = false;
            let clone = null;
            let initialLeft = 0;
            let initialTop = 0;

            handle.addEventListener('mousedown', (e) => {
                if (autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                mouseStartY = e.clientY;
                mouseIsDragging = true;

                draggedElement = productEl;
                dragType = 'product';
                dragSourceCategory = categoryName;
                dragSourceIndex = parseInt(productEl.dataset.productIndex);

                productEl.classList.add('dragging');

                // Store initial position
                const rect = productEl.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;

                // Create a clone for visual feedback
                clone = productEl.cloneNode(true);
                clone.style.cssText = `
                    position: fixed;
                    pointer-events: none;
                    opacity: 0.8;
                    z-index: 10000;
                    width: ${productEl.offsetWidth}px;
                    background: #fff;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                    border-radius: 8px;
                    left: ${initialLeft}px;
                    top: ${initialTop}px;
                    transform: scale(1.02);
                `;
                document.body.appendChild(clone);

                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });

            function handleMouseMove(e) {
                if (!mouseIsDragging || autoSortEnabled) return;

                e.preventDefault();

                // Move clone to follow mouse
                if (clone) {
                    clone.style.top = (initialTop + e.clientY - mouseStartY) + 'px';
                }

                // Find element under mouse (hide clone temporarily)
                if (clone) clone.style.display = 'none';
                const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                if (clone) clone.style.display = '';

                // Clear all drag-over classes
                document.querySelectorAll('.product.drag-over').forEach(el => el.classList.remove('drag-over'));

                // Find the product element under the mouse
                if (elementBelow) {
                    const targetProduct = elementBelow.closest('.product');
                    if (targetProduct && targetProduct !== productEl) {
                        const targetCategory = decodeURIComponent(targetProduct.dataset.categoryEncoded || '');
                        if (targetCategory === dragSourceCategory) {
                            targetProduct.classList.add('drag-over');
                        }
                    }
                }
            }

            function handleMouseUp(e) {
                if (!mouseIsDragging || autoSortEnabled) {
                    cleanup();
                    return;
                }

                // Find the target product
                if (clone) clone.style.display = 'none';
                const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                if (clone) clone.style.display = '';

                document.querySelectorAll('.product.drag-over').forEach(el => el.classList.remove('drag-over'));

                if (elementBelow) {
                    const targetProduct = elementBelow.closest('.product');

                    if (targetProduct && targetProduct !== productEl) {
                        const targetIndex = parseInt(targetProduct.dataset.productIndex);
                        const targetCategory = decodeURIComponent(targetProduct.dataset.categoryEncoded || '');

                        if (targetCategory === dragSourceCategory && dragSourceIndex !== targetIndex) {
                            reorderProducts(dragSourceCategory, dragSourceIndex, targetIndex);
                        }
                    }
                }

                cleanup();
            }

            function cleanup() {
                mouseIsDragging = false;
                productEl.classList.remove('dragging');
                if (clone && clone.parentNode) {
                    clone.parentNode.removeChild(clone);
                }
                clone = null;
                initialLeft = 0;
                initialTop = 0;
                draggedElement = null;
                dragType = null;
                dragSourceCategory = null;
                dragSourceIndex = null;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            }

            // Touch events for mobile drag and drop
            let touchStartY = 0;
            let touchCurrentY = 0;
            let isDragging = false;
            let placeholder = null;
            let originalRect = null;

            handle.addEventListener('touchstart', (e) => {
                if (autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                const touch = e.touches[0];
                touchStartY = touch.clientY;
                touchCurrentY = touch.clientY;
                isDragging = true;

                draggedElement = productEl;
                dragType = 'product';
                dragSourceCategory = categoryName;
                dragSourceIndex = parseInt(productEl.dataset.productIndex);

                originalRect = productEl.getBoundingClientRect();
                productEl.classList.add('dragging');
                productEl.style.position = 'relative';
                productEl.style.zIndex = '1000';
                productEl.style.opacity = '0.8';
            }, { passive: false });

            handle.addEventListener('touchmove', (e) => {
                if (!isDragging || autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                const touch = e.touches[0];
                touchCurrentY = touch.clientY;
                const deltaY = touchCurrentY - touchStartY;

                productEl.style.transform = `translateY(${deltaY}px)`;

                // Find element under touch point
                productEl.style.pointerEvents = 'none';
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                productEl.style.pointerEvents = '';

                // Clear all drag-over classes
                document.querySelectorAll('.product.drag-over').forEach(el => el.classList.remove('drag-over'));

                // Find the product element under the touch
                if (elementBelow) {
                    const targetProduct = elementBelow.closest('.product');
                    if (targetProduct && targetProduct !== productEl) {
                        const targetCategory = decodeURIComponent(targetProduct.dataset.categoryEncoded || '');
                        if (targetCategory === dragSourceCategory) {
                            targetProduct.classList.add('drag-over');
                        }
                    }
                }
            }, { passive: false });

            handle.addEventListener('touchend', (e) => {
                if (!isDragging || autoSortEnabled) return;

                e.preventDefault();
                e.stopPropagation();

                // Reset styles
                productEl.style.transform = '';
                productEl.style.position = '';
                productEl.style.zIndex = '';
                productEl.style.opacity = '';
                productEl.classList.remove('dragging');

                // Find the target product
                const touch = e.changedTouches[0];
                productEl.style.pointerEvents = 'none';
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                productEl.style.pointerEvents = '';

                document.querySelectorAll('.product.drag-over').forEach(el => el.classList.remove('drag-over'));

                if (elementBelow) {
                    const targetProduct = elementBelow.closest('.product');
                    if (targetProduct && targetProduct !== productEl) {
                        const targetIndex = parseInt(targetProduct.dataset.productIndex);
                        const targetCategory = decodeURIComponent(targetProduct.dataset.categoryEncoded || '');

                        if (targetCategory === dragSourceCategory && dragSourceIndex !== targetIndex) {
                            reorderProducts(dragSourceCategory, dragSourceIndex, targetIndex);
                        }
                    }
                }

                // Reset drag state
                isDragging = false;
                draggedElement = null;
                dragType = null;
                dragSourceCategory = null;
                dragSourceIndex = null;
            }, { passive: false });

            handle.addEventListener('touchcancel', () => {
                // Reset everything on cancel
                productEl.style.transform = '';
                productEl.style.position = '';
                productEl.style.zIndex = '';
                productEl.style.opacity = '';
                productEl.classList.remove('dragging');
                document.querySelectorAll('.product.drag-over').forEach(el => el.classList.remove('drag-over'));

                isDragging = false;
                draggedElement = null;
                dragType = null;
                dragSourceCategory = null;
                dragSourceIndex = null;
            });
        }
        
        function reorderCategories(fromCategory, toCategory) {
            // Remove any cloned elements before collecting data to avoid duplicates
            document.querySelectorAll('body > .category').forEach(clone => clone.remove());

            collectData(); // Save current input values first

            const categoryNames = Object.keys(priceData);
            const fromIndex = categoryNames.indexOf(fromCategory);
            const toIndex = categoryNames.indexOf(toCategory);

            if (fromIndex === -1 || toIndex === -1) return;

            // Create new ordered object
            const newPriceData = {};
            const reorderedNames = [...categoryNames];

            // Remove from old position and insert at new position
            reorderedNames.splice(fromIndex, 1);
            reorderedNames.splice(toIndex, 0, fromCategory);

            // Rebuild priceData in new order
            reorderedNames.forEach(name => {
                newPriceData[name] = priceData[name];
            });

            priceData = newPriceData;
            saveToLocal(false, true); // No toast, skip collectData (we already did it)
            renderCategories();
        }
        
        function reorderProducts(categoryName, fromIndex, toIndex) {
            // Remove any cloned elements before collecting data to avoid duplicates
            document.querySelectorAll('body > .product').forEach(clone => clone.remove());

            collectData(); // Save current input values first

            const products = priceData[categoryName];
            const [movedProduct] = products.splice(fromIndex, 1);
            products.splice(toIndex, 0, movedProduct);

            saveToLocal(false, true); // No toast, skip collectData (we already did it)
            renderCategories();
        }

        // Collect data from inputs
        function collectData() {
            const inputs = document.querySelectorAll('input[data-category-encoded]');
            inputs.forEach(input => {
                const encodedCategory = input.dataset.categoryEncoded;
                if (!encodedCategory) return;

                const category = decodeURIComponent(encodedCategory);
                const row = parseInt(input.dataset.row);
                const col = parseInt(input.dataset.col);

                if (!priceData[category] || !priceData[category][row]) return;

                // Ensure the array has enough elements (for cost column)
                while (priceData[category][row].length <= col) {
                    priceData[category][row].push('');
                }

                let value = input.value;
                // Auto-format product name (col 0) with Title Case
                if (col === 0) {
                    value = formatProductName(value);
                    input.value = value; // Update the input field too
                }
                // Auto-format grade/size column (col 1) with proper capitalization
                if (col === 1) {
                    value = formatGradeSize(value);
                    input.value = value; // Update the input field too
                }
                // Auto-add $ to price column (col 2) if user typed a number without $
                if (col === 2) {
                    // Skip collecting price when customer pricing is active
                    // because the input shows adjusted price, not base price
                    if (selectedCustomer) {
                        return; // Don't overwrite base price with adjusted price
                    }
                    value = formatPriceWithSymbol(value);
                    input.value = value; // Update the input field too
                }

                priceData[category][row][col] = value;
            });
        }

        // Add new row
        function addRow(categoryName) {
            collectData(); // Save current changes first
            priceData[categoryName].push(['New Product', '-', '$0', '']);
            saveToLocal(false); // No toast notification
            renderCategories();
        }

        // Delete row
        function deleteRow(categoryName, idx) {
            collectData(); // Save current changes first
            priceData[categoryName].splice(idx, 1);
            saveToLocal(false); // No toast notification
            renderCategories();
        }

        // Add category
        function addCategory() {
            const name = prompt('Enter category name:');
            if (name && name.trim()) {
                collectData(); // Save current changes first
                priceData[name.trim().toUpperCase()] = [['New Product', '-', '$0', '']];
                saveToLocal(false); // No toast notification
                renderCategories();
            }
        }

        // Auto-organize all products into correct categories and sort alphabetically
        function autoOrganizeProducts() {
            collectData(); // Get latest data from inputs

            const existingCategories = Object.keys(priceData);
            let movedCount = 0;
            let checkedCount = 0;

            // Collect all products with their current categories
            const allProducts = [];
            for (const [category, items] of Object.entries(priceData)) {
                for (const item of items) {
                    if (item[0] && item[0].trim() && item[0] !== 'New Product') {
                        allProducts.push({
                            name: item[0],
                            grade: item[1],
                            price: item[2],
                            cost: item[3] || '',
                            currentCategory: category
                        });
                        checkedCount++;
                    }
                }
            }

            // Clear all categories (we'll rebuild them)
            const newPriceData = {};

            // Process each product
            for (const product of allProducts) {
                // Use smart matching to find correct category
                const match = smartCategoryMatch(product.name, existingCategories);
                const correctCategory = match.category;

                // Track if product moved
                if (product.currentCategory !== correctCategory) {
                    movedCount++;
                    console.log(`[Auto-Organize] Moving "${product.name}" from "${product.currentCategory}" to "${correctCategory}"`);
                }

                // Add to correct category
                if (!newPriceData[correctCategory]) {
                    newPriceData[correctCategory] = [];
                }
                newPriceData[correctCategory].push([
                    product.name,
                    product.grade,
                    product.price,
                    product.cost
                ]);
            }

            // Sort products alphabetically within each category
            for (const category of Object.keys(newPriceData)) {
                newPriceData[category].sort((a, b) => {
                    const nameA = (a[0] || '').toLowerCase();
                    const nameB = (b[0] || '').toLowerCase();
                    return nameA.localeCompare(nameB);
                });
            }

            // Sort categories alphabetically
            const sortedCategories = Object.keys(newPriceData).sort((a, b) => a.localeCompare(b));
            const sortedPriceData = {};
            for (const cat of sortedCategories) {
                sortedPriceData[cat] = newPriceData[cat];
            }

            // Update price data
            priceData = sortedPriceData;

            // Save and refresh
            saveToLocal(false);
            renderCategories();

            // Show result
            showToast(`Organized ${checkedCount} products. Moved ${movedCount} to correct categories.`);
        }

        // Smart Add Product System
        let suggestedCategory = null;

        function showSmartAddProduct() {
            document.getElementById('smartAddModal').classList.add('show');
            document.body.classList.add('modal-open');
            document.getElementById('smartProductName').value = '';
            document.getElementById('smartProductGrade').value = '';
            document.getElementById('smartProductPrice').value = '';
            document.getElementById('smartAnalysis').innerHTML = '';
            suggestedCategory = null;

            // Focus on product name
            setTimeout(() => document.getElementById('smartProductName').focus(), 100);
        }

        function closeSmartAdd() {
            document.getElementById('smartAddModal').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        function analyzeProduct() {
            const productName = document.getElementById('smartProductName').value.trim();
            const analysisDiv = document.getElementById('smartAnalysis');
            
            if (!productName || productName.length < 2) {
                analysisDiv.innerHTML = '';
                suggestedCategory = null;
                return;
            }

            // Show analyzing state
            analysisDiv.innerHTML = `
                <div style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 12px; border-radius: 8px;">
                    <strong style="color: #475569;">Analyzing with AI...</strong>
                </div>
            `;

            // Get existing categories
            const existingCategories = Object.keys(priceData);

            // Try AI analysis first, fallback to smart matching if it fails
            analyzeWithAI(productName, existingCategories);
        }

        async function analyzeWithAI(productName, existingCategories) {
            const analysisDiv = document.getElementById('smartAnalysis');
            
            // Your Cloudflare Worker URL
            const WORKER_URL = 'https://pricelist.maruthi4a5.workers.dev/';
            
            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `You are an expert wholesale fresh produce categorization system for Sydney Markets.

Product to categorize: "${productName}"

Existing categories in this price list:
${existingCategories.length > 0 ? existingCategories.map(c => `- ${c}`).join('\n') : '(No categories yet)'}

COMPREHENSIVE CATEGORY MAPPING:

 LETTUCE & LEAFY GREENS:
- Lettuce types: Iceberg, Cos, Romaine, Butter, Oakleaf, Coral, Mignonette, Little Gem, Frise, Endive, Radicchio
- Leafy greens: Spinach, Baby Spinach, English Spinach, Rocket, Arugula, Kale, Silverbeet, Swiss Chard, Mesclun, Mixed Leaves, Spring Mix, Sorrel, Watercress, Mizuna

 TOMATOES:
- Varieties: Roma, Truss, Cherry, Grape, Cocktail, Medley, Kumato, Heirloom, Beefsteak, Campari, San Marzano, Green Tomato, Yellow Tomato, Ox Heart
- Note: ANY tomato variety belongs here

 CAPSICUM (PEPPERS):
- Bell Peppers: Red Caps, Green Caps, Yellow Caps, Orange Caps
- Specialty: Bullhorn, Long Sweet, Banana Pepper, Pimiento, Sweet Pointed

 CHILLIES:
- Hot peppers: Long Red/Green Chilli, Thai Chilli, Bird's Eye, Jalapeo, Habanero, Serrano, Cayenne, Scotch Bonnet, Ghost Pepper
- Mild peppers: Shishito, Padrn, Poblano, Anaheim
- Note: If it's hot/spicy pepper = CHILLIES

 EGGPLANTS:
- Varieties: Lebanese, Japanese, Thai, Purple Stripe, Graffiti, White, Indian, Baby, Globe, Fairy Tale, Rosa Bianca

 CUCUMBERS:
- Types: Lebanese, Continental, Telegraph, Mini, Baby, Persian, Burpless, English, Gherkin, Pickle

 BROCCOLI & CAULIFLOWER:
- Broccoli, Broccolini, Baby Broccoli, Tenderstem, Romanesco, Cauliflower, Purple Cauliflower, Orange Cauliflower

 BEANS & PEAS:
- Beans: Green Beans, Flat Beans, Runner Beans, Broad Beans, Butter Beans, Snake Beans, Yard Long Beans, Borlotti
- Peas: Snow Peas, Sugar Snap, Green Peas, Split Peas

 ASIAN VEGETABLES:
- Bok Choy, Pak Choy, Choy Sum, Gai Lan, Chinese Broccoli, Wombok, Napa Cabbage, Chinese Cabbage, Shanghai Bok Choy, Baby Bok Choy
- Gourds: Snake Gourd, Snake Guard, Bottle Gourd, Ridge Gourd, Ivy Gourd, Pointed Gourd, Luffa, Bitter Melon, Winter Melon
- Specialty: Daikon, Lotus Root, Galangal, Water Spinach, Morning Glory, Taro, Kohlrabi, Drumstick

 ONIONS:
- Types: Brown, Red, Spanish, White, Pickling, Pearl
- Spring varieties: Spring Onion, Shallots, Eschalots, Scallions, Green Onion, Leek

 GARLIC:
- Fresh Garlic, Peeled Garlic, Organic Garlic, Elephant Garlic, Black Garlic, Garlic Chives

 PUMPKINS:
- Types: Butternut, Grey, White, Queensland Blue, Kent, Jap, Kabocha, Crown, Golden Nugget
- Squash: Acorn, Delicata, Spaghetti Squash, Gem Squash

 ROOT VEGETABLES:
- Carrot, Baby Carrot, Dutch Carrot, Parsnip, Turnip, Swede, Rutabaga
- Beetroot, Baby Beetroot, Golden Beetroot, Candy Beetroot
- Radish, Daikon, Horseradish
- Sweet Potato, Potato, Kipfler, Sebago, Desiree, Pontiac, Coliban

 HERBS:
- Common: Basil, Mint, Coriander, Parsley (Flat/Curly), Dill, Chives
- Mediterranean: Rosemary, Thyme, Oregano, Sage, Marjoram, Bay Leaves
- Specialty: Curry Leaf, Kaffir Lime Leaf, Lemongrass, Thai Basil, Vietnamese Mint, Tarragon, Chervil

 MUSHROOMS:
- Common: Button, Cup, Flat, Swiss Brown, Cremini, Portobello
- Asian: Shiitake, Oyster, King Oyster, Enoki, Shimeji, Wood Ear, Maitake
- Specialty: Chanterelle, Porcini, Morel, Truffle, Lion's Mane

 CABBAGE & BRASSICAS:
- Cabbage: Green, Red, Savoy, Sugarloaf, Pointed
- Brassicas: Brussels Sprouts, Kohlrabi

 ZUCCHINI:
- Green Zucchini, Yellow Zucchini, Baby Zucchini, Tromboncino, Pattypan, Squash Blossom

 SPECIALITY VEGETABLES:
- Okra, Artichoke, Globe Artichoke, Asparagus, Fennel, Celery, Celeriac, Cardoon

 CITRUS:
- Lemon, Lime, Orange, Mandarin, Grapefruit, Tangelo, Blood Orange, Finger Lime, Yuzu, Kumquat

 EGGS:
- Chicken Eggs (600g, 700g, 800g), Duck Eggs, Quail Eggs, Free Range, Organic

 MELONS:
- Watermelon, Rockmelon, Honeydew, Cantaloupe, Galia, Piel de Sapo, Korean Melon

 FRUITS:
- Stone Fruit: Peach, Nectarine, Plum, Apricot, Cherry
- Tropical: Mango, Papaya, Pineapple, Passionfruit, Lychee, Longan, Rambutan, Dragonfruit, Durian
- Berries: Strawberry, Blueberry, Raspberry, Blackberry

CRITICAL RULES:
1. THIS IS A FRESH PRODUCE SYSTEM - never create animal/meat categories. "Snake Guard" = Snake Gourd vegetable, not snakes!
2. ALWAYS check if an existing category matches first - use it EXACTLY as written
3. Match the product to its parent category even without explicit keywords (e.g., "Iceberg" alone  LETTUCE & LEAFY GREENS)
4. Consider common misspellings: "Capsicam" = Capsicum, "Tomatoe" = Tomato, "Letuce" = Lettuce, "Guard" = Gourd
5. If truly uncertain, prefer broader existing categories over creating new ones

Response format (JSON only, no markdown):
{
  "category": "EXACT CATEGORY NAME IN CAPS",
  "isNew": true/false,
  "confidence": "high/medium/low",
  "reasoning": "Brief explanation"
}`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Worker request failed');
                }

                const data = await response.json();
                const textContent = data.content.find(c => c.type === 'text')?.text || '';

                // Clean and parse JSON response
                let cleanText = textContent.trim();
                cleanText = cleanText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                const result = JSON.parse(cleanText);

                // Validate AI result - reject nonsense categories
                const validCategories = Object.keys(PRODUCE_DATABASE);
                const isValidCategory = existingCategories.includes(result.category) ||
                                       validCategories.includes(result.category) ||
                                       validCategories.some(c => c.includes(result.category) || result.category.includes(c));

                if (!isValidCategory) {
                    // AI returned nonsense, use smart fallback instead
                    console.warn('AI returned invalid category:', result.category, '- using fallback');
                    const fallbackResult = smartCategoryMatch(productName, existingCategories);
                    displayAnalysisResult(fallbackResult, existingCategories, false);
                    return;
                }

                // Show AI result
                displayAnalysisResult(result, existingCategories, true);

            } catch (error) {
                console.error('AI analysis error:', error);
                
                // Fallback to smart offline matching
                const result = smartCategoryMatch(productName, existingCategories);
                displayAnalysisResult(result, existingCategories, false);
            }
        }

        function displayAnalysisResult(result, existingCategories, isAI) {
            const analysisDiv = document.getElementById('smartAnalysis');
            const isNewCategory = result.isNew || !existingCategories.includes(result.category);
            const confidenceColor = result.confidence === 'high' ? '#22c55e' : 
                                   result.confidence === 'medium' ? '#f59e0b' : '#ef4444';
            const confidenceIcon = result.confidence === 'high' ? '[HIGH]' : 
                                  result.confidence === 'medium' ? '[MED]' : '[LOW]';
            
            const aiLabel = isAI ? 'AI Analysis' : 'Smart Match';

            if (isNewCategory) {
                analysisDiv.innerHTML = `
                    <div style="background: #fef3c7; border: 1px solid #f59e0b; padding: 12px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <strong style="color: #92400e;">New Category</strong>
                            <span style="font-size: 11px; padding: 2px 6px; background: ${confidenceColor}20; color: ${confidenceColor}; border-radius: 4px; border: 1px solid ${confidenceColor};">
                                ${confidenceIcon} ${result.confidence}
                            </span>
                            ${isAI ? '<span style="font-size: 10px; color: #64748b;"> AI powered</span>' : ''}
                        </div>
                        <p style="color: #78350f; font-size: 13px; margin-top: 4px;">
                            <strong>"${result.category}"</strong><br>
                            <em>${result.reasoning}</em>
                        </p>
                    </div>
                `;
            } else {
                analysisDiv.innerHTML = `
                    <div style="background: #f0fdf4; border: 1px solid #22c55e; padding: 12px; border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                            <strong style="color: #15803d;">${aiLabel}</strong>
                            <span style="font-size: 11px; padding: 2px 6px; background: ${confidenceColor}20; color: ${confidenceColor}; border-radius: 4px; border: 1px solid ${confidenceColor};">
                                ${confidenceIcon} ${result.confidence}
                            </span>
                            ${isAI ? '<span style="font-size: 10px; color: #64748b;"> AI powered</span>' : ''}
                        </div>
                        <p style="color: #16a34a; font-size: 13px; margin-top: 4px;">
                            Will add to: <strong>"${result.category}"</strong><br>
                            <em>${result.reasoning}</em>
                        </p>
                    </div>
                `;
            }

            suggestedCategory = result.category;
        }

        // ========================================
        // SMART PRODUCE KNOWLEDGE DATABASE
        // ========================================
        // This is a comprehensive database that maps individual products
        // to their parent categories - no keywords needed!
        
        const PRODUCE_DATABASE = {
            //  LETTUCE & LEAFY GREENS
            'LETTUCE & LEAFY GREENS': {
                products: [
                    // Lettuce varieties
                    'iceberg', 'cos', 'romaine', 'butter', 'butterhead', 'oakleaf', 'oak leaf',
                    'coral', 'mignonette', 'little gem', 'gem lettuce', 'frisee', 'frise', 'endive',
                    'radicchio', 'red leaf', 'green leaf', 'bibb', 'boston', 'living lettuce',
                    // Leafy greens
                    'spinach', 'baby spinach', 'english spinach', 'rocket', 'arugula', 'wild rocket',
                    'kale', 'tuscan kale', 'curly kale', 'baby kale', 'silverbeet', 'silver beet',
                    'swiss chard', 'chard', 'rainbow chard', 'mesclun', 'mixed leaves', 'spring mix',
                    'salad mix', 'sorrel', 'watercress', 'land cress', 'microgreens', 'micro greens',
                    'baby greens', 'lettuce mix', 'salanova', 'tatsoi', 'mache', "lamb's lettuce"
                ],
                keywords: ['lettuce', 'leaf', 'leaves', 'greens', 'salad'],
                reasoning: 'Lettuce or leafy green vegetable'
            },
            
            //  TOMATOES
            'TOMATOES': {
                products: [
                    'roma', 'truss', 'cherry', 'grape', 'cocktail', 'medley', 'kumato',
                    'heirloom', 'beefsteak', 'beef steak', 'ox heart', 'oxheart', 'campari',
                    'san marzano', 'plum', 'yellow tomato', 'green tomato', 'tiger', 'zebra',
                    'vine ripened', 'vine-ripened', 'field tomato', 'gourmet', 'snacking',
                    'tommy toe', 'tommy toes', 'grosse lisse', 'money maker', 'black russian'
                ],
                keywords: ['tomato', 'tomatoe', 'tomatos', 'tomatoes'],
                reasoning: 'Tomato variety'
            },
            
            //  CAPSICUM (PEPPERS)
            'CAPSICUM (PEPPERS)': {
                products: [
                    'red caps', 'green caps', 'yellow caps', 'orange caps', 'bell pepper',
                    'bullhorn', 'bull horn', 'long sweet', 'banana pepper', 'pimiento',
                    'sweet pointed', 'ramiro', 'romano', 'cubanelle', 'mini caps', 'baby caps',
                    'mixed caps', 'tri color', 'tri-color'
                ],
                keywords: ['capsicum', 'caps', 'bell pepper', 'sweet pepper'],
                reasoning: 'Capsicum/bell pepper variety'
            },
            
            //  CHILLIES
            'CHILLIES': {
                products: [
                    'long red', 'long green', 'thai', "bird's eye", 'birds eye', 'birdseye',
                    'jalapeno', 'jalapeo', 'habanero', 'serrano', 'cayenne', 'scotch bonnet',
                    'ghost pepper', 'carolina reaper', 'shishito', 'padron', 'padrn',
                    'poblano', 'anaheim', 'pasilla', 'guajillo', 'ancho', 'chipotle',
                    'kashmiri', 'korean', 'gochugaru', 'peri peri', 'piri piri', 'tabasco',
                    'banana chilli', 'wax pepper', 'fresno', 'bullet', 'finger chilli'
                ],
                keywords: ['chilli', 'chili', 'chile', 'hot pepper', 'spicy'],
                reasoning: 'Chilli/hot pepper variety'
            },
            
            //  EGGPLANTS
            'EGGPLANTS': {
                products: [
                    'lebanese', 'japanese', 'thai', 'purple stripe', 'graffiti',
                    'white eggplant', 'indian', 'baby eggplant', 'globe', 'fairy tale',
                    'rosa bianca', 'sicilian', 'italian', 'slim', 'long purple',
                    'round', 'striped', 'aubergine', 'brinjal', 'pea eggplant'
                ],
                keywords: ['eggplant', 'aubergine', 'brinjal'],
                reasoning: 'Eggplant variety'
            },
            
            //  CUCUMBERS
            'CUCUMBERS': {
                products: [
                    'lebanese', 'continental', 'telegraph', 'mini', 'baby cucumber',
                    'persian', 'burpless', 'english', 'gherkin', 'pickle', 'pickling',
                    'qukes', 'snack cucumber', 'apple cucumber', 'crystal', 'japanese',
                    'telegraph', 'tele', 'long green', 'field cucumber'
                ],
                keywords: ['cucumber', 'cuke', 'cukes', 'gherkin'],
                reasoning: 'Cucumber variety'
            },
            
            //  BROCCOLI & CAULIFLOWER
            'BROCCOLI & CAULIFLOWER': {
                products: [
                    'broccolini', 'baby broccoli', 'tenderstem', 'romanesco',
                    'purple cauliflower', 'orange cauliflower', 'green cauliflower',
                    'caulilini', 'cauliflower florets', 'broccoli florets', 'broccoli head',
                    'chinese broccoli', 'broccoli rabe', 'rapini', 'sprouting broccoli',
                    'calabrese', 'crown broccoli'
                ],
                keywords: ['broccoli', 'cauliflower', 'broccolini'],
                reasoning: 'Broccoli or cauliflower variety'
            },
            
            //  BEANS & PEAS
            'BEANS & PEAS': {
                products: [
                    'green bean', 'flat bean', 'runner bean', 'broad bean', 'fava',
                    'butter bean', 'snake bean', 'yard long', 'long bean', 'borlotti',
                    'cannellini', 'kidney', 'lima', 'string bean', 'french bean',
                    'snow pea', 'sugar snap', 'snap pea', 'green pea', 'garden pea',
                    'split pea', 'mange tout', 'mangetout', 'stringless', 'wax bean'
                ],
                keywords: ['bean', 'beans', 'pea', 'peas', 'snap', 'snow'],
                reasoning: 'Bean or pea variety'
            },
            
            //  ASIAN VEGETABLES
            'ASIAN VEGETABLES': {
                products: [
                    'bok choy', 'pak choy', 'bok choi', 'pak choi', 'choy sum', 'gai lan',
                    'chinese broccoli', 'kai lan', 'wombok', 'napa', 'chinese cabbage',
                    'shanghai', 'baby bok', 'tatsoi', 'water spinach', 'kangkong',
                    'morning glory', 'ong choy', 'yu choy', 'mustard greens', 'gai choy',
                    'luffa', 'loofah', 'bitter melon', 'bitter gourd', 'karela',
                    'indian bittermelon', 'indian bitter melon', 'chinese bittermelon', 'chinese bitter melon',
                    'winter melon', 'wax gourd', 'fuzzy melon', 'mo qua', 'long melon', 'daikon',
                    'lotus root', 'galangal', 'taro', 'kohlrabi', 'water chestnut',
                    'bamboo shoot', 'bean sprout', 'mung bean', 'enoki', 'shimeji',
                    'burdock', 'gobo', 'chrysanthemum', 'perilla', 'shiso',
                    'snake gourd', 'snake guard', 'bottle gourd', 'ridge gourd', 'ivy gourd',
                    'pointed gourd', 'parwal', 'tindora', 'tinda', 'drumstick', 'moringa', 'moringa leaf',
                    'okra', 'lady finger', 'bhindi', 'gumbo',
                    'curry leaf', 'curry leaves', 'kari patta'
                ],
                keywords: ['asian', 'chinese', 'indian', 'oriental', 'bok', 'choy', 'choi', 'gourd', 'guard', 'okra', 'curry leaf'],
                reasoning: 'Asian vegetable'
            },
            
            //  ONIONS
            'ONIONS': {
                products: [
                    'brown onion', 'red onion', 'spanish onion', 'white onion',
                    'pickling onion', 'pearl onion', 'cipollini', 'boiling onion',
                    'spring onion', 'shallot', 'eschalot', 'scallion', 'green onion',
                    'leek', 'baby leek', 'welsh onion', 'bunching onion', 'vidalia',
                    'sweet onion', 'walla walla', 'maui', 'salad onion'
                ],
                keywords: ['onion', 'shallot', 'eschalot', 'scallion', 'leek'],
                reasoning: 'Onion variety'
            },
            
            //  GARLIC
            'GARLIC': {
                products: [
                    'fresh garlic', 'peeled garlic', 'organic garlic', 'elephant garlic',
                    'black garlic', 'garlic chives', 'garlic scape', 'green garlic',
                    'solo garlic', 'single clove', 'hardneck', 'softneck', 'rocambole',
                    'purple stripe garlic', 'creole garlic', 'silverskin'
                ],
                keywords: ['garlic'],
                reasoning: 'Garlic product'
            },
            
            //  PUMPKINS
            'PUMPKINS': {
                products: [
                    'butternut', 'grey pumpkin', 'white pumpkin', 'queensland blue',
                    'kent', 'jap', 'kabocha', 'crown pumpkin', 'golden nugget',
                    'acorn', 'delicata', 'spaghetti', 'gem squash', 'hubbard',
                    'turban', 'banana squash', 'carnival', 'dumpling', 'red kuri',
                    'blue hubbard', 'buttercup', 'jarrahdale', 'musquee', 'honeynut'
                ],
                keywords: ['pumpkin', 'squash'],
                reasoning: 'Pumpkin or squash variety'
            },
            
            //  ROOT VEGETABLES
            'ROOT VEGETABLES': {
                products: [
                    'carrot', 'baby carrot', 'dutch carrot', 'heirloom carrot', 'rainbow carrot',
                    'parsnip', 'turnip', 'swede', 'rutabaga',
                    'beetroot', 'beet', 'baby beetroot', 'golden beetroot', 'candy beetroot', 'chioggia',
                    'radish', 'red radish', 'french radish', 'watermelon radish', 'black radish',
                    'horseradish', 'wasabi',
                    'sweet potato', 'gold sweet potato', 'white sweet potato', 'purple sweet potato',
                    'potato', 'kipfler', 'sebago', 'desiree', 'pontiac', 'coliban', 'dutch cream',
                    'nicola', 'pink eye', 'royal blue', 'chat potato', 'new potato', 'fingerling',
                    'yam', 'cassava', 'yuca', 'jicama', 'sunchoke', 'jerusalem artichoke'
                ],
                keywords: ['root', 'potato', 'carrot', 'beet', 'turnip', 'parsnip'],
                reasoning: 'Root vegetable'
            },
            
            //  HERBS
            'HERBS': {
                products: [
                    'basil', 'sweet basil', 'thai basil', 'holy basil', 'lemon basil',
                    'mint', 'spearmint', 'peppermint', 'vietnamese mint', 'chocolate mint',
                    'coriander', 'cilantro', 'culantro', 'sawtooth',
                    'parsley', 'flat parsley', 'curly parsley', 'italian parsley',
                    'dill', 'chives', 'garlic chives',
                    'rosemary', 'thyme', 'lemon thyme', 'oregano', 'sage', 'marjoram',
                    'bay leaves', 'bay leaf', 'curry leaf', 'kaffir lime', 'makrut',
                    'lemongrass', 'tarragon', 'chervil', 'lovage', 'savory', 'epazote',
                    'shiso', 'perilla', 'sorrel', 'borage', 'hyssop', 'lavender',
                    'chamomile', 'stevia', 'fennel fronds', 'dill weed'
                ],
                keywords: ['herb', 'basil', 'mint', 'parsley', 'coriander', 'thyme', 'rosemary'],
                reasoning: 'Herb variety'
            },
            
            //  MUSHROOMS
            'MUSHROOMS': {
                products: [
                    'button', 'cup', 'flat', 'swiss brown', 'cremini', 'cremini',
                    'portobello', 'portabella', 'portobella',
                    'shiitake', 'oyster', 'king oyster', 'king trumpet', 'eryngii',
                    'enoki', 'enokitake', 'shimeji', 'bunashimeji', 'wood ear',
                    'maitake', 'hen of the woods', 'chanterelle', 'porcini', 'cep',
                    'morel', 'truffle', 'black truffle', 'white truffle',
                    "lion's mane", 'hedgehog', 'puffball', 'chestnut', 'nameko',
                    'mixed mushroom', 'exotic mushroom', 'field mushroom'
                ],
                keywords: ['mushroom', 'fungi', 'shroom'],
                reasoning: 'Mushroom variety'
            },
            
            //  ZUCCHINI
            'ZUCCHINI': {
                products: [
                    'green zucchini', 'yellow zucchini', 'baby zucchini', 'tromboncino',
                    'pattypan', 'patty pan', 'scallop', 'round zucchini', 'ronde de nice',
                    'cousa', 'costata romanesco', 'zephyr', 'eight ball',
                    'squash blossom', 'zucchini flower', 'courgette'
                ],
                keywords: ['zucchini', 'courgette', 'marrow'],
                reasoning: 'Zucchini variety'
            },
            
            //  SPECIALITY VEGETABLES
            'SPECIALITY VEGETABLES': {
                products: [
                    'artichoke', 'globe artichoke', 'baby artichoke',
                    'asparagus', 'white asparagus', 'purple asparagus', 'wild asparagus',
                    'fennel', 'florence fennel', 'anise', 'finocchio',
                    'celery', 'celery heart', 'celeriac', 'celery root',
                    'cardoon', 'rhubarb', 'fiddlehead', 'hearts of palm',
                    'nopal', 'cactus paddle', 'sea bean', 'samphire', 'sea asparagus'
                ],
                keywords: ['specialty', 'artichoke', 'asparagus', 'fennel', 'celery'],
                reasoning: 'Specialty vegetable'
            },
            
            //  CITRUS
            'CITRUS': {
                products: [
                    'lemon', 'meyer lemon', 'eureka lemon', 'lisbon',
                    'lime', 'tahitian lime', 'kaffir lime', 'key lime', 'finger lime',
                    'orange', 'navel', 'valencia', 'blood orange', 'cara cara',
                    'mandarin', 'imperial', 'murcott', 'clementine', 'satsuma', 'tangerine',
                    'grapefruit', 'ruby grapefruit', 'pink grapefruit', 'pomelo',
                    'tangelo', 'minneola', 'kumquat', 'yuzu', 'sudachi', 'bergamot',
                    'citron', 'buddha hand', "buddha's hand", 'ugli fruit'
                ],
                keywords: ['citrus', 'lemon', 'lime', 'orange', 'mandarin', 'grapefruit'],
                reasoning: 'Citrus fruit'
            },
            
            //  EGGS
            'EGGS': {
                products: [
                    'chicken egg', 'duck egg', 'quail egg', 'free range', 'organic egg',
                    'cage free', 'barn laid', 'pastured', 'omega-3', 'jumbo', 'xl eggs',
                    '600g', '700g', '800g', '55g', '60g', '65g', '70g', 'dozen'
                ],
                keywords: ['egg', 'eggs'],
                reasoning: 'Egg product'
            },
            
            //  MELONS
            'MELONS': {
                products: [
                    'watermelon', 'seedless watermelon', 'mini watermelon', 'yellow watermelon',
                    'rockmelon', 'cantaloupe', 'honeydew', 'galia', 'charentais',
                    'piel de sapo', 'santa claus', 'korean melon', 'canary melon',
                    'crenshaw', 'casaba', 'hami', 'sprite melon', 'sugar kiss',
                    'orange flesh', 'green flesh'
                ],
                keywords: ['melon', 'watermelon', 'rockmelon', 'honeydew', 'cantaloupe'],
                reasoning: 'Melon variety'
            },
            
            //  CABBAGE & BRASSICAS
            'CABBAGE & BRASSICAS': {
                products: [
                    'green cabbage', 'red cabbage', 'purple cabbage', 'savoy cabbage',
                    'sugarloaf', 'pointed cabbage', 'sweetheart', 'hispi',
                    'brussels sprout', 'brussels', 'sprouts',
                    'kohlrabi', 'kohl rabi'
                ],
                keywords: ['cabbage', 'brussels', 'sprout', 'brassica'],
                reasoning: 'Cabbage or brassica variety'
            },
            
            //  FRUITS (General)
            'FRUITS': {
                products: [
                    // Stone fruits
                    'peach', 'nectarine', 'plum', 'apricot', 'cherry', 'cherries',
                    // Tropical
                    'mango', 'papaya', 'pawpaw', 'pineapple', 'passionfruit', 'passion fruit',
                    'lychee', 'longan', 'rambutan', 'dragonfruit', 'dragon fruit', 'pitaya',
                    'durian', 'jackfruit', 'star fruit', 'starfruit', 'carambola',
                    'guava', 'feijoa', 'tamarillo', 'persimmon', 'cherimoya',
                    // Other
                    'banana', 'plantain', 'coconut', 'pomegranate', 'fig', 'date',
                    'kiwi', 'kiwifruit', 'grape', 'grapes'
                ],
                keywords: ['fruit', 'tropical'],
                reasoning: 'Fruit variety'
            },

            //  BERRIES
            'BERRIES': {
                products: [
                    'strawberry', 'strawberries', 'blueberry', 'blueberries',
                    'raspberry', 'raspberries', 'blackberry', 'blackberries',
                    'mulberry', 'mulberries', 'boysenberry', 'boysenberries',
                    'loganberry', 'loganberries', 'gooseberry', 'gooseberries',
                    'cranberry', 'cranberries', 'currant', 'currants',
                    'red currant', 'black currant', 'white currant',
                    'aa', 'acai', 'goji', 'goji berry', 'elderberry',
                    'lingonberry', 'bilberry', 'huckleberry', 'marionberry'
                ],
                keywords: ['berry', 'berries'],
                reasoning: 'Berry variety'
            }
        };
        
        // Common misspellings and variations mapping
        const SPELLING_CORRECTIONS = {
            'capsicam': 'capsicum', 'capsicm': 'capsicum', 'capiscum': 'capsicum',
            'tomatoe': 'tomato', 'tomatos': 'tomato', 'tomateos': 'tomato',
            'letuce': 'lettuce', 'lettice': 'lettuce', 'lattuce': 'lettuce',
            'icburg': 'iceberg', 'icberg': 'iceberg', 'icebarg': 'iceberg',
            'brocoli': 'broccoli', 'brocolli': 'broccoli', 'broccolli': 'broccoli',
            'califlower': 'cauliflower', 'cauliflour': 'cauliflower', 'couliflower': 'cauliflower',
            'zuchini': 'zucchini', 'zuchinni': 'zucchini', 'zuccini': 'zucchini',
            'eggplnt': 'eggplant', 'eggplat': 'eggplant', 'eggplnt': 'eggplant',
            'cucmber': 'cucumber', 'cucumer': 'cucumber', 'cucmumber': 'cucumber',
            'mushrrom': 'mushroom', 'mushrom': 'mushroom', 'mushrooom': 'mushroom',
            'spinich': 'spinach', 'spinnach': 'spinach', 'spinash': 'spinach',
            'aspargus': 'asparagus', 'aspargaus': 'asparagus', 'asperagus': 'asparagus',
            'aubergene': 'aubergine', 'aubergeen': 'aubergine',
            'coriender': 'coriander', 'corriander': 'coriander',
            'parsely': 'parsley', 'parsly': 'parsley',
            'shallott': 'shallot', 'shalot': 'shallot',
            'potatoe': 'potato', 'potatos': 'potato',
            'beens': 'beans', 'beanes': 'beans',
            'chille': 'chilli', 'chillie': 'chilli', 'chily': 'chilli',
            'jalepeno': 'jalapeno', 'jalapenio': 'jalapeno', 'jallepeno': 'jalapeno',
            'bokchoy': 'bok choy', 'bokchoi': 'bok choy', 'bok choi': 'bok choy',
            'galran': 'gai lan', 'gailan': 'gai lan', 'gai larn': 'gai lan',
            'wom bok': 'wombok', 'wong bok': 'wombok'
        };
        
        // Calculate string similarity (Levenshtein distance)
        function stringSimilarity(s1, s2) {
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;
            
            if (longer.length === 0) return 1.0;
            
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) {
                        costs[j] = j;
                    } else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        }
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            
            return (longer.length - costs[s2.length]) / longer.length;
        }
        
        // Smart category matching with comprehensive knowledge base
        function smartCategoryMatch(productName, existingCategories) {
            let name = productName.toLowerCase().trim();
            
            // Step 1: Apply spelling corrections
            for (const [misspelled, correct] of Object.entries(SPELLING_CORRECTIONS)) {
                if (name.includes(misspelled)) {
                    name = name.replace(misspelled, correct);
                }
            }
            
            const nameUpper = name.toUpperCase();
            let bestMatch = null;
            let bestScore = 0;
            let bestReasoning = '';
            let isExactMatch = false;
            
            // Step 2: Search through the produce database
            for (const [category, data] of Object.entries(PRODUCE_DATABASE)) {
                // Check individual products (these are EXACT identifiers)
                for (const product of data.products) {
                    const productLower = product.toLowerCase();
                    
                    // Exact match in name
                    if (name.includes(productLower) || productLower.includes(name)) {
                        const matchLength = productLower.length;
                        const score = matchLength * 15; // Higher weight for product matches
                        
                        if (score > bestScore) {
                            bestScore = score;
                            bestMatch = category;
                            bestReasoning = `"${product}" is a ${data.reasoning.toLowerCase()}`;
                            isExactMatch = true;
                        }
                    }
                    
                    // Fuzzy match for typos
                    const similarity = stringSimilarity(name, productLower);
                    if (similarity > 0.75) { // 75%+ similarity
                        const score = similarity * 100;
                        if (score > bestScore && !isExactMatch) {
                            bestScore = score;
                            bestMatch = category;
                            bestReasoning = `Similar to "${product}" - ${data.reasoning.toLowerCase()}`;
                        }
                    }
                }
                
                // Check keywords as fallback
                for (const keyword of data.keywords) {
                    if (name.includes(keyword.toLowerCase())) {
                        const score = keyword.length * 8;
                        if (score > bestScore && !isExactMatch) {
                            bestScore = score;
                            bestMatch = category;
                            bestReasoning = data.reasoning;
                        }
                    }
                }
            }
            
            // Step 3: If we found a match, check if category exists
            if (bestMatch) {
                // Try to find an existing category that matches (strict matching)
                const existingMatch = existingCategories.find(cat => {
                    const catLower = cat.toLowerCase();
                    const matchLower = bestMatch.toLowerCase();
                    // Exact match only, or first word matches exactly
                    return catLower === matchLower ||
                           catLower.split(' ')[0] === matchLower.split(' ')[0];
                });
                
                // Determine confidence
                let confidence = 'high';
                if (bestScore < 50) confidence = 'low';
                else if (bestScore < 80) confidence = 'medium';
                
                if (existingMatch) {
                    return {
                        category: existingMatch, // Use exact existing category name
                        isNew: false,
                        confidence: confidence,
                        reasoning: bestReasoning
                    };
                } else {
                    return {
                        category: bestMatch,
                        isNew: true,
                        confidence: confidence,
                        reasoning: bestReasoning
                    };
                }
            }
            
            // Step 4: No match found - try to create a sensible category
            const words = name.split(' ').filter(w => w.length > 2);
            const mainWord = words[0] || name;
            const newCategory = mainWord.toUpperCase() + (mainWord.endsWith('S') ? '' : 'S');
            
            return {
                category: newCategory,
                isNew: true,
                confidence: 'low',
                reasoning: `No known category match - creating new category for "${productName}"`
            };
        }


        function confirmSmartAdd() {
            const productName = document.getElementById('smartProductName').value.trim();
            const grade = document.getElementById('smartProductGrade').value.trim() || '-';
            let price = document.getElementById('smartProductPrice').value.trim();

            if (!productName) {
                alert('Please enter a product name');
                return;
            }

            // Format price
            if (price && !price.startsWith('$')) {
                price = '$' + price;
            }
            if (!price) {
                price = '$0';
            }

            // Use suggested category or create default
            const category = suggestedCategory || 'OTHER';

            // Create category if doesn't exist
            if (!priceData[category]) {
                priceData[category] = [];
            }

            // Add product (with empty cost field)
            priceData[category].push([productName, grade, price, '']);

            // Save and re-render
            saveToLocal(false); // No toast notification
            renderCategories();
            closeSmartAdd();
        }

        // Delete category
        function deleteCategory(categoryName) {
            if (confirm(`Delete category "${categoryName}"?`)) {
                collectData(); // Save current changes first
                delete priceData[categoryName];
                delete categoryMargins[categoryName]; // Also delete margin setting
                saveToLocal(false); // No toast notification
                renderCategories();
            }
        }

        // Rename category
        function renameCategory(oldName, newName) {
            if (newName && newName.trim() && newName !== oldName) {
                collectData(); // Save current changes first
                priceData[newName.trim().toUpperCase()] = priceData[oldName];
                delete priceData[oldName];
                // Transfer margin setting to new category name
                if (categoryMargins[oldName]) {
                    categoryMargins[newName.trim().toUpperCase()] = categoryMargins[oldName];
                    delete categoryMargins[oldName];
                }
                saveToLocal(false); // No toast notification
                renderCategories();
            }
        }

        // Helper: Truncate text with ellipsis if it exceeds max width
        // Ensure price has $ symbol
        function formatPriceWithSymbol(price) {
            if (!price) return '';
            let p = price.toString().trim();
            // If it's a number or starts with a number, add $
            if (p && !p.startsWith('$') && /^\d/.test(p)) {
                p = '$' + p;
            }
            return p;
        }

        // Format product name with Title Case (capitalize first letter of each word)
        function formatProductName(text) {
            if (!text || text === 'New Product') return text;
            let t = text.toString().trim();

            // Split by spaces and capitalize each word
            return t.split(' ').map(word => {
                if (word.length === 0) return word;
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
        }

        // Format grade/size field with proper capitalization
        function formatGradeSize(text) {
            if (!text || text === '-') return text;
            let t = text.toString().trim();

            // Units that should be lowercase
            const lowercaseUnits = ['kg', 'g', 'ml', 'l', 'lb', 'oz'];
            // Words that should be lowercase
            const lowercaseWords = ['per', 'each', 'box', 'tray', 'bunch', 'punnet', 'pack', 'bag', 'case', 'crate', 'carton', 'pallet', 'head', 'piece'];
            // Words that should be capitalized (first letter)
            const capitalizeWords = ['small', 'medium', 'large', 'premium', 'standard', 'extra', 'baby', 'mini', 'jumbo', 'xl', 'no'];

            // First, normalize the text
            t = t.replace(/\s+/g, ' '); // Multiple spaces to single

            // Handle number+unit patterns (e.g., "5KG"  "5kg", "10 KG"  "10kg")
            t = t.replace(/(\d+)\s*(kg|g|ml|l|lb|oz)/gi, (match, num, unit) => {
                return num + unit.toLowerCase();
            });

            // Handle "per X" patterns
            t = t.replace(/\bper\s+(\w+)/gi, (match, word) => {
                return 'per ' + word.toLowerCase();
            });

            // Process each word
            const words = t.split(' ');
            const formatted = words.map(word => {
                const wordLower = word.toLowerCase();

                // Check if it's a number+unit combo (already handled above)
                if (/^\d+\w+$/.test(word)) {
                    return word.toLowerCase();
                }

                // Check lowercase words
                if (lowercaseWords.includes(wordLower)) {
                    return wordLower;
                }

                // Check units
                if (lowercaseUnits.includes(wordLower)) {
                    return wordLower;
                }

                // Check words to capitalize
                if (capitalizeWords.includes(wordLower)) {
                    return wordLower.charAt(0).toUpperCase() + wordLower.slice(1);
                }

                // Handle "No.X" pattern (e.g., "NO.1"  "No.1")
                if (/^no\.?\d/i.test(word)) {
                    return 'No.' + word.replace(/^no\.?/i, '');
                }

                // Default: capitalize first letter
                if (word.length > 0) {
                    return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                }

                return word;
            });

            return formatted.join(' ');
        }

        function truncateText(ctx, text, maxWidth) {
            if (!text) return '';
            text = text.toString();

            // Check if text fits
            if (ctx.measureText(text).width <= maxWidth) {
                return text;
            }

            // Binary search for the right truncation point
            let truncated = text;
            const ellipsis = '...';
            const ellipsisWidth = ctx.measureText(ellipsis).width;
            const targetWidth = maxWidth - ellipsisWidth;

            // Start removing characters from the end
            while (truncated.length > 0 && ctx.measureText(truncated).width > targetWidth) {
                truncated = truncated.slice(0, -1);
            }

            return truncated.length > 0 ? truncated + ellipsis : text.charAt(0) + ellipsis;
        }

        // Helper: Get Sydney timezone date
        function getSydneyDate() {
            const date = new Date();
            // Create a date string in Sydney timezone
            const sydneyTime = new Date(date.toLocaleString('en-US', { timeZone: 'Australia/Sydney' }));
            return sydneyTime;
        }

        // Download as image
        function downloadImage() {
            console.log('Starting image generation...');
            collectData();
            
            // Validate: Check for empty prices
            let hasEmptyPrices = false;
            let emptyPriceProducts = [];
            
            for (const categoryName in priceData) {
                const items = priceData[categoryName];
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const price = (item[2] || '').toString().trim();
                    
                    if (price === '') {
                        hasEmptyPrices = true;
                        emptyPriceProducts.push(`${categoryName}: ${item[0]}`);
                    }
                }
            }
            
            // Show error if empty prices found - smart notification for many errors
            if (hasEmptyPrices) {
                let errorMessage;
                if (emptyPriceProducts.length > 5) {
                    // Smart summary for many empty prices
                    const firstFive = emptyPriceProducts.slice(0, 5).join('\n- ');
                    const remaining = emptyPriceProducts.length - 5;
                    errorMessage = `ERROR: Cannot generate image!\n\n${emptyPriceProducts.length} products have empty prices:\n\n- ${firstFive}\n\n...and ${remaining} more.\n\nPlease fill in all prices or mark as "NA" if not available.`;
                } else {
                    // Show full list for 5 or fewer
                    const productList = emptyPriceProducts.join('\n- ');
                    errorMessage = `ERROR: Cannot generate image!\n\nThe following products have empty prices:\n\n- ${productList}\n\nPlease fill in all prices or mark as "NA" if not available.`;
                }
                alert(errorMessage);
                return; // Stop here, don't generate image
            }
            
            const loading = document.getElementById('loading');
            loading.classList.add('show');

            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
                try {
                    console.log('Creating canvas...');
                    const canvas = document.getElementById('downloadCanvas');
                    const ctx = canvas.getContext('2d');

                    // Calculate height
                    let totalRows = 0;
                    Object.values(priceData).forEach(items => totalRows += items.length);
                    const categoryCount = Object.keys(priceData).length;
                    
                    // Ultra HD - 3x resolution (3600px width)
                    canvas.width = 3600;
                    const estimatedHeight = 1200 + (categoryCount * 300) + (totalRows * 135) + 600;
                    canvas.height = estimatedHeight;
                    
                    console.log(`Canvas size: ${canvas.width}x${canvas.height} (Ultra HD 3x)`);

                    // White background
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    let y = 120;
                    const margin = 180;

                    // Header background - Barely green-white
                    ctx.fillStyle = '#fafdf7';
                    const headerHeight = (salesmanInfo.name || salesmanInfo.phone) ? 840 : 720;
                    ctx.fillRect(0, 0, canvas.width, headerHeight);

                    // Company name - Forest green
                    ctx.fillStyle = '#2d6a4f';
                    ctx.font = 'bold 168px Arial, Helvetica, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('EVERFRESH PRODUCE GROUP', canvas.width / 2, y + 150);
                    y += 240;

                    // Title - Fresh green
                    ctx.fillStyle = '#52b788';
                    ctx.font = 'bold 144px Arial, Helvetica, sans-serif';
                    ctx.fillText('WHOLESALE PRICE LIST', canvas.width / 2, y + 120);
                    y += 210;

                    // Address and Date
                    const leftCol = 300;
                    const rightCol = canvas.width - 300;

                    ctx.textAlign = 'left';
                    ctx.fillStyle = '#2d6a4f';
                    ctx.font = 'bold 66px Arial, Helvetica, sans-serif';
                    ctx.fillText('Stand 275, Shed C, Sydney Markets', leftCol, y + 60);
                    
                    ctx.textAlign = 'right';
                    const effectiveDate = getEffectiveDate();
                    const formattedDate = effectiveDate.toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
                    ctx.fillText('Effective: ' + formattedDate, rightCol, y + 60);
                    y += 150;

                    // Contact box - Very light green
                    if (salesmanInfo.name || salesmanInfo.phone) {
                        ctx.fillStyle = '#d8f3dc';
                        ctx.fillRect(leftCol - 60, y - 30, canvas.width - 480, 150);
                        ctx.strokeStyle = '#52b788';
                        ctx.lineWidth = 6;
                        ctx.strokeRect(leftCol - 60, y - 30, canvas.width - 480, 150);
                        
                        ctx.textAlign = 'left';
                        ctx.fillStyle = '#1b4332';
                        ctx.font = 'bold 72px Arial, Helvetica, sans-serif';
                        
                        if (salesmanInfo.name && salesmanInfo.phone) {
                            ctx.fillText('Sales Contact: ' + salesmanInfo.name, leftCol, y + 60);
                            ctx.textAlign = 'right';
                            ctx.fillText(salesmanInfo.phone, rightCol, y + 60);
                        } else if (salesmanInfo.name) {
                            ctx.fillText('Sales Contact: ' + salesmanInfo.name, leftCol, y + 60);
                        } else {
                            ctx.fillText('Sales Contact: ' + salesmanInfo.phone, leftCol, y + 60);
                        }
                        y += 195;
                    } else {
                        y += 45;
                    }

                    // Separator - Fresh green
                    ctx.strokeStyle = '#b7e4c7';
                    ctx.lineWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(margin, y);
                    ctx.lineTo(canvas.width - margin, y);
                    ctx.stroke();
                    y += 90;

                    // Table setup
                    ctx.textAlign = 'left';
                    const tableWidth = canvas.width - 2 * margin;
                    const col1 = margin;
                    const col2 = margin + tableWidth * 0.45;
                    const col3 = margin + tableWidth * 0.80;
                    const rowHeight = 126;

                    console.log('Drawing categories...');
                    
                    // Draw each category
                    for (const categoryName in priceData) {
                        const items = priceData[categoryName];
                        
                        // Filter out items with NA/Not Available price (case-insensitive, handles symbols)
                        const availableItems = items.filter(item => {
                            const price = (item[2] || '').toString().trim();
                            
                            // Empty prices already validated, so won't reach here
                            // But keep this check for safety
                            if (price === '') return false;
                            
                            // Remove all symbols and spaces, then check
                            const cleanedPrice = price.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                            
                            // Filter out ONLY if it's "na" or "notavailable"
                            return cleanedPrice !== 'na' && cleanedPrice !== 'notavailable';
                        });
                        
                        // Skip this category if no available items
                        if (availableItems.length === 0) {
                            console.log(`Skipping category "${categoryName}" - all products NA`);
                            continue;
                        }

                        // Category header - Medium green
                        ctx.fillStyle = '#40916c';
                        ctx.fillRect(margin, y, tableWidth, 150);
                        ctx.strokeStyle = '#2d6a4f';
                        ctx.lineWidth = 6;
                        ctx.strokeRect(margin, y, tableWidth, 150);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 102px Arial, Helvetica, sans-serif';
                        ctx.fillText(categoryName, col1 + 60, y + 108);
                        y += 150;

                        // Column headers - Light green
                        ctx.fillStyle = '#74c69d';
                        ctx.fillRect(margin, y, tableWidth, rowHeight);
                        ctx.strokeRect(margin, y, tableWidth, rowHeight);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 78px Arial, Helvetica, sans-serif';
                        ctx.fillText('Product', col1 + 60, y + 84);
                        ctx.fillText('Grade/Size', col2 + 60, y + 84);
                        ctx.fillText('Price', col3 + 60, y + 84);
                        
                        // Vertical lines
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 6;
                        ctx.beginPath();
                        ctx.moveTo(col2, y);
                        ctx.lineTo(col2, y + rowHeight);
                        ctx.moveTo(col3, y);
                        ctx.lineTo(col3, y + rowHeight);
                        ctx.stroke();
                        y += rowHeight;

                        // Draw only available items
                        for (let i = 0; i < availableItems.length; i++) {
                            const item = availableItems[i];
                            
                            // Background - Very subtle alternating
                            ctx.fillStyle = i % 2 === 1 ? '#f1faee' : '#ffffff';
                            ctx.fillRect(margin, y, tableWidth, rowHeight);
                            
                            // Borders - Soft green-gray
                            ctx.strokeStyle = '#d8f3dc';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(margin, y, tableWidth, rowHeight);
                            ctx.beginPath();
                            ctx.moveTo(col2, y);
                            ctx.lineTo(col2, y + rowHeight);
                            ctx.moveTo(col3, y);
                            ctx.lineTo(col3, y + rowHeight);
                            ctx.stroke();

                            // Calculate column widths for text truncation (with padding)
                            const productMaxWidth = col2 - col1 - 90;  // 60px left padding + 30px right padding
                            const gradeMaxWidth = col3 - col2 - 90;
                            const priceMaxWidth = (margin + tableWidth) - col3 - 90;

                            // Text - Dark for readability (with truncation to prevent overflow)
                            ctx.fillStyle = '#212529';
                            ctx.font = '72px Arial, Helvetica, sans-serif';
                            ctx.fillText(truncateText(ctx, item[0], productMaxWidth), col1 + 60, y + 84);
                            ctx.fillText(truncateText(ctx, item[1], gradeMaxWidth), col2 + 60, y + 84);

                            // Price - Deep forest green (with truncation)
                            ctx.fillStyle = '#1b4332';
                            ctx.font = 'bold 78px Arial, Helvetica, sans-serif';
                            ctx.fillText(truncateText(ctx, formatPriceWithSymbol(item[2]), priceMaxWidth), col3 + 60, y + 84);
                            
                            y += rowHeight;
                        }
                        y += 75;
                    }

                    // Notes
                    y += 45;
                    ctx.fillStyle = '#2d6a4f';
                    ctx.font = 'bold 96px Arial, Helvetica, sans-serif';
                    ctx.fillText('NOTES:', margin, y + 90);
                    y += 150;

                    ctx.fillStyle = '#495057';
                    ctx.font = '60px Arial, Helvetica, sans-serif';
                    const notes = [
                        ' All prices are wholesale rates',
                        ' Prices subject to availability and market conditions',
                        ' Quality guaranteed - fresh daily from Sydney Markets',
                        ' Contact us for bulk pricing and special requests'
                    ];
                    notes.forEach(note => {
                        ctx.fillText(note, margin + 60, y + 66);
                        y += 96;
                    });

                    console.log('Converting to blob...');
                    
                    // Download
                    canvas.toBlob(function(blob) {
                        if (!blob) {
                            console.error('Failed to create blob');
                            alert('Failed to generate image. Please try again.');
                            loading.classList.remove('show');
                            return;
                        }
                        
                        console.log('Downloading...');
                        const url = URL.createObjectURL(blob);
                        
                        // Store for sharing
                        if (lastGeneratedImageUrl) {
                            URL.revokeObjectURL(lastGeneratedImageUrl);
                        }
                        lastGeneratedImageUrl = url;
                        
                        const a = document.createElement('a');
                        a.href = url;
                        const dateStr = new Date().toISOString().split('T')[0];
                        const filename = 'everfresh-price-list-' + dateStr + '.png';
                        a.download = filename;
                        a.type = 'image/png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        console.log('Download complete!');
                        loading.classList.remove('show');
                    }, 'image/png');
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error generating image: ' + error.message);
                    loading.classList.remove('show');
                }
            });
        }

        // Quick share on WhatsApp
        async function quickShareWhatsApp() {
            collectData();
            
            // Check for empty prices
            let hasEmptyPrices = false;
            for (const categoryName in priceData) {
                const items = priceData[categoryName];
                for (let i = 0; i < items.length; i++) {
                    const price = (items[i][2] || '').toString().trim();
                    if (price === '') {
                        hasEmptyPrices = true;
                        break;
                    }
                }
                if (hasEmptyPrices) break;
            }
            
            if (hasEmptyPrices) {
                alert('Please fill in all prices or mark as "NA" before sharing.');
                return;
            }
            
            const loading = document.getElementById('loading');
            loading.classList.add('show');
            
            try {
                // Generate image blob
                const blob = await generateImageBlob();
                
                if (!blob) {
                    throw new Error('Failed to generate image');
                }
                
                // Create message with variables (respects toggle setting)
                const effectiveDate = getEffectiveDate();
                const formattedDate = effectiveDate.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const yourName = salesmanInfo.name || 'Everfresh Team';
                const message = `Hi! ${yourName} here from Everfresh  Fresh prices for ${formattedDate} - give me a call or text for your order! Thank you.`;
                
                // Check if Web Share API is available (iOS/modern browsers)
                if (navigator.share && navigator.canShare) {
                    const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'Everfresh Price List',
                            text: message,
                            files: [file]
                        });
                        loading.classList.remove('show');
                        return;
                    }
                }
                
                // Fallback: Download image
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                a.download = 'everfresh-price-list-' + dateStr + '.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                loading.classList.remove('show');
                alert('Image downloaded! Please open WhatsApp and share the image from your Photos/Files.');
                
            } catch (error) {
                loading.classList.remove('show');
                if (error.name !== 'AbortError') {
                    console.error('Share error:', error);
                    alert('Error sharing: ' + error.message);
                }
            }
        }

        // ========================================
        // SHARE MENU FUNCTIONS
        // ========================================

        // Show share menu modal
        function showShareMenu() {
            collectData();

            // Check for empty prices first
            let emptyPriceProducts = [];
            for (const categoryName in priceData) {
                const items = priceData[categoryName];
                for (let i = 0; i < items.length; i++) {
                    const price = (items[i][2] || '').toString().trim();
                    if (price === '') {
                        emptyPriceProducts.push(`${categoryName}: ${items[i][0]}`);
                    }
                }
            }

            if (emptyPriceProducts.length > 0) {
                if (emptyPriceProducts.length > 5) {
                    alert(`Cannot share: ${emptyPriceProducts.length} products have empty prices.\n\n` +
                          `First 5:\n- ${emptyPriceProducts.slice(0, 5).join('\n- ')}\n\n` +
                          `...and ${emptyPriceProducts.length - 5} more.\n\n` +
                          `Please fill all prices or mark as "NA".`);
                } else {
                    alert(`Cannot share: ${emptyPriceProducts.length} products have empty prices:\n\n` +
                          `- ${emptyPriceProducts.join('\n- ')}\n\n` +
                          `Please fill all prices or mark as "NA".`);
                }
                return;
            }

            document.getElementById('shareMenu').classList.add('show');
            document.body.classList.add('modal-open');
        }

        // Close share menu modal
        function closeShareMenu() {
            document.getElementById('shareMenu').classList.remove('show');
            document.getElementById('shortcutSetupInfo').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        // Download blob as file
        function downloadBlob(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = 'everfresh-price-list-' + dateStr + '.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Detect iOS device
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        }

        // Copy image blob to clipboard (works on Chrome desktop/Android)
        async function copyImageToClipboard(blob) {
            try {
                // Check if ClipboardItem is available
                if (typeof ClipboardItem === 'undefined') {
                    console.log('ClipboardItem not supported in this browser');
                    return { success: false, error: 'ClipboardItem not supported' };
                }

                // Check if clipboard API is available
                if (!navigator.clipboard || !navigator.clipboard.write) {
                    console.log('Clipboard API not available');
                    return { success: false, error: 'Clipboard API not available' };
                }

                // Create clipboard item and write
                const item = new ClipboardItem({ 'image/png': blob });
                await navigator.clipboard.write([item]);
                console.log('Clipboard write successful!');
                return { success: true };

            } catch (error) {
                console.error('Clipboard write failed:', error);

                // On iOS, clipboard for images often fails - this is expected
                if (isIOS()) {
                    console.log('iOS detected - clipboard image write not supported');
                }

                return { success: false, error: error.message };
            }
        }

        // Generate share message
        function generateShareMessage() {
            const effectiveDate = getEffectiveDate();
            const formattedDate = effectiveDate.toLocaleDateString('en-AU', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const yourName = salesmanInfo.name || 'Everfresh Team';
            return `Hi! ${yourName} here from Everfresh  Fresh prices for ${formattedDate} - give me a call or text for your order! Thank you.`;
        }

        // Share via iMessage (iOS Shortcut or Web Share)
        async function shareViaIMessage() {
            closeShareMenu();

            const loading = document.getElementById('loading');
            loading.classList.add('show');

            try {
                // Generate image blob
                const blob = await generateImageBlob();

                if (!blob) {
                    throw new Error('Failed to generate image');
                }

                // Generate message
                const message = generateShareMessage();

                // On iOS, save to Photos then trigger shortcut for automation
                if (isIOS()) {
                    loading.classList.remove('show');

                    if (navigator.share && navigator.canShare) {
                        const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });

                        if (navigator.canShare({ files: [file] })) {
                            // Step 1: Save image to Photos
                            alert(' Step 1: Tap "Save Image" to save to Photos');

                            try {
                                await navigator.share({
                                    files: [file]
                                });
                            } catch (shareError) {
                                if (shareError.name === 'AbortError') {
                                    return; // User cancelled
                                }
                            }

                            // Step 2: Trigger shortcut - pass ASK,message so shortcut asks for contact
                            const shortcutInput = `ASK,${message}`;
                            const shortcutUrl = `shortcuts://run-shortcut?name=Everfresh%20Pricelist&input=text&text=${encodeURIComponent(shortcutInput)}`;
                            window.location.href = shortcutUrl;
                            return;
                        }
                    }

                    // Fallback: download
                    alert('Share not available. Downloading image instead.');
                    downloadBlob(blob);
                    return;
                }

                // NON-iOS: Try clipboard + shortcut method (works on Chrome desktop/Android)
                const clipboardResult = await copyImageToClipboard(blob);

                loading.classList.remove('show');

                if (clipboardResult.success) {
                    // Create shortcut URL
                    const shortcutUrl = `shortcuts://run-shortcut?name=Everfresh%20Pricelist&input=text&text=${encodeURIComponent(message)}`;

                    // Show instructions and trigger shortcut
                    const userConfirm = confirm(
                        ' Image copied to clipboard!\n\n' +
                        'The Everfresh Pricelist shortcut will open.\n' +
                        'It will send the image via iMessage.\n\n' +
                        'Tap OK to continue.'
                    );

                    if (userConfirm) {
                        // Track if user returns quickly (shortcut not installed)
                        const startTime = Date.now();

                        // Trigger the shortcut
                        window.location.href = shortcutUrl;

                        // Check if user bounces back quickly (shortcut not installed)
                        setTimeout(() => {
                            if (document.hasFocus() && (Date.now() - startTime) < 2000) {
                                document.getElementById('shareMenu').classList.add('show');
                                document.getElementById('shortcutSetupInfo').style.display = 'block';
                            }
                        }, 500);
                    }
                } else {
                    // Final fallback: Download the image
                    const userConfirm = confirm(
                        'Sharing not available in this browser.\n\n' +
                        'Would you like to download the image instead?\n' +
                        'You can then share it manually via Messages.'
                    );

                    if (userConfirm) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const dateStr = new Date().toISOString().split('T')[0];
                        a.download = 'everfresh-price-list-' + dateStr + '.png';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }
                }

            } catch (error) {
                loading.classList.remove('show');
                console.error('iMessage share error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Share via WhatsApp (enhanced with Web Share API)
        async function shareViaWhatsAppEnhanced() {
            closeShareMenu();

            const loading = document.getElementById('loading');
            loading.classList.add('show');

            try {
                // Generate image blob
                const blob = await generateImageBlob();

                if (!blob) {
                    throw new Error('Failed to generate image');
                }

                // Generate message
                const message = generateShareMessage();

                // STRATEGY: On iOS use Web Share, on other platforms try clipboard first
                if (isIOS()) {
                    // iOS: Use Web Share API
                    if (navigator.share && navigator.canShare) {
                        const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });

                        if (navigator.canShare({ files: [file] })) {
                            loading.classList.remove('show');

                            try {
                                await navigator.share({
                                    title: 'Everfresh Price List',
                                    text: message,
                                    files: [file]
                                });
                                return; // Success - user picks WhatsApp from share sheet
                            } catch (shareError) {
                                if (shareError.name === 'AbortError') {
                                    return; // User cancelled
                                }
                            }
                        }
                    }
                }

                // NON-iOS: Try clipboard first (works on Chrome desktop/Android)
                if (!isIOS()) {
                    const clipboardResult = await copyImageToClipboard(blob);

                    if (clipboardResult.success) {
                        loading.classList.remove('show');

                        const userConfirm = confirm(
                            ' Image copied to clipboard!\n\n' +
                            'WhatsApp will open. In the chat:\n' +
                            '1. Long-press the message box\n' +
                            '2. Tap "Paste" (Ctrl+V on desktop)\n' +
                            '3. Send the image\n\n' +
                            'Tap OK to open WhatsApp.'
                        );

                        if (userConfirm) {
                            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                            window.open(whatsappUrl, '_blank');
                        }
                        return;
                    }
                }

                // Final fallback: Download and open WhatsApp link
                loading.classList.remove('show');

                const userConfirm = confirm(
                    'Image will be downloaded.\n\n' +
                    'After download:\n' +
                    '1. WhatsApp will open\n' +
                    '2. Attach the image from your Photos\n' +
                    '3. Send!\n\n' +
                    'Tap OK to continue.'
                );

                if (userConfirm) {
                    downloadBlob(blob);

                    // Open WhatsApp after download
                    setTimeout(() => {
                        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                        window.open(whatsappUrl, '_blank');
                    }, 500);
                }

            } catch (error) {
                loading.classList.remove('show');
                console.error('WhatsApp share error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Current filter state
        let currentDayFilter = 'all';

        // Get tomorrow's day (smart detection)
        function getTomorrowDay() {
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            let dayIndex = tomorrow.getDay();
            // Skip Sunday - if tomorrow is Sunday, show Monday
            if (dayIndex === 0) dayIndex = 1;
            return days[dayIndex];
        }

        // Get day display name
        function getDayDisplayName(day) {
            const names = { mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday', sat: 'Saturday' };
            return names[day] || day;
        }

        // Filter customers by day
        function getCustomersForDay(day) {
            if (day === 'all') return customerContacts;
            return customerContacts.filter(customer => {
                const customerDays = customer.days || [];
                // Empty days = every day
                if (customerDays.length === 0) return true;
                return customerDays.includes(day);
            });
        }

        // Show customer share menu
        function showCustomerShareMenu() {
            if (customerContacts.length === 0) {
                alert('No customers added yet! Please add customers in Settings first.');
                return;
            }

            collectData();

            // Check for empty prices
            let hasEmptyPrices = false;
            for (const categoryName in priceData) {
                const items = priceData[categoryName];
                for (let i = 0; i < items.length; i++) {
                    const price = (items[i][2] || '').toString().trim();
                    if (price === '') {
                        hasEmptyPrices = true;
                        break;
                    }
                }
                if (hasEmptyPrices) break;
            }

            if (hasEmptyPrices) {
                alert('Please fill in all prices or mark as "NA" before sharing.');
                return;
            }

            // Reset filter to 'all'
            currentDayFilter = 'all';

            // Update tomorrow button text
            const tomorrowDay = getTomorrowDay();
            const tomorrowCustomers = getCustomersForDay(tomorrowDay);
            document.getElementById('tomorrowBtnText').textContent =
                `Send to ${getDayDisplayName(tomorrowDay)}'s Customers (${tomorrowCustomers.length})`;

            // Reset day pills
            document.querySelectorAll('.day-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.dataset.day === 'all') pill.classList.add('active');
            });

            // Render customer list
            renderCustomerShareList('all');

            document.getElementById('customerShareMenu').classList.add('show');
            document.body.classList.add('modal-open');
        }

        // Filter by tomorrow (smart button)
        function filterByTomorrow() {
            const tomorrowDay = getTomorrowDay();
            filterCustomersByDay(tomorrowDay);
            // Trigger send to filtered
            sendToFilteredCustomers();
        }

        // Filter customers by day (manual selection)
        function filterCustomersByDay(day) {
            currentDayFilter = day;

            // Update active pill
            document.querySelectorAll('.day-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.dataset.day === day) pill.classList.add('active');
            });

            // Re-render customer list
            renderCustomerShareList(day);
        }

        // Render customer share list
        function renderCustomerShareList(day) {
            const customers = getCustomersForDay(day);
            const container = document.getElementById('customerShareList');
            const dayNames = { mon: 'Mon', tue: 'Tue', wed: 'Wed', thu: 'Thu', fri: 'Fri', sat: 'Sat' };

            // Update send button text
            const dayLabel = day === 'all' ? 'All' : getDayDisplayName(day);
            document.getElementById('sendFilteredText').textContent = `Send to ${dayLabel} (${customers.length})`;

            if (customers.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No customers for this day</p>';
                return;
            }

            let html = '';
            customers.forEach((customer) => {
                const originalIndex = customerContacts.indexOf(customer);
                const customerDays = customer.days || [];
                let daysHtml = '';
                if (customerDays.length === 0) {
                    daysHtml = '<span style="background: #f0fdf4; color: #16a34a; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Every Day</span>';
                } else {
                    daysHtml = customerDays.map(d => `<span style="background: #dcfce7; color: #15803d; padding: 2px 6px; border-radius: 4px; font-size: 10px;">${dayNames[d]}</span>`).join(' ');
                }

                html += `
                    <div style="background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 12px; padding: 12px 14px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; font-size: 15px; color: #15803d;">${customer.name}</div>
                                <div style="font-size: 13px; color: #16a34a;">${customer.phone}</div>
                                <div style="display: flex; gap: 4px; margin-top: 4px;">${daysHtml}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="sendToCustomerVia(${originalIndex}, 'imessage')" style="flex: 1; background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); color: white; padding: 10px; font-size: 13px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/>
                                </svg>
                                iMessage
                            </button>
                            <button onclick="sendToCustomerVia(${originalIndex}, 'whatsapp')" style="flex: 1; background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); color: white; padding: 10px; font-size: 13px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="white">
                                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                </svg>
                                WhatsApp
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Send to filtered customers
        function sendToFilteredCustomers() {
            const customers = getCustomersForDay(currentDayFilter);
            if (customers.length === 0) {
                alert('No customers to send to for this day.');
                return;
            }
            // Use the existing sendToAllCustomers logic but with filtered list
            sendToCustomersByDay(currentDayFilter);
        }

        // Close customer share menu
        function closeCustomerShareMenu() {
            document.getElementById('customerShareMenu').classList.remove('show');
            document.body.classList.remove('modal-open');
        }

        // Send to specific customer
        async function sendToCustomer(index) {
            const customer = customerContacts[index];
            const phone = customer.phone.replace(/\D/g, ''); // Remove non-digits
            
            closeCustomerShareMenu();
            
            const loading = document.getElementById('loading');
            loading.classList.add('show');
            
            try {
                // Generate image blob
                const blob = await generateImageBlob();
                
                if (!blob) {
                    throw new Error('Failed to generate image');
                }
                
                // Create personalized message (respects toggle setting)
                const effectiveDate = getEffectiveDate();
                const formattedDate = effectiveDate.toLocaleDateString('en-AU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const yourName = salesmanInfo.name || 'Everfresh Team';
                const message = `Hi ${customer.name}! ${yourName} here from Everfresh  Fresh prices for ${formattedDate} - give me a call or text for your order! Thank you.`;
                
                // Check if Web Share API is available (iOS/modern browsers)
                if (navigator.share && navigator.canShare) {
                    const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });
                    
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: `Price List for ${customer.name}`,
                            text: message,
                            files: [file]
                        });
                        loading.classList.remove('show');
                        return;
                    }
                }
                
                // Fallback: Download and open WhatsApp
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const dateStr = new Date().toISOString().split('T')[0];
                a.download = 'everfresh-price-list-' + dateStr + '.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                loading.classList.remove('show');
                
                // Open WhatsApp with customer number
                const messageEncoded = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${phone}?text=${messageEncoded}`;
                
                alert('Image downloaded! WhatsApp will open - please attach the image from your Photos/Files and send.');
                setTimeout(() => {
                    window.open(whatsappUrl, '_blank');
                }, 500);
                
            } catch (error) {
                loading.classList.remove('show');
                if (error.name !== 'AbortError') {
                    console.error('Share error:', error);
                    alert('Error sharing: ' + error.message);
                }
            }
        }

        // Send to specific customer via chosen method (iMessage or WhatsApp)
        async function sendToCustomerVia(index, method) {
            const customer = customerContacts[index];
            const phone = customer.phone.replace(/\D/g, ''); // Remove non-digits

            closeCustomerShareMenu();

            const loading = document.getElementById('loading');
            loading.classList.add('show');

            try {
                // Generate image blob
                const blob = await generateImageBlob();

                if (!blob) {
                    throw new Error('Failed to generate image');
                }

                // Create personalized message
                const effectiveDate = getEffectiveDate();
                const formattedDate = effectiveDate.toLocaleDateString('en-AU', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const yourName = salesmanInfo.name || 'Everfresh Team';
                const message = `Hi ${customer.name}! ${yourName} here from Everfresh  Fresh prices for ${formattedDate} - give me a call or text for your order! Thank you.`;

                loading.classList.remove('show');

                // iOS with iMessage: Streamlined flow
                if (isIOS() && method === 'imessage') {

                    // Only save image if not already saved this session
                    if (!imageSavedThisSession) {
                        if (navigator.share && navigator.canShare) {
                            const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });

                            if (navigator.canShare({ files: [file] })) {
                                try {
                                    // Show share sheet - user taps "Save Image"
                                    await navigator.share({
                                        files: [file]
                                    });
                                    // Mark as saved for this session
                                    imageSavedThisSession = true;
                                } catch (shareError) {
                                    if (shareError.name === 'AbortError') {
                                        return;
                                    }
                                }
                            }
                        }
                    }

                    // Trigger shortcut immediately (no confirmation)
                    const shortcutInput = `${phone},${message}`;
                    const shortcutUrl = `shortcuts://run-shortcut?name=Everfresh%20Pricelist&input=text&text=${encodeURIComponent(shortcutInput)}`;
                    window.location.href = shortcutUrl;
                    return;
                }

                // iOS with WhatsApp or non-iOS: Use Web Share
                if (navigator.share && navigator.canShare) {
                    const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });

                    if (navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                title: `Price List for ${customer.name}`,
                                text: message,
                                files: [file]
                            });
                            return; // Success - user picks app from share sheet
                        } catch (shareError) {
                            if (shareError.name === 'AbortError') {
                                return;
                            }
                        }
                    }
                }

                // Fallback for non-iOS iMessage (clipboard method)
                if (method === 'imessage' && !isIOS()) {
                    const clipboardResult = await copyImageToClipboard(blob);

                    if (clipboardResult.success) {
                        const userConfirm = confirm(
                            ` Image copied to clipboard!\n\n` +
                            `Sending to: ${customer.name}\n` +
                            `Phone: ${customer.phone}\n\n` +
                            `The shortcut will open and send via iMessage.\n\n` +
                            `Tap OK to continue.`
                        );

                        if (userConfirm) {
                            const shortcutInput = `${phone},${message}`;
                            const shortcutUrl = `shortcuts://run-shortcut?name=Everfresh%20Pricelist&input=text&text=${encodeURIComponent(shortcutInput)}`;
                            window.location.href = shortcutUrl;
                        }
                        return;
                    }
                }

                // Final fallback: Download
                if (method === 'whatsapp') {
                    // Download and open WhatsApp
                    const userConfirm = confirm(
                        `Sending to: ${customer.name}\n\n` +
                        `Image will download, then WhatsApp will open.\n` +
                        `Attach the image and send!\n\n` +
                        `Tap OK to continue.`
                    );

                    if (userConfirm) {
                        downloadBlob(blob);
                        setTimeout(() => {
                            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                            window.open(whatsappUrl, '_blank');
                        }, 500);
                    }
                }

            } catch (error) {
                loading.classList.remove('show');
                console.error('Share error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Send to ALL customers via iOS Shortcut (loop)
        async function sendToAllCustomers() {
            if (!isIOS()) {
                alert('This feature requires iOS with the Everfresh Pricelist shortcut installed.');
                return;
            }

            if (customerContacts.length === 0) {
                alert('No customers to send to. Add customers in Settings first.');
                return;
            }

            // Confirm with user
            const confirmSend = confirm(
                ` Send to All Customers\n\n` +
                `This will send the price list to ${customerContacts.length} customer(s):\n\n` +
                customerContacts.slice(0, 5).map(c => ` ${c.name}`).join('\n') +
                (customerContacts.length > 5 ? `\n...and ${customerContacts.length - 5} more` : '') +
                `\n\nYou'll need to:\n` +
                `1. Save the image to Photos (once)\n` +
                `2. Approve each send in the Shortcut\n\n` +
                `Continue?`
            );

            if (!confirmSend) return;

            const progressDiv = document.getElementById('sendAllProgress');
            const statusText = document.getElementById('sendAllStatus');
            const progressBar = document.getElementById('sendAllProgressBar');
            const sendAllBtn = document.getElementById('sendToAllBtn');

            // Show progress, hide button
            progressDiv.style.display = 'block';
            sendAllBtn.style.display = 'none';

            try {
                // Step 1: Generate image once
                statusText.textContent = 'Generating price list image...';
                progressBar.style.width = '10%';

                const blob = await generateImageBlob();
                if (!blob) {
                    throw new Error('Failed to generate image');
                }

                // Step 2: Save image to Photos via Share Sheet
                // Only save image if not already saved this session
                if (!imageSavedThisSession) {
                    statusText.textContent = 'Save image to Photos (once)...';
                    progressBar.style.width = '20%';

                    const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file] });
                            imageSavedThisSession = true;
                        } catch (shareError) {
                            if (shareError.name === 'AbortError') {
                                progressDiv.style.display = 'none';
                                sendAllBtn.style.display = 'flex';
                                return;
                            }
                        }
                    } else {
                        throw new Error('Share API not available');
                    }
                }

                // Build customer list for shortcut
                statusText.textContent = 'Preparing customer list...';
                progressBar.style.width = '50%';

                const effectiveDate = getEffectiveDate();
                const formattedDate = effectiveDate.toLocaleDateString('en-AU', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const yourName = salesmanInfo.name || 'Everfresh Team';

                // Build list of customers: phone|name|message
                const customerList = customerContacts.map(customer => {
                    const phone = customer.phone.replace(/\D/g, '');
                    const message = `Hi ${customer.name}! ${yourName} here from Everfresh  Fresh prices for ${formattedDate} - give me a call or text for your order! Thank you.`;
                    return `${phone}|${customer.name}|${message}`;
                }).join(';;;');

                // Trigger shortcut immediately
                statusText.textContent = 'Launching shortcut...';
                progressBar.style.width = '80%';

                // Trigger shortcut with BULK mode and customer list
                const shortcutInput = `BULK,${customerList}`;
                const shortcutUrl = `shortcuts://run-shortcut?name=Everfresh%20Pricelist&input=text&text=${encodeURIComponent(shortcutInput)}`;

                // Reset UI before launching shortcut
                progressDiv.style.display = 'none';
                sendAllBtn.style.display = 'flex';
                closeCustomerShareMenu();

                window.location.href = shortcutUrl;

            } catch (error) {
                console.error('Send all error:', error);
                alert('Error: ' + error.message);
                progressDiv.style.display = 'none';
                sendAllBtn.style.display = 'flex';
            }
        }

        // Send to customers by day filter
        async function sendToCustomersByDay(day) {
            if (!isIOS()) {
                alert('This feature requires iOS with the Everfresh Pricelist shortcut installed.');
                return;
            }

            const customers = getCustomersForDay(day);
            if (customers.length === 0) {
                alert('No customers to send to for this day.');
                return;
            }

            const dayLabel = day === 'all' ? 'All' : getDayDisplayName(day);

            // Confirm with user
            const confirmSend = confirm(
                ` Send to ${dayLabel} Customers\n\n` +
                `This will send the price list to ${customers.length} customer(s):\n\n` +
                customers.slice(0, 5).map(c => ` ${c.name}`).join('\n') +
                (customers.length > 5 ? `\n...and ${customers.length - 5} more` : '') +
                `\n\nYou'll need to:\n` +
                `1. Save the image to Photos (once)\n` +
                `2. Approve each send in the Shortcut\n\n` +
                `Continue?`
            );

            if (!confirmSend) return;

            const progressDiv = document.getElementById('sendAllProgress');
            const statusText = document.getElementById('sendAllStatus');
            const progressBar = document.getElementById('sendAllProgressBar');
            const sendFilteredBtn = document.getElementById('sendFilteredBtn');

            // Show progress
            progressDiv.style.display = 'block';
            sendFilteredBtn.style.display = 'none';

            try {
                // Step 1: Generate image once
                statusText.textContent = 'Generating price list image...';
                progressBar.style.width = '10%';

                const blob = await generateImageBlob();
                if (!blob) {
                    throw new Error('Failed to generate image');
                }

                // Step 2: Save image to Photos via Share Sheet
                if (!imageSavedThisSession) {
                    statusText.textContent = 'Save image to Photos (once)...';
                    progressBar.style.width = '20%';

                    const file = new File([blob], 'everfresh-price-list.png', { type: 'image/png' });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({ files: [file] });
                            imageSavedThisSession = true;
                        } catch (shareError) {
                            if (shareError.name === 'AbortError') {
                                progressDiv.style.display = 'none';
                                sendFilteredBtn.style.display = 'flex';
                                return;
                            }
                        }
                    } else {
                        throw new Error('Share API not available');
                    }
                }

                // Build customer list for shortcut
                statusText.textContent = `Preparing ${dayLabel} customers...`;
                progressBar.style.width = '50%';

                const effectiveDate = getEffectiveDate();
                const formattedDate = effectiveDate.toLocaleDateString('en-AU', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const yourName = salesmanInfo.name || 'Everfresh Team';

                // Build list of filtered customers: phone~name~message (newline between customers)
                const customerList = customers.map(customer => {
                    const phone = customer.phone.replace(/\D/g, '');
                    const message = `Hi ${customer.name}! ${yourName} here from Everfresh. Fresh prices for ${formattedDate} - call or text for your order!`;
                    return `${phone}~${customer.name}~${message}`;
                }).join('\n');

                // Trigger shortcut
                statusText.textContent = 'Launching shortcut...';
                progressBar.style.width = '100%';

                // Reset UI
                progressDiv.style.display = 'none';
                sendFilteredBtn.style.display = 'flex';
                closeCustomerShareMenu();

                // Create simple phone list (just digits and commas - URL safe)
                const phoneList = customers.map(c => c.phone.replace(/\D/g, '')).join(',');

                // Launch shortcut with phone list in URL (using input parameter directly)
                window.location.href = `shortcuts://run-shortcut?name=Everfresh%20Pricelist&input=${phoneList}`;

            } catch (error) {
                console.error('Send by day error:', error);
                alert('Error: ' + error.message);
                progressDiv.style.display = 'none';
                sendFilteredBtn.style.display = 'flex';
            }
        }

        // Generate image blob (helper function)
        function generateImageBlob() {
            return new Promise((resolve, reject) => {
                const canvas = document.getElementById('downloadCanvas');
                const ctx = canvas.getContext('2d');
                
                try {
                    // Collect fresh data
                    collectData();
                    
                    // Calculate height
                    let totalRows = 0;
                    Object.values(priceData).forEach(items => {
                        const availableItems = items.filter(item => {
                            const price = (item[2] || '').toString().trim();
                            if (price === '') return false;
                            const cleanedPrice = price.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                            return cleanedPrice !== 'na' && cleanedPrice !== 'notavailable';
                        });
                        totalRows += availableItems.length;
                    });
                    const categoryCount = Object.keys(priceData).length;
                        
                        // Ultra HD - 3x resolution (3600px width)
                        canvas.width = 3600;
                        const estimatedHeight = 1200 + (categoryCount * 300) + (totalRows * 135) + 600;
                        canvas.height = estimatedHeight;
                        
                        console.log(`Canvas size: ${canvas.width}x${canvas.height} (Ultra HD 3x)`);

                        // White background
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        let y = 120;
                        const margin = 180;

                        // Header background - Barely green-white
                        ctx.fillStyle = '#fafdf7';
                        const headerHeight = (salesmanInfo.name || salesmanInfo.phone) ? 840 : 720;
                        ctx.fillRect(0, 0, canvas.width, headerHeight);

                        // Company name - Forest green
                        ctx.fillStyle = '#2d6a4f';
                        ctx.font = 'bold 168px Arial, Helvetica, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('EVERFRESH PRODUCE GROUP', canvas.width / 2, y + 150);
                        y += 240;

                        // Title - Fresh green
                        ctx.fillStyle = '#52b788';
                        ctx.font = 'bold 144px Arial, Helvetica, sans-serif';
                        ctx.fillText('WHOLESALE PRICE LIST', canvas.width / 2, y + 120);
                        y += 210;

                        // Address and Date
                        const leftCol = 300;
                        const rightCol = canvas.width - 300;
                        
                        ctx.textAlign = 'left';
                        ctx.fillStyle = '#2d6a4f';
                        ctx.font = 'bold 66px Arial, Helvetica, sans-serif';
                        ctx.fillText('Stand 275, Shed C, Sydney Markets', leftCol, y + 60);
                        
                        ctx.textAlign = 'right';
                        const effectiveDate = getEffectiveDate();
                        const formattedDate = effectiveDate.toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
                        ctx.fillText('Effective: ' + formattedDate, rightCol, y + 60);
                        y += 150;

                        // Contact box - Very light green
                        if (salesmanInfo.name || salesmanInfo.phone) {
                            ctx.fillStyle = '#d8f3dc';
                            ctx.fillRect(leftCol - 60, y - 30, canvas.width - 480, 150);
                            ctx.strokeStyle = '#52b788';
                            ctx.lineWidth = 6;
                            ctx.strokeRect(leftCol - 60, y - 30, canvas.width - 480, 150);
                            
                            ctx.textAlign = 'left';
                            ctx.fillStyle = '#1b4332';
                            ctx.font = 'bold 72px Arial, Helvetica, sans-serif';
                            
                            if (salesmanInfo.name && salesmanInfo.phone) {
                                ctx.fillText('Sales Contact: ' + salesmanInfo.name, leftCol, y + 60);
                                ctx.textAlign = 'right';
                                ctx.fillText(salesmanInfo.phone, rightCol, y + 60);
                            } else if (salesmanInfo.name) {
                                ctx.fillText('Sales Contact: ' + salesmanInfo.name, leftCol, y + 60);
                            } else {
                                ctx.fillText('Sales Contact: ' + salesmanInfo.phone, leftCol, y + 60);
                            }
                            y += 195;
                        } else {
                            y += 45;
                        }

                        // Separator - Fresh green
                        ctx.strokeStyle = '#b7e4c7';
                        ctx.lineWidth = 6;
                        ctx.beginPath();
                        ctx.moveTo(margin, y);
                        ctx.lineTo(canvas.width - margin, y);
                        ctx.stroke();
                        y += 90;

                        // Table setup
                        ctx.textAlign = 'left';
                        const tableWidth = canvas.width - 2 * margin;
                        const col1 = margin;
                        const col2 = margin + tableWidth * 0.45;
                        const col3 = margin + tableWidth * 0.80;
                        const rowHeight = 126;

                        console.log('Drawing categories...');
                        
                        // Get the appropriate price data (adjusted if customer selected)
                        const displayPriceData = selectedCustomer ? getAdjustedPriceData() : priceData;
                        
                        // Draw each category
                        for (const categoryName in displayPriceData) {
                            const items = displayPriceData[categoryName];
                            
                            // Filter out items with NA/Not Available price (case-insensitive, handles symbols)
                            const availableItems = items.filter(item => {
                                const price = (item[2] || '').toString().trim();
                                
                                // Empty prices already validated, so won't reach here
                                // But keep this check for safety
                                if (price === '') return false;
                                
                                // Remove all symbols and spaces, then check
                                const cleanedPrice = price.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
                                
                                // Filter out ONLY if it's "na" or "notavailable"
                                return cleanedPrice !== 'na' && cleanedPrice !== 'notavailable';
                            });
                            
                            // Skip this category if no available items
                            if (availableItems.length === 0) {
                                console.log(`Skipping category "${categoryName}" - all products NA`);
                                continue;
                            }

                            // Category header - Medium green
                            ctx.fillStyle = '#40916c';
                            ctx.fillRect(margin, y, tableWidth, 150);
                            ctx.strokeStyle = '#2d6a4f';
                            ctx.lineWidth = 6;
                            ctx.strokeRect(margin, y, tableWidth, 150);
                            ctx.fillStyle = '#ffffff';
                            ctx.font = 'bold 102px Arial, Helvetica, sans-serif';
                            ctx.fillText(categoryName, col1 + 60, y + 108);
                            y += 150;

                            // Column headers - Light green
                            ctx.fillStyle = '#74c69d';
                            ctx.fillRect(margin, y, tableWidth, rowHeight);
                            ctx.strokeRect(margin, y, tableWidth, rowHeight);
                            ctx.fillStyle = '#ffffff';
                            ctx.font = 'bold 78px Arial, Helvetica, sans-serif';
                            ctx.fillText('Product', col1 + 60, y + 84);
                            ctx.fillText('Grade/Size', col2 + 60, y + 84);
                            ctx.fillText('Price', col3 + 60, y + 84);
                            
                            // Vertical lines
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 6;
                            ctx.beginPath();
                            ctx.moveTo(col2, y);
                            ctx.lineTo(col2, y + rowHeight);
                            ctx.moveTo(col3, y);
                            ctx.lineTo(col3, y + rowHeight);
                            ctx.stroke();
                            y += rowHeight;

                            // Draw only available items
                            for (let i = 0; i < availableItems.length; i++) {
                                const item = availableItems[i];
                                
                                // Background - Very subtle alternating
                                ctx.fillStyle = i % 2 === 1 ? '#f1faee' : '#ffffff';
                                ctx.fillRect(margin, y, tableWidth, rowHeight);
                                
                                // Borders - Soft green-gray
                                ctx.strokeStyle = '#d8f3dc';
                                ctx.lineWidth = 3;
                                ctx.strokeRect(margin, y, tableWidth, rowHeight);
                                ctx.beginPath();
                                ctx.moveTo(col2, y);
                                ctx.lineTo(col2, y + rowHeight);
                                ctx.moveTo(col3, y);
                                ctx.lineTo(col3, y + rowHeight);
                                ctx.stroke();

                                // Calculate column widths for text truncation (with padding)
                                const productMaxWidth = col2 - col1 - 90;  // 60px left padding + 30px right padding
                                const gradeMaxWidth = col3 - col2 - 90;
                                const priceMaxWidth = (margin + tableWidth) - col3 - 90;

                                // Text - Dark for readability (with truncation to prevent overflow)
                                ctx.fillStyle = '#212529';
                                ctx.font = '72px Arial, Helvetica, sans-serif';
                                ctx.fillText(truncateText(ctx, item[0], productMaxWidth), col1 + 60, y + 84);
                                ctx.fillText(truncateText(ctx, item[1], gradeMaxWidth), col2 + 60, y + 84);

                                // Price - Deep forest green (with truncation)
                                ctx.fillStyle = '#1b4332';
                                ctx.font = 'bold 78px Arial, Helvetica, sans-serif';
                                ctx.fillText(truncateText(ctx, formatPriceWithSymbol(item[2]), priceMaxWidth), col3 + 60, y + 84);
                                
                                y += rowHeight;
                            }
                            y += 75;
                        }

                        // Notes
                        y += 45;
                        ctx.fillStyle = '#2d6a4f';
                        ctx.font = 'bold 96px Arial, Helvetica, sans-serif';
                        ctx.fillText('NOTES:', margin, y + 90);
                        y += 150;

                        ctx.fillStyle = '#495057';
                        ctx.font = '60px Arial, Helvetica, sans-serif';
                        const notes = [
                            ' All prices are wholesale rates',
                            ' Prices subject to availability and market conditions',
                            ' Quality guaranteed - fresh daily from Sydney Markets',
                            ' Contact us for bulk pricing and special requests'
                        ];
                        notes.forEach(note => {
                            ctx.fillText(note, margin + 60, y + 66);
                            y += 96;
                        });

                        // Convert to blob
                        canvas.toBlob(function(blob) {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Failed to create blob'));
                            }
                        }, 'image/png');
                        
                    } catch (error) {
                        console.error('Error generating blob:', error);
                        reject(error);
                    }
            });
        }

        // ========================================
        // CLOUD SYNC FUNCTIONS
        // ========================================

        let confirmationResult = null;
        let recaptchaVerifier = null;

        // Reset reCAPTCHA completely
        function resetRecaptcha() {
            if (recaptchaVerifier) {
                try {
                    recaptchaVerifier.clear();
                } catch (e) {
                    console.log('Could not clear reCAPTCHA:', e);
                }
                recaptchaVerifier = null;
            }
            // Clear the container HTML
            const container = document.getElementById('recaptcha-container');
            if (container) container.innerHTML = '';
        }

        // Initialize reCAPTCHA (invisible)
        function initRecaptcha() {
            return new Promise((resolve, reject) => {
                // Always reset first
                resetRecaptcha();

                try {
                    recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        size: 'invisible',
                        callback: () => {
                            console.log('reCAPTCHA solved');
                            resolve();
                        },
                        'expired-callback': () => {
                            console.log('reCAPTCHA expired');
                            resetRecaptcha();
                        }
                    });
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Start phone verification
        async function startPhoneVerification() {
            const phone = document.getElementById('salesmanPhone').value.trim();

            if (!phone) {
                showToast('Please enter your phone number first');
                return;
            }

            const formattedPhone = formatPhoneForFirebase(phone);
            document.getElementById('verifyingPhone').textContent = formattedPhone;

            try {
                // Show OTP modal
                document.getElementById('otpModal').classList.add('show');
                document.body.classList.add('modal-open');

                // Initialize reCAPTCHA fresh
                await initRecaptcha();

                // Send OTP
                confirmationResult = await auth.signInWithPhoneNumber(formattedPhone, recaptchaVerifier);

            } catch (error) {
                console.error('Phone auth error:', error);
                showToast('Error: ' + error.message);
                cancelVerification();
                resetRecaptcha();
            }
        }

        // Verify OTP code
        async function verifyOTP() {
            const code = document.getElementById('otpCode').value.trim();

            if (!code || code.length !== 6) {
                showToast('Please enter the 6-digit code');
                return;
            }

            try {
                const result = await confirmationResult.confirm(code);
                const user = result.user;

                // Store the phone for sync
                currentUserPhone = normalizePhoneForStorage(user.phoneNumber);
                cloudSyncEnabled = true;

                // Save sync state locally
                localStorage.setItem('everfresh_sync_phone', currentUserPhone);
                localStorage.setItem('everfresh_sync_enabled', 'true');

                // Close OTP modal
                document.getElementById('otpModal').classList.remove('show');
                document.body.classList.remove('modal-open');
                document.getElementById('otpCode').value = '';

                // Update UI
                updateSyncUI();

                // Auto-download from cloud on first verify
                await syncFromCloud(true);

                // Start auto-sync
                startRealtimeSync();

            } catch (error) {
                console.error('OTP verification error:', error);
                showToast('Invalid code. Please try again.');
            }
        }

        // Cancel verification
        function cancelVerification() {
            document.getElementById('otpModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            document.getElementById('otpCode').value = '';
            confirmationResult = null;
        }

        // Update sync UI based on state
        function updateSyncUI() {
            const statusIcon = document.getElementById('syncStatusIcon');
            const statusText = document.getElementById('syncStatusText');
            const verifyBtn = document.getElementById('verifyPhoneBtn');

            if (cloudSyncEnabled && currentUserPhone) {
                statusIcon.textContent = '';
                statusText.textContent = 'Synced';
                if (verifyBtn) verifyBtn.style.display = 'none';
            } else {
                statusIcon.textContent = '';
                statusText.textContent = 'Offline';
                if (verifyBtn) verifyBtn.style.display = 'block';
            }
        }

        // Start real-time sync listener
        function startRealtimeSync() {
            if (!currentUserPhone) {
                console.log('[Sync] Cannot start listener: no phone number');
                return;
            }

            // Remove existing listener if any
            stopRealtimeSync();

            console.log('[Sync] Starting real-time listener for:', 'users/' + currentUserPhone);

            // Show that we're connecting
            const statusText = document.getElementById('syncStatusText');
            if (statusText) statusText.textContent = 'Listening...';

            const userRef = database.ref('users/' + currentUserPhone);

            // Add listener with error handling
            realtimeListener = userRef.on('value', (snapshot) => {
                const cloudData = snapshot.val();

                console.log('[Sync] Listener fired! Data exists:', !!cloudData);

                if (!cloudData) {
                    console.log('[Sync] Real-time: No cloud data yet');
                    const statusText = document.getElementById('syncStatusText');
                    if (statusText) statusText.textContent = 'Synced';
                    return;
                }

                console.log('[Sync] Cloud timestamp:', cloudData.lastUpdated, 'Local timestamp:', lastUploadTimestamp);

                // Ignore our own uploads (check if timestamp matches what we just uploaded)
                if (cloudData.lastUpdated === lastUploadTimestamp) {
                    console.log('[Sync] Real-time: Ignoring our own upload');
                    const statusText = document.getElementById('syncStatusText');
                    if (statusText) statusText.textContent = 'Synced';
                    return;
                }

                // This is data from another device - apply it!
                console.log('[Sync] Real-time: New data from another device!');

                // Update lastUploadTimestamp to this value so we don't re-apply on next trigger
                lastUploadTimestamp = cloudData.lastUpdated;

                // Apply cloud data
                if (cloudData.priceData) {
                    priceData = cloudData.priceData;
                }
                if (cloudData.categoryMargins) {
                    categoryMargins = cloudData.categoryMargins;
                }
                if (cloudData.customerContacts) {
                    customerContacts = cloudData.customerContacts;
                }
                if (cloudData.customers) {
                    customers = cloudData.customers;
                }
                if (cloudData.orders) {
                    orders = cloudData.orders;
                    localStorage.setItem('everfresh_orders', JSON.stringify(orders));
                }
                if (cloudData.selectedCustomerId) {
                    selectedCustomer = customers.find(c => c.id === cloudData.selectedCustomerId) || null;
                } else {
                    selectedCustomer = null;
                }
                if (cloudData.salesmanInfo) {
                    salesmanInfo = cloudData.salesmanInfo;
                    const nameInput = document.getElementById('salesmanName');
                    const phoneInput = document.getElementById('salesmanPhone');
                    const nextDayToggle = document.getElementById('nextDayToggle');
                    if (nameInput) nameInput.value = salesmanInfo.name || '';
                    if (phoneInput) phoneInput.value = salesmanInfo.phone || '';
                    if (nextDayToggle) nextDayToggle.checked = salesmanInfo.sendForNextDay !== false;
                }

                // Save locally (without triggering cloud sync)
                localStorage.setItem('everfresh_price_data', JSON.stringify(priceData));
                localStorage.setItem('everfresh_category_margins', JSON.stringify(categoryMargins));
                localStorage.setItem('everfresh_customers', JSON.stringify(customers));
                localStorage.setItem('everfresh_customer_contacts', JSON.stringify(customerContacts));
                if (selectedCustomer) {
                    localStorage.setItem('everfresh_selected_customer_id', selectedCustomer.id.toString());
                } else {
                    localStorage.removeItem('everfresh_selected_customer_id');
                }
                renderCustomerTiersList();

                // Refresh UI
                renderCategories();
                renderCustomersList();

                // Show sync received indicator
                const statusIcon = document.getElementById('syncStatusIcon');
                const statusTextEl = document.getElementById('syncStatusText');
                if (statusIcon) {
                    statusIcon.textContent = '';
                    setTimeout(() => { statusIcon.textContent = ''; }, 1000);
                }
                if (statusTextEl) {
                    statusTextEl.textContent = 'Updated!';
                    setTimeout(() => { statusTextEl.textContent = 'Synced'; }, 2000);
                }

            }, (error) => {
                // Error callback for listener
                console.error('[Sync] Listener error:', error);
                const statusIcon = document.getElementById('syncStatusIcon');
                const statusText = document.getElementById('syncStatusText');
                if (statusIcon) statusIcon.textContent = '!';
                if (statusText) statusText.textContent = 'Error: ' + error.code;
            });
        }

        // Stop real-time sync listener
        function stopRealtimeSync() {
            if (realtimeListener && currentUserPhone) {
                database.ref('users/' + currentUserPhone).off('value', realtimeListener);
                realtimeListener = null;
                console.log('[Sync] Real-time listener stopped');
            }
        }

        // Upload data to cloud (silent mode)
        async function syncToCloud(silent = false) {
            if (!currentUserPhone || syncInProgress) {
                console.log('[Sync] Upload skipped:', !currentUserPhone ? 'no phone' : 'in progress');
                return;
            }

            syncInProgress = true;
            console.log('[Sync] Uploading to:', 'users/' + currentUserPhone);

            // Update status to show syncing
            const statusIcon = document.getElementById('syncStatusIcon');
            if (statusIcon) statusIcon.textContent = '';

            try {
                collectData(); // Make sure we have latest data

                // Generate timestamp and store it so real-time listener ignores our own upload
                const timestamp = Date.now();
                lastUploadTimestamp = timestamp;

                const dataToSync = {
                    priceData: priceData,
                    categoryMargins: categoryMargins,
                    customerContacts: customerContacts,
                    customers: customers,
                    selectedCustomerId: selectedCustomer ? selectedCustomer.id : null,
                    salesmanInfo: salesmanInfo,
                    categoryOrder: Object.keys(priceData),
                    orders: orders,
                    lastUpdated: timestamp
                };

                await database.ref('users/' + currentUserPhone).set(dataToSync);
                console.log('[Sync] Upload success! Timestamp:', timestamp);

                // Update status back to synced
                if (statusIcon) statusIcon.textContent = '';

            } catch (error) {
                console.error('Sync to cloud error:', error);
                if (statusIcon) statusIcon.textContent = '!';
            } finally {
                syncInProgress = false;
            }
        }

        // Download data from cloud
        async function syncFromCloud(silent = false) {
            if (!currentUserPhone || syncInProgress) {
                console.log('[Sync] Download skipped:', !currentUserPhone ? 'no phone' : 'in progress');
                return;
            }

            syncInProgress = true;
            console.log('[Sync] Downloading from:', 'users/' + currentUserPhone);
            const statusIcon = document.getElementById('syncStatusIcon');
            if (statusIcon) statusIcon.textContent = '';

            try {
                const snapshot = await database.ref('users/' + currentUserPhone).once('value');
                const cloudData = snapshot.val();

                if (!cloudData) {
                    // No cloud data - this is fine for first sync, just start uploading
                    console.log('[Sync] No cloud data found, will upload instead');
                    if (statusIcon) statusIcon.textContent = '';
                    return;
                }

                console.log('[Sync] Cloud data found, applying...');

                // Apply cloud data
                if (cloudData.priceData) {
                    priceData = cloudData.priceData;
                }
                if (cloudData.categoryMargins) {
                    categoryMargins = cloudData.categoryMargins;
                }
                if (cloudData.customerContacts) {
                    customerContacts = cloudData.customerContacts;
                }
                if (cloudData.customers) {
                    customers = cloudData.customers;
                }
                if (cloudData.orders) {
                    orders = cloudData.orders;
                    localStorage.setItem('everfresh_orders', JSON.stringify(orders));
                }
                if (cloudData.selectedCustomerId) {
                    selectedCustomer = customers.find(c => c.id === cloudData.selectedCustomerId) || null;
                } else {
                    selectedCustomer = null;
                }
                if (cloudData.salesmanInfo) {
                    salesmanInfo = cloudData.salesmanInfo;
                    document.getElementById('salesmanName').value = salesmanInfo.name || '';
                    document.getElementById('salesmanPhone').value = salesmanInfo.phone || '';
                    document.getElementById('nextDayToggle').checked = salesmanInfo.sendForNextDay !== false;
                }

                // Save locally (but don't trigger another cloud sync!)
                localStorage.setItem('everfresh_price_data', JSON.stringify(priceData));
                localStorage.setItem('everfresh_category_margins', JSON.stringify(categoryMargins));
                localStorage.setItem('everfresh_customers', JSON.stringify(customers));
                localStorage.setItem('everfresh_customer_contacts', JSON.stringify(customerContacts));
                if (selectedCustomer) {
                    localStorage.setItem('everfresh_selected_customer_id', selectedCustomer.id.toString());
                } else {
                    localStorage.removeItem('everfresh_selected_customer_id');
                }
                renderCategories();
                renderCustomersList();
                renderCustomerTiersList();

                console.log('[Sync] Download success! Data applied.');
                if (statusIcon) statusIcon.textContent = '';

            } catch (error) {
                console.error('[Sync] Download error:', error);
                if (statusIcon) statusIcon.textContent = '!';
            } finally {
                syncInProgress = false;
            }
        }

        // Check for existing sync session on load
        function checkExistingSync() {
            const savedPhone = localStorage.getItem('everfresh_sync_phone');
            const syncEnabled = localStorage.getItem('everfresh_sync_enabled') === 'true';

            if (savedPhone && syncEnabled) {
                currentUserPhone = savedPhone;
                cloudSyncEnabled = true;

                // Auto-download and start sync on page load
                console.log('[Sync] Restoring sync session for:', savedPhone);
                syncFromCloud(true);
                startRealtimeSync();
            }

            updateSyncUI();
        }

        // Listen for Firebase auth state changes
        auth.onAuthStateChanged((user) => {
            console.log('[Auth] State changed:', user ? user.phoneNumber : 'signed out');
            if (user && user.phoneNumber) {
                const normalizedPhone = normalizePhoneForStorage(user.phoneNumber);
                if (!cloudSyncEnabled || currentUserPhone !== normalizedPhone) {
                    currentUserPhone = normalizedPhone;
                    cloudSyncEnabled = true;
                    localStorage.setItem('everfresh_sync_phone', normalizedPhone);
                    localStorage.setItem('everfresh_sync_enabled', 'true');
                    updateSyncUI();
                    syncFromCloud(true);
                    startRealtimeSync();
                }
            }
        });

        // Initialize
        loadFromLocal();
        loadOrdersFromLocal();
        renderCategories();
        updateTierNameSuggestions();
        setupGlobalEventDelegation();
        checkExistingSync();
    </script>
</body>
</html>